{{- $root := . -}}
{{- $repo := include "clickhouse.repository" $root -}}
{{- $busybox := include "busybox.image" $root -}}

apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentVersion
metadata:
  name: clickhouse
  labels:
      {{- include "clickhouse.labels" . | nindent 4 }}
spec:
  compatibilityRules:
    - compDefs:
        - clickhouse
      releases:
    {{- range $root.Values.clickhouseVersions }}
        - {{ .version }}
    {{- end }}
  releases:
  {{- range $root.Values.clickhouseVersions }}
    - name: {{ .version }}
      serviceVersion: {{ .version }}
      images:
        clickhouse: {{ $repo }}:{{ .imageTag }}
        copy-tools: {{ $busybox }}
  {{- end }}

---
apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentVersion
metadata:
  name: ch-keeper
  labels:
      {{- include "clickhouse.labels" . | nindent 4 }}
spec:
  compatibilityRules:
    - compDefs:
        - ch-keeper
      releases:
    {{- range $root.Values.clickhouseVersions }}
        - {{ .version }}
    {{- end }}
  releases:
  {{- range $root.Values.clickhouseVersions }}
    - name: {{ .version }}
      serviceVersion: {{ .version }}
      images:
        clickhouse: {{ $repo }}:{{ .imageTag }}
        copy-tools: {{ $busybox }}
  {{- end }}
