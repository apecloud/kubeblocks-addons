{{- $root := . -}}
{{- $releases := default (list) .Values.clickhouseVersions -}}
{{- $repo := include "clickhouse.repository" $root -}}
{{- $busybox := include "busybox.image" $root -}}

apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentVersion
metadata:
  name: clickhouse
  labels:
      {{- include "clickhouse.labels" . | nindent 4 }}
spec:
  compatibilityRules:
    - releases:
{{- range $releases }}
        - {{ .version }}
{{- end }}
      compDefs:
        - clickhouse-24
  releases:
{{- range $idx, $release := $releases }}
    - name: {{ $release.version }}
      serviceVersion: {{ $release.version }}
      images:
        clickhouse: {{ $repo }}:{{ $release.imageTag }}
        copy-tools: {{ $busybox }}
{{- end }}

---
apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentVersion
metadata:
  name: ch-keeper
  labels:
      {{- include "clickhouse.labels" . | nindent 4 }}
spec:
  compatibilityRules:
    - releases:
{{- range $releases }}
        - {{ .version }}
{{- end }}
      compDefs:
        - ch-keeper-24
  releases:
{{- range $release := $releases }}
    - name: {{ $release.version }}
      serviceVersion: {{ $release.version }}
      images:
        clickhouse: {{ $repo }}:{{ $release.imageTag }}
        copy-tools: {{ $busybox }}
{{- end }}
