apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: tikv-7
  labels:
    {{- include "tidb.labels" . | nindent 4 }}
spec:
  provider: kubeblocks
  description: a distributed transactional key-value database
  updateStrategy: BestEffortParallel
  serviceVersion: "7.1.5" # TODO: why?
  runtime:
    containers:
      - name: tikv
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 20160
            name: peer
          - containerPort: 20180
            name: status
        volumeMounts:
          - name: data
            mountPath: /var/lib/tikv
        command:
          - bin/sh
          - -c
          - |
            echo "start tikv..."
            DOMAIN=$KB_NAMESPACE".svc{{ .Values.clusterDomain }}"
            exec /tikv-server --pd=http://${KB_CLUSTER_NAME}-tidb-pd.${DOMAIN}:2379 \
            --data-dir=/var/lib/tikv \
            --addr=0.0.0.0:20160 \
            --advertise-addr=${KB_POD_FQDN}:20160 \
            --status-addr=0.0.0.0:20180
  volumes:
    - name: data
      needSnapshot: true
  lifecycleActions:
    memberLeave:
      customHandler:
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}/pd:{{ default .Chart.AppVersion .Values.image.tag }}
        exec:
          command:
            - bash
            - -c
            - |
              {{- .Files.Get "scripts/tikv_member_leave.sh" | nindent 14 }}
  builtinMonitorContainer:
    name: tikv
    metricsPort: "20180"
  services:
    - name: tikv
      spec:
        ports:
          - name: peer
            port: 20160
            targetPort: peer
          - name: status
            port: 20180
            targetPort: status

