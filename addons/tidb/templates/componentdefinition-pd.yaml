apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: tidb-pd-7
  labels:
    {{- include "tidb.labels" . | nindent 4 }}
spec:
  provider: kubeblocks
  description: tidb's metadata server
  updateStrategy: BestEffortParallel
  serviceVersion: "7.1.5" # TODO: why?
  # TODO: set roles?
  runtime:
    containers:
      - name: pd
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 2379
            name: client
          - containerPort: 2380
            name: peer
        volumeMounts:
          - name: data
            mountPath: /var/lib/pd
          - name: scripts
            mountPath: /scripts
        command: [ "/scripts/pd_start.sh" ]
  volumes:
    - name: data
      needSnapshot: true
  scripts:
    - name: tidb-scripts
      templateRef: {{ include "tidb.cmScriptsName" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555 # FIXME: kb bug? if this field is not set, permission is wrong
  builtinMonitorContainer:
    name: pd
    metricsPort: "2379"
  services:
    - name: pd
      spec:
        ports:
          - name: client
            port: 2379
            targetPort: client
          - name: peer
            port: 2380
            targetPort: peer