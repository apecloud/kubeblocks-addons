{{- range .Values.redisVersions }}
{{- $redisStartScripts := "redis-start.sh" }}
{{- if eq .major "5" }}
  {{- $redisStartScripts = "redis5-start.sh" }}
{{- end }}
---
apiVersion: apps.kubeblocks.io/v1
kind: ComponentDefinition
metadata:
  name: {{ printf "%s-%s" .componentDef $.Chart.Version }}
  labels:
    {{- include "redis.labels" $ | nindent 4 }}
  annotations:
    {{- include "redis.annotations" $ | nindent 4 }}
spec:
  provider: kubeblocks
  description: A Redis v{{ .major }}.0 component definition for Kubernetes
  serviceKind: redis
  serviceVersion: {{ .serviceVersion }}
  podManagementPolicy: OrderedReady
  podUpgradePolicy: ReCreate
  minReadySeconds: 10
  tls:
    volumeName: tls
    mountPath: {{ $.Values.tlsMountPath }}
    caFile: ca.crt
    certFile: tls.crt
    keyFile: tls.key
  services:
    - name: redis
      serviceName: redis
      spec:
        ports:
          - name: redis
            port: 6379
            targetPort: redis
      roleSelector: primary
    - name: redis-advertised
      serviceName: redis-advertised
      spec:
        ## the type can override in cluster componentSpec services, type can be NodePort, LoadBalancer(not support yet)
        type: NodePort
        ports:
          - name: redis-advertised
            port: 6379
            targetPort: redis
          - name: non-tls
            port: 6380
            targetPort: non-tls
      podService: true
      disableAutoProvision: true
    - name: redis-lb-advertised
      serviceName: redis-lb-advertised
      spec:
        ## the type can override in cluster componentSpec services, type can loadBalancer
        type: LoadBalancer
        # allocateLoadBalancerNodePorts: false
        externalTrafficPolicy: Cluster
        ports:
          - name: redis-advertised
            port: 6379
            targetPort: redis
          - name: non-tls
            port: 6380
            targetPort: non-tls
      podService: true
      disableAutoProvision: true
  updateStrategy: BestEffortParallel
  volumes:
    - name: data
      needSnapshot: true
  roles:
    - name: primary
      updatePriority: 2
      participatesInQuorum: false
    - name: secondary
      updatePriority: 1
      participatesInQuorum: false
  logConfigs:
    {{- range $name,$pattern := $.Values.logConfigs }}
    - name: {{ $name }}
      filePathPattern: {{ $pattern }}
    {{- end }}
  exporter:
    containerName: metrics
    scrapePath: /metrics
    scrapePort: http-metrics
  configs:
    - name: redis-replication-config
      template: {{ printf "redis%s-config-template-%s" .major $.Chart.Version }}
      namespace: {{ $.Release.Namespace }}
      volumeName: redis-config
      externalManaged: true
  scripts:
    - name: redis-scripts
      template: {{ include "redis.scriptsTemplate" $ }}
      namespace: {{ $.Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555
  {{- include "kblib.syncer.policyRules" $ | nindent 2 }}
  systemAccounts:
    - name: default
      initAccount: true
      passwordGenerationPolicy:
        length: 10
        numDigits: 5
        numSymbols: 0
        letterCase: MixedCases
  hostNetwork:
    containerPorts:
      - container: redis
        ports:
          - redis
          - non-tls
  {{- if $.Values.enableMetrics }}
      - container: metrics
        ports:
          - http-metrics
          - server-metrics
  {{- end }}
  vars:
  {{- if eq .major "5" }}
    - name: IS_REDIS5
      value: "true"
  {{- else if eq .major "8" }}
    - name: IS_REDIS8
      value: "true"
  {{- end }}
    ## the name of current cluster instance
    - name: CLUSTER_NAME
      valueFrom:
        clusterVarRef:
          clusterName: Required
    - name: CLUSTER_NAMESPACE
      valueFrom:
        clusterVarRef:
          namespace: Required
    ## the default username of redis connection
    - name: REDIS_DEFAULT_USER
      valueFrom:
        credentialVarRef:
          name: default
          username: Required
    ## the default password of redis connection
    - name: REDIS_DEFAULT_PASSWORD
      valueFrom:
        credentialVarRef:
          name: default
          password: Required
    ## the username of redis primary-secondary replication
    - name: REDIS_REPL_USER
      value: "kbreplicator"
    ## the password of redis primary-secondary replication shared the same password with default password
    - name: REDIS_REPL_PASSWORD
      valueFrom:
        credentialVarRef:
          name: default
          password: Required
    ## the username of redis for redis sentinel connection
    - name: REDIS_SENTINEL_USER
      value: "kbreplicator-sentinel"
    ## the password of redis for redis sentinel connection shared the same password with default password
    - name: REDIS_SENTINEL_PASSWORD
      valueFrom:
        credentialVarRef:
          name: default
          password: Required
    - name: COMPONENT_REPLICAS
      valueFrom:
        componentVarRef:
          optional: false
          replicas: Required
    ## the redis advertised service port list for each pod, the value format is "pod1Svc:nodeport1,pod2Svc:nodeport2,..."
    - name: REDIS_ADVERTISED_PORT
      valueFrom:
        serviceVarRef:
          name: redis-advertised
          optional: true
          port:
            name: redis-advertised
            option: Required
    - name: REDIS_NON_TLS_ADVERTISED_PORT
      valueFrom:
        serviceVarRef:
          name: redis-advertised
          optional: true
          port:
            name: non-tls
            option: Required
    - name: REDIS_LB_ADVERTISED_PORT
      valueFrom:
        serviceVarRef:
          name: redis-lb-advertised
          optional: true
          port:
            name: redis-advertised
            option: Required
    - name: REDIS_LB_NON_TLS_ADVERTISED_PORT
      valueFrom:
        serviceVarRef:
          name: redis-lb-advertised
          optional: true
          port:
            name: non-tls
            option: Required
    ## the redis advertised service name list for each pod, the value format is "pod1Svc,pod2Svc,..."
    - name: REDIS_LB_ADVERTISED_HOST
      valueFrom:
        serviceVarRef:
          name: redis-lb-advertised
          optional: true
          loadBalancer: Required
          host: Required
    ## the redis pod name list for each pod, the value format is "pod1,pod2,..."
    - name: REDIS_POD_NAME_LIST
      valueFrom:
        componentVarRef:
          optional: false
          podNames: Required
    ## the redis pod fqdn list for each pod, the value format is "pod1FQDN,pod2FQDN,..."
    - name: REDIS_POD_FQDN_LIST
      valueFrom:
        componentVarRef:
          optional: false
          podFQDNs: Required
    ## the component name of redis, it's the fullname of redis component
    - name: REDIS_COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          componentName: Required
    ## the redis server host network port when using host network mode, the port will be allocated automatically by KubeBlocks
    - name: REDIS_HOST_NETWORK_PORT
      valueFrom:
        hostNetworkVarRef:
          optional: true
          container:
            name: redis
            port:
              name: redis
              option: Required
    - name: REDIS_HOST_NETWORK_NON_TLS_PORT
      valueFrom:
        hostNetworkVarRef:
          optional: true
          container:
            name: redis
            port:
              name: non-tls
              option: Required
    - name: SERVICE_PORT
      value: "6379"
      expression: {{ `{{if index . "REDIS_HOST_NETWORK_PORT"}}{{.REDIS_HOST_NETWORK_PORT}}{{else}}{{.SERVICE_PORT}}{{end}}` | toYaml }}
    - name: NON_TLS_SERVICE_PORT
      value: "6380"
      expression: {{ `{{if index . "REDIS_HOST_NETWORK_NON_TLS_PORT"}}{{.REDIS_HOST_NETWORK_NON_TLS_PORT}}{{else}}{{.NON_TLS_SERVICE_PORT}}{{end}}` | toYaml }}
    - name: INNER_SERVICE_PORT
      value: "6379"
      expression: {{ `{{if .TLS_ENABLED}}{{.NON_TLS_SERVICE_PORT}}{{else}}{{.SERVICE_PORT}}{{end}}` | quote }}
  {{- if $.Values.enableMetrics }}
    ## the redis server metrics container host network port when using host network mode, the port will be allocated automatically by KubeBlocks, if not set, the default value is 9121
    - name: REDIS_METRICS_HOST_NETWORK_PORT
      valueFrom:
        hostNetworkVarRef:
          optional: true
          container:
            name: metrics
            port:
              name: http-metrics
              option: Required
    - name: REDIS_METRICS_HTTP_PORT
      value: "9121"
      expression: {{ `{{if index . "REDIS_METRICS_HOST_NETWORK_PORT"}}{{.REDIS_METRICS_HOST_NETWORK_PORT}}{{else}}{{.REDIS_METRICS_HTTP_PORT}}{{end}}` | toYaml }}
    ## the redis server metrics container host network server port when using host network mode, the port will be allocated automatically by KubeBlocks, if not set, the default value is 8888
    - name: REDIS_METRICS_HOST_NETWORK_SERVER_PORT
      valueFrom:
        hostNetworkVarRef:
          optional: true
          container:
            name: metrics
            port:
              name: server-metrics
              option: Required
    - name: REDIS_METRICS_SERVER_PORT
      value: "8888"
      expression: {{ `{{if index . "REDIS_METRICS_HOST_NETWORK_SERVER_PORT"}}{{.REDIS_METRICS_HOST_NETWORK_SERVER_PORT}}{{else}}{{.REDIS_METRICS_SERVER_PORT}}{{end}}` | toYaml }}
  {{- end }}
    ## the component name of redis sentinel when redis sentinel is enabled, it's the fullname of redis-sentinel component
    - name: SENTINEL_COMPONENT_NAME
      valueFrom:
        componentVarRef:
          compDef: {{ printf "%s-%s" .sentinelComponentDef $.Chart.Version }}
          optional: true
          componentName: Required
    ## the username of redis sentinel for redis connection, it is optional
    - name: SENTINEL_USER
      valueFrom:
        credentialVarRef:
          ## reference the redis-sentinel component definition name
          compDef: {{ printf "%s-%s" .sentinelComponentDef $.Chart.Version }}
          name: default
          optional: true
          username: Required
    - name: SENTINEL_HEADLESS_SERVICE_NAME
      valueFrom:
        serviceVarRef:
          compDef: {{ .sentinelComponentDef }}
          name: headless
          optional: true
          host: Optional
    ## the password of redis sentinel for redis connection, it is optional
    - name: SENTINEL_PASSWORD
      valueFrom:
        credentialVarRef:
          ## reference the redis-sentinel component definition name
          compDef: {{ printf "%s-%s" .sentinelComponentDef $.Chart.Version }}
          name: default
          optional: true
          password: Required
    - name: SENTINEL_POD_NAME_LIST
      valueFrom:
        componentVarRef:
          compDef: {{ printf "%s-%s" .sentinelComponentDef $.Chart.Version }}
          optional: true
          podNames: Required
    - name: SENTINEL_POD_FQDN_LIST
      valueFrom:
        componentVarRef:
          compDef: {{ printf "%s-%s" .sentinelComponentDef $.Chart.Version }}
          optional: true
          podFQDNs: Required
    ## the redis sentinel server port, if redis sentinel is in host network mode, the port will be allocated automatically by KubeBlocks, if not, the default port is 26379
    - name: SENTINEL_SERVICE_PORT
      valueFrom:
        hostNetworkVarRef:
          compDef: {{ printf "%s-%s" .sentinelComponentDef $.Chart.Version }}
          optional: true
          container:
            name: redis-sentinel
            port:
              name: redis-sentinel
              option: Required
      expression: {{ `{{if index . "SENTINEL_SERVICE_PORT"}}{{.SENTINEL_SERVICE_PORT}}{{else}}26379{{end}}` | toYaml }}
    - name: SENTINEL_NON_TLS_SERVICE_PORT
      valueFrom:
        hostNetworkVarRef:
          compDef: {{ printf "%s-%s" .sentinelComponentDef $.Chart.Version }}
          optional: true
          container:
            name: redis-sentinel
            port:
              name: non-tls
              option: Required
      expression: {{ `{{if index . "SENTINEL_NON_TLS_SERVICE_PORT"}}{{.SENTINEL_NON_TLS_SERVICE_PORT}}{{else}}26380{{end}}` | toYaml }}
    - name: SENTINEL_INNER_SERVICE_PORT
      value: "26379"
      expression: {{ `{{if .SENTINEL_TLS_ENABLED}}{{.SENTINEL_NON_TLS_SERVICE_PORT}}{{else}}{{.SENTINEL_SERVICE_PORT}}{{end}}` | quote }}
    - name: PHY_MEMORY
      valueFrom:
        resourceVarRef:
          memory: Required
    - name: TLS_ENABLED
      valueFrom:
        tlsVarRef:
          enabled: Optional
          optional: true
    - name: SENTINEL_TLS_ENABLED
      valueFrom:
        tlsVarRef:
          compDef: {{ printf "%s-%s" .sentinelComponentDef $.Chart.Version }}
          enabled: Optional
          optional: true
    - name: TLS_MOUNT_PATH
      value: {{ $.Values.tlsMountPath }}
  lifecycleActions:
    roleProbe:
      periodSeconds: 1
      timeoutSeconds: 1
      exec:
        env:
          - name: CURRENT_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: KB_HOST_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.hostIP
          - name: KB_POD_FQDN
            value: "$(CURRENT_POD_NAME).$(REDIS_COMPONENT_NAME)-headless.$(CLUSTER_NAMESPACE).svc.{{ $.Values.clusterDomain }}"
          - name: KB_CLUSTER_COMP_NAME
            value: $(REDIS_COMPONENT_NAME)
        container: redis
        command:
          - /tools/dbctl
          - redis
          - getrole
    postProvision:
      exec:
        container: redis
        command:
          - /bin/bash
          - -c
          - /scripts/redis-register-to-sentinel.sh > /tmp/post-provision.log 2>&1
        targetPodSelector: Role
        matchingKey: primary
        ## all lifecycle actions share the same env
        env:
          - name: CURRENT_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: CURRENT_POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          - name: CURRENT_POD_HOST_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.hostIP
      preCondition: RuntimeReady
    accountProvision:
      exec:
        container: redis
        command:
          - sh
          - -c
        args:
          - "redis-cli -a $REDIS_DEFAULT_PASSWORD $(KB_ACCOUNT_STATEMENT) && redis-cli -a $REDIS_DEFAULT_PASSWORD acl save "
    switchover:
      exec:
        container: redis
        command:
          - /bin/bash
          - -c
          - /scripts/redis-switchover.sh > /tmp/switchover.log 2>&1
    memberJoin:
      exec:
        container: redis
        command:
          - /bin/bash
          - -c
          - /scripts/sync-acl.sh
        targetPodSelector: Any
  runtime:
    initContainers:
      - name: init-dbctl
        command:
          - cp
          - -r
          - /bin/dbctl
          - /tools/
        imagePullPolicy: {{ default "IfNotPresent" $.Values.dbctlImage.pullPolicy }}
        volumeMounts:
          - mountPath: /tools
            name: tools
    containers:
      - name: redis
        imagePullPolicy: {{ default "IfNotPresent" $.Values.image.pullPolicy }}
        command: [ "/scripts/{{ $redisStartScripts }}" ]
        ports:
          # if tls enabled, this port is tls-port. otherwise, this port is redis-port.
          - name: redis
            containerPort: 6379
          # if tls enabled, this port is non-tls-port.
          - name: non-tls
            containerPort: 6380
        volumeMounts:
          - name: data
            mountPath: {{ $.Values.dataMountPath }}
          - name: redis-config
            mountPath: /etc/conf
          - name: scripts
            mountPath: /scripts
          - name: redis-conf
            mountPath: /etc/redis
          - mountPath: /tools
            name: tools
        env:
          - name: CURRENT_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: CURRENT_POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          - name: CURRENT_POD_HOST_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.hostIP
          - name: POD_FQDN
            value: "$(CURRENT_POD_NAME).$(REDIS_COMPONENT_NAME)-headless.$(CLUSTER_NAMESPACE).svc.{{ $.Values.clusterDomain }}"
        readinessProbe:
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 5
          exec:
            command:
              - sh
              - -c
              - /scripts/redis-ping.sh
        lifecycle:
          preStop:
            exec:
              command:
                - /bin/bash
                - -c
                - /scripts/redis-pre-stop.sh
  {{- if $.Values.enableMetrics }}
      - name: metrics
        imagePullPolicy: {{ $.Values.metrics.image.pullPolicy | quote }}
        securityContext:
          runAsNonRoot: true
          runAsUser: 1001
        env:
          - name: REDIS_ADDR
            value: "redis://localhost:$(INNER_SERVICE_PORT)"
          - name: REDIS_EXPORTER_WEB_LISTEN_ADDRESS
            value: "0.0.0.0:$(REDIS_METRICS_HTTP_PORT)"
          - name: REDIS_USER
            value: $(REDIS_DEFAULT_USER)
          - name: REDIS_PASSWORD
            value: $(REDIS_DEFAULT_PASSWORD)
          - name: REDIS_EXPORTER_IS_CLUSTER
            value: "false"
        ports:
          - name: http-metrics
            containerPort: {{ $.Values.metrics.service.port }}
          - name: server-metrics
            containerPort: {{ $.Values.metrics.service.serverPort }}
  {{- end }}
{{- end }}