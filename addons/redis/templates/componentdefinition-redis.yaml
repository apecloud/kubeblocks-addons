apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: {{ include "redis.componentDefName" . }}
  labels:
    {{- include "redis.labels" . | nindent 4 }}
spec:
  provider: kubeblocks
  description: A Redis v7.0 component definition for Kubernetes
  serviceKind: redis
  serviceVersion: 7.0.6
  services:
    - name: redis
      serviceName: redis
      spec:
        ports:
          - name: redis
            port: 6379
            targetPort: redis
      roleSelector: primary
  updateStrategy: BestEffortParallel
  volumes:
    - name: data
      needSnapshot: true
  roles:
    - name: primary
      serviceable: true
      writable: true
    - name: secondary
      serviceable: false
      writable: false
  logConfigs:
    {{- range $name,$pattern := .Values.logConfigs }}
    - name: {{ $name }}
      filePathPattern: {{ $pattern }}
    {{- end }}
  monitor:
    builtIn: false
    exporterConfig:
      scrapePort: {{ .Values.metrics.service.port }}
      scrapePath: "/metrics"
  configs:
    - name: redis-replication-config
      templateRef: redis7-config-template
      constraintRef: redis7-config-constraints
      namespace: {{ .Release.Namespace }}
      volumeName: redis-config
    - name: redis-metrics-config
      templateRef: redis-metrics-config
      namespace: {{ .Release.Namespace }}
      volumeName: redis-metrics-config
      defaultMode: 0444
  scripts:
    - name: redis-scripts
      templateRef: redis-scripts
      namespace: {{ .Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555
  systemAccounts:
    ## TODO: the other accounts should be created for backward compatibility
    - name: default
      initAccount: true
      passwordGenerationPolicy:
        length: 10
        numDigits: 5
        numSymbols: 0
        letterCase: MixedCases
  vars:
    - name: REDIS_DEFAULT_USER
      valueFrom:
        credentialVarRef:
          ## reference the current component definition name
          compDef: {{ include "redis.componentDefName" . }}
          name: default
          optional: false
          username: Required
    - name: REDIS_DEFAULT_PASSWORD
      valueFrom:
        credentialVarRef:
          ## reference the current component definition name
          compDef: {{ include "redis.componentDefName" . }}
          name: default
          optional: false
          password: Required
    ## the username of redis sentinel for redis connection
    - name: SENTINEL_USER
      valueFrom:
        credentialVarRef:
          ## reference the redis-sentinel component definition name
          compDef: {{ include "redis.sentinelComponentDefName" . }}
          name: default
          optional: false
          username: Required
    ## the password of redis sentinel for redis connection
    - name: SENTINEL_PASSWORD
      valueFrom:
        credentialVarRef:
          ## reference the redis-sentinel component definition name
          compDef: {{ include "redis.sentinelComponentDefName" . }}
          name: default
          optional: false
          password: Required
    - name: SENTINEL_COMPONENT_DEFINITION_NAME
      value: {{ include "redis.sentinelComponentDefName" . }}
    - name: SENTINEL_SERVICE_PORT
      valueFrom:
        serviceVarRef:
          compDef: {{ include "redis.sentinelComponentDefName" . }}
          name: redis-sentinel
          port:
            name: redis-sentinel

          optional: false
    ## TODO: add redis sentinel reference env vars
  lifecycleActions:
    roleProbe:
      builtinHandler: redis
      failureThreshold: 2
      periodSeconds: 1
      timeoutSeconds: 1
    postProvision:
      customHandler:
        image: {{ include "redis.image" . }}
        exec:
          command:
            - /bin/bash
            - -c
            - /scripts/redis-register-to-sentinel.sh
        ## TODO: the preCondition should be changed to RuntimeReady when KubeBlocks support it
        preCondition: ComponentReady
    accountProvision:
      customHandler:
        image: {{ include "redis.image" . }}
        exec:
          command:
            - sh
            - -c
          args:
            - "redis-cli -h $(KB_ACCOUNT_ENDPOINT) -a $REDIS_DEFAULT_PASSWORD $(KB_ACCOUNT_STATEMENT) && redis-cli -h $(KB_ACCOUNT_ENDPOINT) -a $REDIS_DEFAULT_PASSWORD acl save "
        env:
          - name: REDIS_DEFAULT_PASSWORD
            value: $(REDIS_DEFAULT_PASSWORD)
  runtime:
    containers:
      - name: redis
        image: {{ include "redis.image" . }}
        imagePullPolicy: {{ default .Values.image.pullPolicy "IfNotPresent" }}
        ports:
          - name: redis
            containerPort: 6379
        volumeMounts:
          - name: data
            mountPath: {{ .Values.dataMountPath }}
          - name: redis-config
            mountPath: /etc/conf
          - name: scripts
            mountPath: /scripts
          - name: redis-conf
            mountPath: /etc/redis
          - name: pod-info
            mountPath: /kb-podinfo
        env:
          ## TODO: redis sentinel deployment independent, refer to redis sentinel env vars
          - name: SERVICE_PORT
            value: "6379"
          ## the username of redis primary-secondary replication
          - name: REDIS_REPL_USER
            value: "kbreplicator"
          ## the password of redis primary-secondary replication
          - name: REDIS_REPL_PASSWORD
            value: $(REDIS_DEFAULT_USER)
          ## the default username of redis connection
          - name: REDIS_DEFAULT_USER
            value: $(REDIS_DEFAULT_USER)
          ## the default password of redis connection
          - name: REDIS_DEFAULT_PASSWORD
            value: $(REDIS_DEFAULT_PASSWORD)
          ## the username of redis for redis sentinel connection
          - name: REDIS_SENTINEL_USER
            value: "$(REDIS_REPL_USER)-sentinel"
          ## the password of redis for redis sentinel connection
          - name: REDIS_SENTINEL_PASSWORD
            value: $(REDIS_DEFAULT_PASSWORD)
          ## the username of redis sentinel for redis connection
          - name: SENTINEL_USER
            value: $(SENTINEL_USER)
          ## the password of redis sentinel for redis connection
          - name: SENTINEL_PASSWORD
            value: $(SENTINEL_PASSWORD)
          - name: SENTINEL_COMPONENT_DEFINITION_NAME
            value: $(SENTINEL_COMPONENT_DEFINITION_NAME)
        command: [ "/scripts/redis-start.sh" ]
        readinessProbe:
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 1
          successThreshold: 1
          failureThreshold: 5
          exec:
            command:
              - sh
              - -c
              - /scripts/redis-ping.sh 1
        lifecycle:
          preStop:
            exec:
              command:
                - /bin/bash
                - -c
                - /scripts/redis-preStop.sh
      - name: metrics
        image: {{ .Values.metrics.image.registry | default "docker.io" }}/{{ .Values.metrics.image.repository }}:{{ .Values.metrics.image.tag }}
        imagePullPolicy: {{ .Values.metrics.image.pullPolicy | quote }}
        securityContext:
          runAsNonRoot: true
          runAsUser: 1001
        env:
          - name: ENDPOINT
            value: {{ printf "localhost:6379" }}
          - name: REDIS_USER
            valueFrom:
              secretKeyRef:
                name: $(CONN_CREDENTIAL_SECRET_NAME)
                key: username
                optional: false
          - name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: $(CONN_CREDENTIAL_SECRET_NAME)
                key: password
                optional: false
        command:
          - "/bin/agamotto"
          - "--config=/opt/conf/metrics-config.yaml"
        ports:
          - name: http-metrics
            containerPort: {{ .Values.metrics.service.port }}
        volumeMounts:
          - name: redis-metrics-config
            mountPath: /opt/conf
    volumes:
      - name: pod-info
        downwardAPI:
          items:
            - path: "pod-role"
              fieldRef:
                fieldPath: metadata.labels['kubeblocks.io/role']
            - path: "primary-pod"
              fieldRef:
                fieldPath: metadata.annotations['rs.apps.kubeblocks.io/primary']
            - path: "component-replicas"
              fieldRef:
                fieldPath: metadata.annotations['apps.kubeblocks.io/component-replicas']