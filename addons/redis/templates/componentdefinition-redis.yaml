{{- range .Values.redisVersions }}
{{- $redisImage := printf "%s/%s:%s" ( $.Values.image.registry | default "docker.io" ) $.Values.image.repository .defaultImageTag }}
{{- $redisStartScripts := "redis-start.sh" }}
{{- if eq .major "5" }}
  {{- $redisStartScripts = "redis5-start.sh" }}
{{- end }}
{{- if or (eq .major "8") (eq .major "5") }}
  {{- $redisImage = printf "%s/%s:%s" ( $.Values.ceImage.registry | default ( $.Values.image.registry | default "docker.io" ) )  $.Values.ceImage.repository .defaultImageTag }}
{{- end }}
---
apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: {{ .componentDef }}
  labels:
    {{- include "redis.labels" $ | nindent 4 }}
  annotations:
    apps.kubeblocks.io/skip-immutable-check: "true"
spec:
  provider: kubeblocks
  description: A Redis v{{ .major }}.0 component definition for Kubernetes
  serviceKind: redis
  serviceVersion: {{ .serviceVersion }}
  minReadySeconds: 10
  services:
    - name: redis
      serviceName: redis
      spec:
        ports:
          - name: redis
            port: 6379
            targetPort: redis
      roleSelector: primary
    - name: redis-advertised
      serviceName: redis-advertised
      spec:
        ## the type can override in cluster componentSpec services, type can be NodePort, LoadBalancer
        type: NodePort
        ports:
          - name: redis-advertised
            port: 6379
            targetPort: redis
      podService: true
      disableAutoProvision: true
    - name: redis-lb-advertised
      serviceName: redis-lb-advertised
      spec:
        ## the type can override in cluster componentSpec services, type can loadBalancer
        type: LoadBalancer
        externalTrafficPolicy: Cluster
        # allocateLoadBalancerNodePorts: false
        ports:
          - name: redis-advertised
            port: 6379
            targetPort: redis
      podService: true
      disableAutoProvision: true
  updateStrategy: BestEffortParallel
  volumes:
    - name: data
      needSnapshot: true
  roles:
    - name: primary
      serviceable: true
      writable: true
    - name: secondary
      serviceable: false
      writable: false
  logConfigs:
    {{- range $name,$pattern := $.Values.logConfigs }}
    - name: {{ $name }}
      filePathPattern: {{ $pattern }}
    {{- end }}
  configs:
    - name: redis-replication-config
      templateRef: redis{{ .major }}-config-template
      constraintRef: redis{{ .major }}-config-constraints
      namespace: {{ $.Release.Namespace }}
      volumeName: redis-config
      reRenderResourceTypes:
        - vscale
  scripts:
    - name: redis-scripts
      templateRef: redis-scripts
      namespace: {{ $.Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555
  systemAccounts:
    ## TODO: the other accounts should be created for backward compatibility
    - name: default
      initAccount: true
      passwordGenerationPolicy:
        length: 10
        numDigits: 5
        numSymbols: 0
        letterCase: MixedCases
  hostNetwork:
    containerPorts:
      - container: redis
        ports:
          - redis
  vars:
{{- if eq .major "5" }}
    - name: IS_REDIS5
      value: "true"
{{- else if eq .major "8" }}
    - name: IS_REDIS8
      value: "true"
{{- end }}
    ## the default username of redis connection
    - name: REDIS_DEFAULT_USER
      valueFrom:
        credentialVarRef:
          name: default
          username: Required
    ## the default password of redis connection
    - name: REDIS_DEFAULT_PASSWORD
      valueFrom:
        credentialVarRef:
          name: default
          password: Required
    ## the redis advertised service port list for each pod, the value format is "pod1Svc:nodeport1,pod2Svc:nodeport2,..."
    - name: REDIS_ADVERTISED_PORT
      valueFrom:
        serviceVarRef:
          name: redis-advertised
          optional: true
          port:
            name: redis-advertised
            option: Required
    - name: REDIS_LB_ADVERTISED_PORT
      valueFrom:
        serviceVarRef:
          name: redis-lb-advertised
          optional: true
          port:
            name: redis-advertised
            option: Required
    ## the redis advertised service name list for each pod, the value format is "pod1Svc,pod2Svc,..."
    - name: REDIS_ADVERTISED_LB_HOST
      valueFrom:
        serviceVarRef:
          name: redis-lb-advertised
          optional: true
          loadBalancer: Required
          host: Required
    ## the redis server host network port when using host network mode, the port will be allocated automatically by KubeBlocks
    - name: REDIS_HOST_NETWORK_PORT
      valueFrom:
        hostNetworkVarRef:
          optional: true
          container:
            name: redis
            port:
              name: redis
              option: Required
      expression: {{ `{{if ne (index . "REDIS_HOST_NETWORK_PORT") ""}}{{.REDIS_HOST_NETWORK_PORT}}{{else}}6379{{end}}` | toYaml }}
    - name: SENTINEL_USER
      valueFrom:
        credentialVarRef:
          ## reference the redis-sentinel component definition name
          compDef: {{ .sentinelComponentDef }}
          name: default
          optional: true
          username: Optional
    ## the password of redis sentinel for redis connection, it is optional
    - name: SENTINEL_PASSWORD
      valueFrom:
        credentialVarRef:
          ## reference the redis-sentinel component definition name
          compDef: {{ .sentinelComponentDef }}
          name: default
          optional: true
          password: Optional
    - name: SENTINEL_COMPONENT_DEFINITION_NAME
      value: {{ .sentinelComponentDef }}
    - name: SENTINEL_COMPONENT_NAME
      valueFrom:
        componentVarRef:
          compDef: {{ .sentinelComponentDef }}
          optional: true
          componentName: Optional
    - name: SENTINEL_HEADLESS_SERVICE_NAME
      valueFrom:
        serviceVarRef:
          compDef: {{ .sentinelComponentDef }}
          name: headless
          optional: true
          host: Optional
    - name: SENTINEL_POD_NAME_LIST
      valueFrom:
        componentVarRef:
          compDef: {{ .sentinelComponentDef }}
          optional: true
          instanceNames: Optional
    ## the redis sentinel server port, if redis sentinel is in host network mode, the port will be allocated automatically by KubeBlocks, if not, the default port is 26379
    - name: SENTINEL_SERVICE_PORT
      valueFrom:
        hostNetworkVarRef:
          compDef: {{ .sentinelComponentDef }}
          optional: true
          container:
            name: redis-sentinel
            port:
              name: redis-sentinel
              option: Required
      expression: {{ `{{if ne (index . "SENTINEL_SERVICE_PORT") ""}}{{.SENTINEL_SERVICE_PORT}}{{else}}26379{{end}}` | toYaml }}
  lifecycleActions:
    roleProbe:
      builtinHandler: redis
      periodSeconds: 1
      timeoutSeconds: 1
    postProvision:
      customHandler:
        image: {{ $redisImage }}
        exec:
          command:
            - /bin/bash
            - -c
            - /scripts/redis-register-to-sentinel.sh
        preCondition: RuntimeReady
        targetPodSelector: Role
        matchingKey: primary
    accountProvision:
      customHandler:
        image: {{ $redisImage }}
        exec:
          command:
            - sh
            - -c
          args:
            - "redis-cli -h $(KB_ACCOUNT_ENDPOINT) -a $REDIS_DEFAULT_PASSWORD $(KB_ACCOUNT_STATEMENT) && redis-cli -h $(KB_ACCOUNT_ENDPOINT) -a $REDIS_DEFAULT_PASSWORD acl save "
    switchover:
      scriptSpecSelectors:
        - name: redis-scripts
      withCandidate:
        image: {{ $redisImage }}
        exec:
          command:
            - /bin/bash
            - -c
            - /scripts/redis-switchover.sh
      withoutCandidate:
        image: {{ $redisImage }}
        exec:
          command:
            - /bin/bash
            - -c
            - /scripts/redis-switchover.sh
  runtime:
    containers:
      - name: redis
        image: {{ $redisImage }}
        imagePullPolicy: {{ default "IfNotPresent" $.Values.image.pullPolicy }}
        ports:
          - name: redis
            containerPort: 6379
        volumeMounts:
          - name: data
            mountPath: {{ $.Values.dataMountPath }}
          - name: redis-config
            mountPath: /etc/conf
          - name: scripts
            mountPath: /scripts
          - name: redis-conf
            mountPath: /etc/redis
          ## deprecated since v0.8.3, do not use it
          - name: pod-info
            mountPath: /kb-podinfo
        env:
          - name: SERVICE_PORT
            value: "$(REDIS_HOST_NETWORK_PORT)"
          ## the username of redis primary-secondary replication
          - name: REDIS_REPL_USER
            value: "kbreplicator"
          ## the password of redis primary-secondary replication
          - name: REDIS_REPL_PASSWORD
            value: $(REDIS_DEFAULT_PASSWORD)
          ## the username of redis for redis sentinel connection
          - name: REDIS_SENTINEL_USER
            value: "$(REDIS_REPL_USER)-sentinel"
          ## the password of redis for redis sentinel connection
          - name: REDIS_SENTINEL_PASSWORD
            value: $(REDIS_DEFAULT_PASSWORD)
        command: [ "/scripts/{{ $redisStartScripts }}" ]
        readinessProbe:
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 1
          successThreshold: 1
          failureThreshold: 5
          exec:
            command:
              - sh
              - -c
              - /scripts/redis-ping.sh
        lifecycle:
          preStop:
            exec:
              command:
                - /bin/bash
                - -c
                - /scripts/redis-preStop.sh
    volumes:
      ## deprecated since v0.8.3, do not use it
      - name: pod-info
        downwardAPI:
          items:
            - path: "primary-pod"
              fieldRef:
                fieldPath: metadata.annotations['rs.apps.kubeblocks.io/primary']
            - path: "component-replicas"
              fieldRef:
                fieldPath: metadata.annotations['apps.kubeblocks.io/component-replicas']
{{- end }}