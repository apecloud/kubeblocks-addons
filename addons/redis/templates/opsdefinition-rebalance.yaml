apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsDefinition
metadata:
  name: redis-cluster-rebalance
spec:
  podInfoExtractors:
    - name: redisUrl
      podSelector:
        multiPodSelectionPolicy: Any
      env:
        - name: REDIS_DEFAULT_USER
          valueFrom:
            envRef:
              envName: REDIS_DEFAULT_USER
        - name: REDIS_DEFAULT_PASSWORD
          valueFrom:
            envRef:
              envName: REDIS_DEFAULT_PASSWORD
        - name: CLUSTER_DOMAIN
          valueFrom:
            envRef:
              envName: CLUSTER_DOMAIN
        - name: CURRENT_POD_NAME
          valueFrom:
            envRef:
              envName: CURRENT_POD_NAME
        - name: CURRENT_SHARD_COMPONENT_NAME
          valueFrom:
            envRef:
              envName: CURRENT_SHARD_COMPONENT_NAME
        - name: CLUSTER_NAMESPACE
          valueFrom:
            envRef:
              envName: CLUSTER_NAMESPACE
  actions:
    - name: rebalance
      workload:
        type: Job
        podInfoExtractorName: redisUrl
        podSpec:
          containers:
          - name: busybox-init
            image: {{ include "busybox.image" . }}
            command: ["/bin/sh", "-c"]
            args:
              - |
                POD_FQDN=$CURRENT_POD_NAME.$CURRENT_SHARD_COMPONENT_NAME-headless.$CLUSTER_NAMESPACE.svc.$CLUSTER_DOMAIN
                REDIS_URL="redis://${REDIS_DEFAULT_USER}:${REDIS_DEFAULT_PASSWORD}@${POD_FQDN}"
                echo ${REDIS_URL}
                cat <<EOF > /tmp/reshard.ini
                [extractor]
                db_type=redis
                extract_type=reshard
                url=${REDIS_URL}
                [sinker]
                sink_type=dummy
                EOF
            volumeMounts:
            - name: reshard-config
              mountPath: /tmp
          - name: redis-rebalance
            image: {{ include "apeDts.reshard.image" . }}
            imagePullPolicy: IfNotPresent
            command: ["/ape-dts"]
            args:
              - /tmp/reshard.ini
            volumeMounts:
            - name: reshard-config
              mountPath: /tmp
          restartPolicy: Never
          volumes:
          - name: reshard-config
            emptyDir: {}
