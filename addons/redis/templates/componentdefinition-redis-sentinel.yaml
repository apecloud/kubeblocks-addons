{{- range .Values.redisVersions }}
{{- $redisSentinelStartScripts := "redis-sentinel-start-v2.sh" }}
{{- if eq .major "5" }}
  {{- $redisSentinelStartScripts = "redis5-sentinel-start-v2.sh" }}
{{- end }}
{{- $redisSentinelImage := printf "%s/%s:%s" ( $.Values.image.registry | default "docker.io" ) $.Values.image.repository .defaultImageTag }}
{{- if or (eq .major "8") (eq .major "5") }}
  {{- $redisSentinelImage = printf "%s/%s:%s" ( $.Values.ceImage.registry | default ( $.Values.image.registry | default "docker.io" ) )  $.Values.ceImage.repository .defaultImageTag }}
{{- end }}
---
apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: {{ .sentinelComponentDef  }}
  labels:
    {{- include "redis.labels" $ | nindent 4 }}
  annotations:
    apps.kubeblocks.io/skip-immutable-check: "true"
spec:
  provider: kubeblocks
  description: A Redis Sentinel v{{ .major }}.0 component definition for Kubernetes
  serviceKind: redis-sentinel
  serviceVersion: {{ .serviceVersion }}
  services:
    - name: redis-sentinel
      serviceName: redis-sentinel
      spec:
        ports:
          - name: redis-sentinel
            port: 26379
            targetPort: redis-sentinel
    - name: sentinel-advertised
      serviceName: sentinel-advertised
      spec:
        type: NodePort
        ports:
          - name: sentinel-advertised
            port: 26379
            targetPort: redis-sentinel
      podService: true
      disableAutoProvision: true
    - name: sentinel-lb-advertised
      serviceName: sentinel-lb-advertised
      spec:
        type: LoadBalancer
        externalTrafficPolicy: Cluster
        # allocateLoadBalancerNodePorts: false
        ports:
          - name: sentinel-advertised
            port: 26379
            targetPort: redis-sentinel
      podService: true
      disableAutoProvision: true
  updateStrategy: BestEffortParallel
  volumes:
    - name: data
      needSnapshot: true
  logConfigs:
    {{- range $name,$pattern := $.Values.logConfigs }}
    - name: {{ $name }}
      filePathPattern: {{ $pattern }}
    {{- end }}
  configs:
    - name: redis-replication-config
      templateRef: redis{{ .major }}-config-template
      constraintRef: redis{{ .major }}-config-constraints
      namespace: {{ $.Release.Namespace }}
      volumeName: redis-config
  scripts:
    - name: redis-scripts
      templateRef: redis-scripts
      namespace: {{ $.Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555
  systemAccounts:
    ## TODO: the other accounts should be created for backward compatibility
    - name: default
      initAccount: true
      passwordGenerationPolicy:
        length: 10
        numDigits: 5
        numSymbols: 0
        letterCase: MixedCases
  hostNetwork:
    containerPorts:
      - container: redis-sentinel
        ports:
          - redis-sentinel
  vars:
    ## the username of redis sentinel
    - name: SENTINEL_USER
      valueFrom:
        credentialVarRef:
          name: default
          optional: false
          username: Required
    ## the password of redis sentinel
    - name: SENTINEL_PASSWORD
      valueFrom:
        credentialVarRef:
          name: default
          optional: false
          password: Required
    ## the redis sentinel advertised service port list for each pod, the value format is "pod1Svc:nodeport1,pod2Svc:nodeport2,..."
    - name: REDIS_SENTINEL_ADVERTISED_PORT
      valueFrom:
        serviceVarRef:
          name: sentinel-advertised
          optional: true
          port:
            name: sentinel-advertised
            option: Required
    - name: REDIS_SENTINEL_ADVERTISED_LB_HOST
      valueFrom:
        serviceVarRef:
          name: sentinel-lb-advertised
          optional: true
          loadBalancer: Required
          host: Required
    - name: REDIS_SENTINEL_LB_ADVERTISED_PORT
      valueFrom:
        serviceVarRef:
          name: sentinel-lb-advertised
          optional: true
          port:
            name: sentinel-advertised
            option: Required
    ## the redis sentinel server host network port when using host network mode, the port will be allocated automatically by KubeBlocks
    - name: REDIS_SENTINEL_HOST_NETWORK_PORT
      valueFrom:
        hostNetworkVarRef:
          optional: true
          container:
            name: redis-sentinel
            port:
              name: redis-sentinel
              option: Required
      expression: {{ `{{if ne (index . "REDIS_SENTINEL_HOST_NETWORK_PORT") ""}}{{.REDIS_SENTINEL_HOST_NETWORK_PORT}}{{else}}26379{{end}}` | toYaml }}
  lifecycleActions:
    accountProvision:
      customHandler:
        image: {{ $redisSentinelImage }}
        exec:
          command:
            - sh
            - -c
          args:
            - "redis-cli -h $(KB_ACCOUNT_ENDPOINT) -p $SENTINEL_SERVICE_PORT -a $SENTINEL_PASSWORD $(KB_ACCOUNT_STATEMENT) && redis-cli -h $(KB_ACCOUNT_ENDPOINT) -p $SENTINEL_SERVICE_PORT -a $SENTINEL_PASSWORD acl save "
  runtime:
    containers:
    - name: redis-sentinel
      image: {{ $redisSentinelImage }}
      imagePullPolicy: IfNotPresent
      ports:
        - containerPort: 26379
          name: redis-sentinel
      volumeMounts:
        - name: data
          mountPath: /data
        - name: scripts
          mountPath: /scripts
      env:
        - name: SENTINEL_SERVICE_PORT
          value: "$(REDIS_SENTINEL_HOST_NETWORK_PORT)"
      command:
        - /bin/bash
      args:
        - -c
        - |
          set -e
          /scripts/{{ $redisSentinelStartScripts }}
{{- if eq .major "6" }}
      lifecycle:
        postStart:
          exec:
            command: [ "/scripts/redis6-sentinel-post-start.sh" ]
{{- else if ge .major "7" }}
      lifecycle:
        postStart:
          exec:
            command: [ "/scripts/redis-sentinel-post-start.sh" ]
{{- end }}
      livenessProbe:
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 5
        exec:
          command:
            - sh
            - -c
            - /scripts/redis-sentinel-ping.sh
      readinessProbe:
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 1
        successThreshold: 1
        failureThreshold: 5
        exec:
          command:
            - sh
            - -c
            - /scripts/redis-sentinel-ping.sh
{{- end }}