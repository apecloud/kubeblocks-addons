apiVersion: apps.kubeblocks.io/v1alpha1
kind: OpsDefinition
metadata:
  name: redis-master-account-ops
spec:
  podInfoExtractors:
    - name: master-connection
      podSelector:
        multiPodSelectionPolicy: Any
      env:
        - name: KB_CLUSTER_NAME
          valueFrom:
            envRef:
              envName: KB_CLUSTER_NAME
        - name: KB_NAMESPACE
          valueFrom:
            envRef:
              envName: KB_NAMESPACE
        - name: KB_COMP_NAME
          valueFrom:
            envRef:
              envName: KB_COMP_NAME
        - name: KB_POD_LIST
          valueFrom:
            envRef:
              envName: KB_POD_LIST
        - name: REDIS_HOST_NETWORK_PORT
          valueFrom:
            envRef:
              envName: REDIS_HOST_NETWORK_PORT
        - name: REDIS_DEFAULT_USER
          valueFrom:
            envRef:
              envName: REDIS_DEFAULT_USER
        - name: REDIS_DEFAULT_PASSWORD
          valueFrom:
            envRef:
              envName: REDIS_DEFAULT_PASSWORD
  parametersSchema:
    openAPIV3Schema:
      properties:
        ACL_COMMAND:
          description: |
            ACL_COMMAND is the complete Redis command for account operations, such as:
            'ACL SETUSER alice-sen on ~* &* +@all #<hash-password>' or 'ACL DELUSER alice-sen',
            It is recommended to use hashed passwords (#<hash-password>) instead of plaintext passwords when setting user credentials
          type: string
        REPLICAS:
          description: |
            REPLICAS is the number of replicas of the Redis cluster.
          type: integer
  actions:
    - name: master-account-ops
      parameters: ["ACL_COMMAND","REPLICAS"] 
      workload:
        type: Pod
        podInfoExtractorName: master-connection 
        backoffLimit: 0
        podSpec:
          containers:
            - name: redis-account-ops
              image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag.major7.minor70 }}
              imagePullPolicy: IfNotPresent
              command:
                - bash
                - -c
                - |
                  {{- .Files.Get "scripts/redis-account.sh" | nindent 18 }}
---
apiVersion: apps.kubeblocks.io/v1alpha1
kind: OpsDefinition
metadata:
  name: redis-sentinel-account-ops
spec:
  podInfoExtractors:
    - name: sentinel-connection
      podSelector:
        multiPodSelectionPolicy: Any
      env:
        - name: KB_CLUSTER_NAME
          valueFrom:
            envRef:
              envName: KB_CLUSTER_NAME
        - name: KB_NAMESPACE
          valueFrom:
            envRef:
              envName: KB_NAMESPACE
        - name: KB_COMP_NAME
          valueFrom:
            envRef:
              envName: KB_COMP_NAME
        - name: KB_POD_LIST
          valueFrom:
            envRef:
              envName: KB_POD_LIST
        - name: REDIS_HOST_NETWORK_PORT
          valueFrom:
            envRef:
              envName: REDIS_SENTINEL_HOST_NETWORK_PORT
        - name: REDIS_DEFAULT_USER
          valueFrom:
            envRef:
              envName: SENTINEL_USER
        - name: REDIS_DEFAULT_PASSWORD
          valueFrom:
            envRef:
              envName: SENTINEL_PASSWORD
  parametersSchema:
    openAPIV3Schema:
      properties:
        ACL_COMMAND:
          description: |
            ACL_COMMAND is the complete Redis command for account operations, such as:
            'ACL SETUSER alice-sen on ~* &* +@all #<hash-password>' or 'ACL DELUSER alice-sen',
            It is recommended to use hashed passwords (#<hash-password>) instead of plaintext passwords when setting user credentials
          type: string
        REPLICAS:
          description: |
            REPLICAS is the number of replicas of the Redis cluster.
          type: integer
  actions:
    - name: sentinel-account-ops
      parameters: ["ACL_COMMAND","REPLICAS"] 
      workload:
        type: Pod
        podInfoExtractorName: sentinel-connection 
        backoffLimit: 0
        podSpec:
          containers:
            - name: redis-account-ops
              image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag.major7.minor70 }}
              imagePullPolicy: IfNotPresent
              command:
                - bash
                - -c
                - |
                  {{- .Files.Get "scripts/redis-account.sh" | nindent 18 }}
---
apiVersion: apps.kubeblocks.io/v1alpha1
kind: OpsDefinition
metadata:
  name: redis-shard-account-ops
spec:
  podInfoExtractors:
    - name: shard-connection
      podSelector:
        multiPodSelectionPolicy: Any
      env:
        - name: KB_CLUSTER_NAME
          valueFrom:
            envRef:
              envName: KB_CLUSTER_NAME
        - name: KB_NAMESPACE
          valueFrom:
            envRef:
              envName: KB_NAMESPACE
        - name: KB_COMP_NAME
          valueFrom:
            envRef:
              envName: KB_COMP_NAME
        - name: REDIS_HOST_NETWORK_PORT
          valueFrom:
            envRef:
              envName: REDIS_CLUSTER_HOST_NETWORK_PORT
        - name: REDIS_DEFAULT_USER
          valueFrom:
            envRef:
              envName: REDIS_DEFAULT_USER
        - name: REDIS_DEFAULT_PASSWORD
          valueFrom:
            envRef:
              envName: REDIS_DEFAULT_PASSWORD
        - name: KB_POD_NAME
          valueFrom:
            envRef:
              envName: KB_POD_NAME
  parametersSchema:
    openAPIV3Schema:
      properties:
        ACL_COMMAND:
          description: |
            ACL_COMMAND is the complete Redis command for account operations, such as:
            'ACL SETUSER alice-sen on ~* &* +@all #<hash-password>' or 'ACL DELUSER alice-sen',
            It is recommended to use hashed passwords (#<hash-password>) instead of plaintext passwords when setting user credentials
          type: string
        SHARD_MODE:
          description: |
            SHARD_MODE indicates the mode of Redis cluster. When the cluster type is cluster, it must be set to "TRUE".
          type: string
        REPLICAS:
          description: |
            REPLICAS is the number of replicas of the Redis cluster.
          type: integer
  actions:
    - name: shard-account-ops
      parameters: ["ACL_COMMAND","SHARD_MODE","REPLICAS"] 
      workload:
        type: Pod
        podInfoExtractorName: shard-connection 
        backoffLimit: 0
        podSpec:
          containers:
            - name: redis-account-ops
              image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag.major7.minor70 }}
              imagePullPolicy: IfNotPresent
              command:
                - bash
                - -c
                - |
                  {{- .Files.Get "scripts/redis-account.sh" | nindent 18 }}