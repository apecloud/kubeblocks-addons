{{- $redisCeRepo := include "redis.ceRepository" . -}}
{{- range .Values.redisVersions }}
{{- $version := .major }}
{{- $redisImage := printf "%s/%s:%s" ( $.Values.image.registry | default "docker.io" ) $.Values.image.repository .defaultImageTag }}
{{- $redisRepository := printf "%s/%s" ( $.Values.image.registry | default "docker.io" ) $.Values.image.repository }}
{{- if or (eq .major "8") (eq .major "5") }}
{{- $redisImage = printf "%s/%s:%s" ( $.Values.ceImage.registry | default ( $.Values.image.registry | default "docker.io" ) ) $redisCeRepo .defaultImageTag }}
{{- $redisRepository = printf "%s/%s" ( $.Values.ceImage.registry | default ( $.Values.image.registry | default "docker.io" ) ) $redisCeRepo }}
{{- end }}
{{- $pd := $.Files.Get "config/redis-config-effect-scope.yaml" | fromYaml }}
---
apiVersion: parameters.kubeblocks.io/v1alpha1
kind: ParametersDefinition
metadata:
  name: {{ printf "redis-cluster%s-pd" .major }}
  labels:
    {{- include "redis.labels" $ | nindent 4 }}
spec:
  reloadAction:
    shellTrigger:
      sync: true
      command:
        - "reload-parameter.sh"
      scriptConfig:
        scriptConfigMapRef: redis-reload-tools-script
        namespace: {{ $.Release.Namespace }}
      toolsSetup:
        mountPoint: /kb_tools
        toolConfigs:
          - name: kb-tools
            asContainerImage: true
            image: {{ $redisImage }}
            imageMappings:
            {{- range .mirrorVersions }}
            - serviceVersions:
                - {{ .version }}
              image: {{ $redisRepository }}:{{ .imageTag }}
            {{- end }}

  fileName: redis.conf
  # ConfigurationSchema that impose restrictions on engine parameter's rule
  parametersSchema:
    topLevelKey: RedisParameter
    cue: |-
      {{- $.Files.Get (printf "config/redis-cluster%s-config-constraint.cue" $version) | nindent 6 }}

  ## require db instance restart
  {{- if hasKey $pd "staticParameters" }}
  staticParameters:
    {{- $params := get $pd "staticParameters" }}
    {{- range $params }}
    - {{ . }}
    {{- end }}
  {{- end}}
{{- end}}
