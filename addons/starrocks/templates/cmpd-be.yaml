apiVersion: apps.kubeblocks.io/v1
kind: ComponentDefinition
metadata:
  name: {{ include "be.componentDefName" . }}
  labels:
    {{- include "starrocks.labels" . | nindent 4 }}
  annotations:
    apps.kubeblocks.io/skip-immutable-check: "true"
    {{- include "starrocks.apiVersion" . | nindent 4 }}
spec:
  provider: kubeblocks
  description: A StarRocks BE component definition for Kubernetes
  serviceKind: starrocks-be
  updateStrategy: BestEffortParallel
  logConfigs:
    {{- range $name,$pattern := .Values.be.logConfigs }}
    - name: {{ $name }}
      filePathPattern: {{ $pattern }}
    {{- end }}
  services:
  - name: be
    serviceName: be
    spec:
      ipFamilyPolicy: PreferDualStack
      ipFamilies:
        - IPv4
      ports:
      - name: be-http
        port: 8040
        targetPort: http-port
      - name: proxy-http
        port: 8080
        targetPort: proxy-port
  scripts:
  - name: scripts
    template: {{ include "starrocks.scriptsTemplate" . }}
    namespace: {{ .Release.Namespace }}
    volumeName: scripts
    defaultMode: 0555
  configs:
    - name: be-cm
      template: {{ include "be.configTemplate" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: be-cm
      externalManaged: true
  volumes:
  - name: data
    needSnapshot: true
  vars:
  - name: CURRENT_SHARD_COMPONENT_NAME
    valueFrom:
      componentVarRef:
        optional: false
        componentName: Required
  - name: FE_DISCOVERY_SVC_NAME
    valueFrom:
      serviceVarRef:
        compDef: {{ include "fe-shared-nothing.componentDefName" . }}
        name: fe
        host: Required
  - name: STARROCKS_USER
    valueFrom:
      credentialVarRef:
        compDef: {{ include "fe-shared-nothing.componentDefName" . }}
        name: root
        optional: false
        username: Required
  - name: STARROCKS_PASSWORD
    valueFrom:
      credentialVarRef:
        compDef: {{ include "fe-shared-nothing.componentDefName" . }}
        name: root
        optional: false
        password: Required
  - name: MYSQL_PWD
    valueFrom:
      credentialVarRef:
        compDef: {{ include "fe-shared-nothing.componentDefName" . }}
        name: root
        optional: false
        password: Required
  runtime:
    containers:
    - name: be
      imagePullPolicy: {{ default .Values.image.pullPolicy "IfNotPresent" }}
      command:
      - bash
      - -c
      - |
        /scripts/check-suspend.sh
        {{ if eq .Values.hostType "FQDN" -}}
        /opt/starrocks/be_entrypoint.sh ${FE_DISCOVERY_ADDR}
        {{- else -}}
        {{ include "POD_IP" . | nindent 8 }}
        /scripts/be_entrypoint.sh ${FE_DISCOVERY_ADDR}
        {{- end }}
      env:
      {{- include "commonEnvs" . | nindent 6}}
      - name: FE_DISCOVERY_ADDR
        value: $(FE_DISCOVERY_SVC_NAME).$(KB_NAMESPACE).svc.{{ .Values.clusterDomain }}
      - name: COMPONENT_NAME
        value: be
      - name: FE_QUERY_PORT
        value: "{{ .Values.fe.queryPort }}"
      - name: CONFIGMAP_MOUNT_PATH
        value: /etc/starrocks/be/conf
      - name: SERVICE_PORT
        value: "8040"
      lifecycle:
        preStop:
          exec:
            command:
            - /opt/starrocks/be_prestop.sh
      ports:
      - containerPort: 9060
        name: rpc-port
        protocol: TCP
      - containerPort: 8040
        name: http-port
        protocol: TCP
      - containerPort: 9050
        name: heartbeat-port
        protocol: TCP
      - containerPort: 8060
        name: brpc-port
        protocol: TCP
      - containerPort: 9070
        name: starlet-port
        protocol: TCP
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false
      livenessProbe:
        failureThreshold: 3
        {{- include "be.probe" . | nindent 8 }}
      readinessProbe:
        failureThreshold: 3
        {{- include "be.probe" . | nindent 8 }}
      startupProbe:
        failureThreshold: 90
        {{- include "be.probe" . | nindent 8 }}
      volumeMounts:
      - mountPath: /opt/starrocks/be/conf/be.conf
        name: be-cm
        subPath: be.conf
      - mountPath: /opt/starrocks/be/storage
        name: data
      - mountPath: /opt/starrocks/be/log
        name: log
      - mountPath: /scripts
        name: scripts
      - mountPath: /opt/starrocks/kb/suspend
        name: cn-cm
        subPath: suspend
    - name: nginx
      imagePullPolicy: {{ default .Values.image.pullPolicy "IfNotPresent" }}
      livenessProbe:
        failureThreshold: 3
        httpGet:
          path: /nginx/health
          port: 8080
          scheme: HTTP
        periodSeconds: 5
        successThreshold: 1
        timeoutSeconds: 1
      ports:
      - containerPort: 8080
        name: proxy-port
        protocol: TCP
      readinessProbe:
        failureThreshold: 3
        httpGet:
          path: /nginx/health
          port: 8080
          scheme: HTTP
        periodSeconds: 5
        successThreshold: 1
        timeoutSeconds: 1
      volumeMounts:
      - mountPath: /etc/nginx/nginx.conf
        name: be-cm
        subPath: nginx.conf
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false
        runAsGroup: 101
        runAsNonRoot: true
        runAsUser: 101
    volumes:
    - name: log
      emptyDir: {}
