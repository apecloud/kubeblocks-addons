apiVersion: apps.kubeblocks.io/v1
kind: ShardingDefinition
metadata:
  name: rocketmq-broker
  labels:
    {{- include "rocketmq.labels" . | nindent 4 }}
  annotations:
    {{- include "rocketmq.apiVersion" . | nindent 4 }}
spec:
  template:
    compDef: {{ include "rocketmq-broker.componentDefNamePrefix" . }}
  shardsLimit:
    minShards: 1
    maxShards: 128
  provisionStrategy: Parallel
  updateStrategy: Parallel
  lifecycleActions:
    shardRemove:
      timeoutSeconds: 60
      exec:
        container: rocketmq-broker
        targetPodSelector: Role
        matchingKey: master
        env:
          - name: MY_POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
        command:
          - bash
          - -c
          - |
            /scripts/remove-broker.sh