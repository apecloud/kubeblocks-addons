apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsDefinition
metadata:
  name: hive-server2-apply-account
spec:
  podInfoExtractors:
    - name: apply-account
      podSelector:
        multiPodSelectionPolicy: All
      volumeMounts:
        - name: accounts
          mountPath: /hive/accounts-mount
        - name: metadata
          mountPath: /hive
      env:
        - name: ADMIN_USER
          valueFrom:
            envRef:
              envName: ADMIN_USER
        - name: ADMIN_PASSWORD
          valueFrom:
            envRef:
              envName: ADMIN_PASSWORD
  actions:
    - name: apply-account
      workload:
        type: Pod
        podInfoExtractorName: apply-account
        backoffLimit: 0
        podSpec:
          containers:
            - name: redis-account-ops
              image: "{{ $.Values.hive.image.registry }}/{{ $.Values.hive.image.repository }}:{{ $.Values.hive.image.tag }}"
              imagePullPolicy: IfNotPresent
              command:
                - bash
                - -c
                - |
                  cp /hive/accounts-mount/accounts /hive/metadata/hive-server2-users.conf.tmp
                  password_md5=$(echo -n "$ADMIN_PASSWORD" | md5sum | awk '{print $1}')
                  if [ -z "$(cat /hive/metadata/hive-server2-users.conf)" ]; then
                    echo "${ADMIN_USER},${password_md5}" >> /hive/metadata/hive-server2-users.conf.tmp
                  else
                    echo -e "\n${ADMIN_USER},${password_md5}" >> /hive/metadata/hive-server2-users.conf.tmp
                  fi
                  mv /hive/metadata/hive-server2-users.conf.tmp /hive/metadata/hive-server2-users.conf