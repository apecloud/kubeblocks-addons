apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsDefinition
metadata:
  name: hive-server2-apply-account
spec:
  componentInfos:
    - componentDefinitionName: ^hive-server2.*$
      imageMappings:
        - serviceVersions:
            - 3.1.2
          images:
            apply-account: {{ .Values.images.registry | default "docker.io" }}/{{ .Values.images.hive.repository }}:3.1.2
        - serviceVersions:
          - 4.0.1
          images:
            apply-account: {{ .Values.images.registry | default "docker.io" }}/{{ .Values.images.hive.repository }}:4.0.1
  podInfoExtractors:
    - name: apply-account
      podSelector:
        multiPodSelectionPolicy: All
      volumeMounts:
        - name: accounts
          mountPath: /hive/accounts-mount
        - name: metadata
          mountPath: /hive
      env:
        - name: ADMIN_USER
          valueFrom:
            envRef:
              envName: ADMIN_USER
        - name: ADMIN_PASSWORD
          valueFrom:
            envRef:
              envName: ADMIN_PASSWORD
  actions:
    - name: apply-account
      workload:
        type: Pod
        podInfoExtractorName: apply-account
        backoffLimit: 0
        podSpec:
          containers:
            - name: apply-account
              image: "{{ $.Values.images.registry }}/{{ $.Values.images.hive.repository }}:{{ $.Values.images.hive.tag }}"
              imagePullPolicy: {{ default "IfNotPresent" .Values.images.pullPolicy }}
              command:
                - bash
                - -c
                - |
                  cp /hive/accounts-mount/accounts /hive/metadata/hive-server2-users.conf.tmp
                  password_md5=$(echo -n "$ADMIN_PASSWORD" | md5sum | awk '{print $1}')
                  if [ -z "$(cat /hive/metadata/hive-server2-users.conf)" ]; then
                    echo "${ADMIN_USER},${password_md5}" >> /hive/metadata/hive-server2-users.conf.tmp
                  else
                    echo -e "\n${ADMIN_USER},${password_md5}" >> /hive/metadata/hive-server2-users.conf.tmp
                  fi
                  mv /hive/metadata/hive-server2-users.conf.tmp /hive/metadata/hive-server2-users.conf