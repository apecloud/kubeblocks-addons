apiVersion: apps.kubeblocks.io/v1
kind: ComponentDefinition
metadata:
  name: {{ include "hive.metastoreCompDef" . }}
  labels:
    {{- include "hive.labels" . | nindent 4 }}
  annotations:
    {{- include "hive.annotations" . | nindent 4 }}
spec:
  provider: kubeblocks
  description: {{ .Chart.Description }}
  serviceKind: hive-metastore
  services:
    - name: default
      spec:
        ports:
          - name: metastore
            port: 9083
  serviceRefDeclarations:
    - name: hive-mysql-metadb
      optional: true
      serviceRefDeclarationSpecs:
        - serviceKind: mysql
          serviceVersion: "^*"
  runtime:
    initContainers:
      - name: hadoop-common
        imagePullPolicy: IfNotPresent
        command:
          - /bin/bash
        args:
          - -ec
          - |
            cp -r /opt/software/hadoop-3.3.4/* /opt/kubeemr/hadoop/hadoop-3.3.4
            mkdir -p /hive/metadata
            mkdir -p /hive/conf
            mkdir -p /home/hadoop
            chown -R 10000:1000 /home/hadoop
            chown -R 10000:1000 /hive/metadata
            chown -R 10000:1000 /hive/conf
            chown -R 10000:1000 /opt/kubeemr/hadoop/hadoop-3.3.4
        securityContext:
          runAsUser: 0
        volumeMounts:
          - name: hadoop-common
            mountPath: /opt/kubeemr/hadoop/hadoop-3.3.4
          - name: metadata
            mountPath: /hive/metadata
            subPath: metadata
          - name: home-volume
            mountPath: /home
    containers:
      - name: hive-metastore
        imagePullPolicy: {{ default "IfNotPresent" .Values.metastore.image.pullPolicy }}
        command:
          - /bin/bash
          - -c
          - |
            # sleep 100
            /kubeblocks/scripts/start-hive.sh
        ports:
          - containerPort: 9083
            name: metastore
        env:
          - name: DEBUG_MODEL
            value: "false"
          - name: CURRENT_POD
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
        volumeMounts:
          - name: hadoop-common
            mountPath: /opt/kubeemr/hadoop/hadoop-3.3.4
          - name: metadata
            mountPath: /hive/metadata
            subPath: metadata
          - name: hive-metastore-config
            mountPath: /hive/conf/hive-site.xml
            subPath: hive-site.xml
          - name: hadoop-core-config
            mountPath: /hadoop/conf/core-site.xml
            subPath: core-site.xml
          - name: hadoop-hdfs-config
            mountPath: /hadoop/conf/hdfs-site.xml
            subPath: hdfs-site.xml
          - name: hadoop-yarn-config
            mountPath: /hadoop/conf/yarn-site.xml
            subPath: yarn-site.xml
          - name: hadoop-yarn-config
            mountPath: /hadoop/conf/log4j.properties
            subPath: log4j.properties
          - name: hadoop-yarn-config
            mountPath: /hadoop/conf/mapred-site.xml
            subPath: mapred-site.xml
          - name: hive-metastore-scripts
            mountPath: /kubeblocks/scripts
        securityContext:
          runAsUser: 10000
          runAsGroup: 1000
          runAsNonRoot: true
          privileged: false
          allowPrivilegeEscalation: false
          capabilities:
            drop: [ "ALL" ]
          seccompProfile:
            type: "RuntimeDefault"
    securityContext:
      fsGroupChangePolicy: Always
      fsGroup: 1000
    updateStrategy: BestEffortParallel
    volumes:
      - name: hadoop-common
        emptyDir: {}
  vars:
    - name: CLUSTER_DOMAIN
      value: {{ .Values.clusterDomain | default "cluster.local" }}
    - name: CLUSTER_NAMESPACE
      valueFrom:
        clusterVarRef:
          namespace: Required
    - name: CLUSTER_NAME
      valueFrom:
        clusterVarRef:
          clusterName: Required
    - name: MYSQL_COMP_NAME
      valueFrom:
        componentVarRef:
          compDef: mysql
          optional: true
          componentName: Required
    - name: METADB_MYSQL_ENDPOINTS
      valueFrom:
        serviceRefVarRef:
          name: hive-mysql-metadb
          endpoint: Required
          optional: true
      expression: {{ `{{if ne (index . "METADB_MYSQL_ENDPOINTS") ""}}{{.METADB_MYSQL_ENDPOINTS}}{{else}}{{.MYSQL_COMP_NAME}}.{{.CLUSTER_NAMESPACE}}.svc.{{.CLUSTER_DOMAIN}}{{end}}` | toYaml }}
    - name: METADB_MYSQL_USERNAME
      valueFrom:
        serviceRefVarRef:
          name: hive-mysql-metadb
          username: Required
          optional: true
      expression: {{ `{{if ne (index . "METADB_MYSQL_USERNAME") ""}}{{.METADB_MYSQL_USERNAME}}{{else}}kbadmin{{end}}` | toYaml }}
    - name: COMPONENT_MYSQL_PASSWORD
      valueFrom:
        credentialVarRef:
          name: kbadmin
          compDef: mysql
          password: Required
          optional: true
    - name: METADB_MYSQL_PASSWORD
      valueFrom:
        serviceRefVarRef:
          name: hive-mysql-metadb
          password: Required
          optional: true
  configs:
    - name: config
      namespace: {{ .Release.Namespace }}
      template: hive-metastore-config-template
      volumeName: hive-metastore-config
      defaultMode: 0755
      # externalManaged: true
  scripts:
    - name: scripts
      namespace: {{ .Release.Namespace }}
      template: hive-metastore-scripts
      volumeName: hive-metastore-scripts
      defaultMode: 0755
