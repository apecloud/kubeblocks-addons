apiVersion: apps.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: hbase
  labels:
    {{- include "hbase.labels" . | nindent 4 }}
spec:
  type: hbase
  componentDefs:
    - name: hbase-master
      workloadType: Stateful
      characterType: hbase-master
      statefulSpec:
        updateStrategy: BestEffortParallel
      configSpecs:
        - name: hbase-config
          namespace: {{ .Release.Namespace }}
          templateRef: {{ include "hbase.name" . }}-config-template
          volumeName: hbase-config
          defaultMode: 0755
        - name: hdfs-config
          namespace: {{ .Release.Namespace }}
          templateRef: {{ .Values.hdfs.configMapRefName | default "hbase-config" }}
          volumeName: hdfs-config
          defaultMode: 0755
      service:
        ports:
          - name: master
            port: {{ .Values.ports.master.port }}
            targetPort: master
          - name: master-ui
            port: {{ .Values.ports.master.ui }}
            targetPort: master-ui
      podSpec:
        securityContext:
          fsGroup: 0
          runAsGroup: 0
          runAsNonRoot: true
          runAsUser: 10000
        containers:
          - name: hbase-master
            env:
              - name: DEBUG_MODEL
                value: "true"
            ports:
              - name: master
                containerPort: {{ .Values.ports.master.port }}
              - name: master-ui
                containerPort: {{ .Values.ports.master.ui }}
            livenessProbe:
              httpGet:
                path: /
                port: {{ .Values.ports.master.ui }}
              failureThreshold: 6
              initialDelaySeconds: 30
              periodSeconds: 10
              successThreshold: 1
              timeoutSeconds: 5
            readinessProbe:
              httpGet:
                path: /
                port: {{ .Values.ports.master.ui }}
              failureThreshold: 6
              initialDelaySeconds: 5
              periodSeconds: 10
              successThreshold: 1
              timeoutSeconds: 5
            resources:
              requests:
                cpu: 50m
                memory: 512Mi
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
              privileged: false
              runAsGroup: 0
              runAsNonRoot: true
              runAsUser: 10000
            volumeMounts:
              - name: hbase-config
                mountPath: /hbase/conf
              - name: hdfs-config
                mountPath: /hadoop/conf
    - name: hbase-region
      workloadType: Stateful
      characterType: hbase-region
      statefulSpec:
        updateStrategy: BestEffortParallel
      configSpecs:
        - name: hbase-config
          namespace: {{ .Release.Namespace }}
          templateRef: {{ include "hbase.name" . }}-config-template
          volumeName: hbase-config
          defaultMode: 0755
        - name: hdfs-config
          namespace: {{ .Release.Namespace }}
          templateRef: {{ .Values.hdfs.configMapRefName | default "hbase-config" }}
          volumeName: hdfs-config
          defaultMode: 0755
      service:
        ports:
          - name: region
            port: {{ .Values.ports.region.port }}
            targetPort: region
          - name: region-ui
            port: {{ .Values.ports.region.ui }}
            targetPort: region-ui
      podSpec:
        securityContext:
          fsGroup: 0
          runAsGroup: 0
          runAsNonRoot: true
          runAsUser: 10000
        containers:
          - name: hbase-region
            env:
              - name: DEBUG_MODEL
                value: "true"
            ports:
              - name: region
                containerPort: {{ .Values.ports.region.port }}
              - name: region-ui
                containerPort: {{ .Values.ports.region.ui }}
            livenessProbe:
              httpGet:
                path: /
                port: {{ .Values.ports.region.ui }}
              failureThreshold: 6
              initialDelaySeconds: 30
              periodSeconds: 10
              successThreshold: 1
              timeoutSeconds: 5
            readinessProbe:
              httpGet:
                path: /
                port: {{ .Values.ports.region.ui }}
              failureThreshold: 6
              initialDelaySeconds: 5
              periodSeconds: 10
              successThreshold: 1
              timeoutSeconds: 5
            resources:
              requests:
                cpu: 50m
                memory: 512Mi
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
              privileged: false
              runAsGroup: 0
              runAsNonRoot: true
              runAsUser: 10000
            volumeMounts:
              - name: hbase-config
                mountPath: /hbase/conf
              - name: hdfs-config
                mountPath: /hadoop/conf