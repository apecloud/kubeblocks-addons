apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: hbase-hmaster-2.5
  labels:
    {{- include "hbase.labels" . | nindent 4 }}
spec:
  provider: kubeblocks
  description: HBase Master component
  serviceKind: hbase-hmaster
  serviceVersion: 2.5.6
  services:
    - name: default
      spec:
        ports:
          - name: hmaster
            port: 16000
  serviceRefDeclarations:
    - name: hbase-zookeeper
      serviceRefDeclarationSpecs:
        - serviceKind: zookeeper
          serviceVersion: "^*"
    - name: hadoop-namenode
      serviceRefDeclarationSpecs:
        - serviceKind: namenode
          serviceVersion: "^*"
  runtime:
    initContainers:
      - name: init-regionserver
        image: {{ .Values.init.image.registry | default "docker.io" }}/{{ .Values.init.image.repository }}:{{ .Values.init.image.tag | default "latest" }}
        imagePullPolicy: {{ default "IfNotPresent" .Values.init.image.pullPolicy }}
        command: [ "/hbase/scripts/hbase-config-setup.sh" ]
        securityContext:
          runAsUser: 10000
          runAsGroup: 1000
        volumeMounts:
          - name: hbase-orig-conf
            mountPath: /hbase/origconf/hbase-site.xml
            subPath: hbase-site.xml
          - name: hbase-orig-conf
            mountPath: /hbase/origconf/log4j.properties
            subPath: log4j.properties
          - name: hadoop-core-config
            mountPath: /hadoop/conf/core-site.xml
            subPath: core-site.xml
          - name: hadoop-hdfs-config
            mountPath: /hadoop/conf/hdfs-site.xml
            subPath: hdfs-site.xml
          - name: hbase-scripts
            mountPath: /hbase/scripts
          - name: hbase-conf
            mountPath: /hbase/conf
    containers:
      - name: hbase-hmaster
        imagePullPolicy: {{ default "IfNotPresent" .Values.hmaster.image.pullPolicy }}
        #command: ["sleep", "3600"]
        ports:
          - containerPort: 16000
            name: hmaster
        env:
          - name: DEBUG_MODEL
            value: "false"
          - name: CURRENT_POD
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
        volumeMounts:
          - name: hbase-orig-conf
            mountPath: /hbase/origconf/hbase-site.xml
            subPath: hbase-site.xml
          - name: hbase-orig-conf
            mountPath: /hbase/origconf/log4j.properties
            subPath: log4j.properties
          - name: hadoop-core-config
            mountPath: /hadoop/conf/core-site.xml
            subPath: core-site.xml
          - name: hadoop-hdfs-config
            mountPath: /hadoop/conf/hdfs-site.xml
            subPath: hdfs-site.xml
          - name: hbase-scripts
            mountPath: /hbase/scripts
          - name: hbase-conf
            mountPath: /hbase/conf
          - name: hbase-log
            mountPath: /hbase/logs/
        securityContext:
          runAsUser: 0
          runAsGroup: 0
          runAsNonRoot: false
          privileged: true
          allowPrivilegeEscalation: true
          capabilities:
            drop: [ "ALL" ]
          seccompProfile:
            type: "RuntimeDefault"
    securityContext:
      fsGroupChangePolicy: Always
      fsGroup: 1000
    volumes:
      - name: hbase-conf
        emptyDir: {}
  vars:
    - name: ZOOKEEPER_HOST
      valueFrom:
        serviceRefVarRef:
          name: hbase-zookeeper
          host: Required
          optional: true
    - name: HADOOP_NAMENODE_ENDPOINTS
      valueFrom:
        serviceRefVarRef:
          name: hadoop-namenode
          endpoint: Required
          optional: true
  configs:
    - name: config
      namespace: {{ .Release.Namespace }}
      templateRef: hbase-config-template
      volumeName: hbase-orig-conf
      defaultMode: 0755
  scripts:
    - name: hbase-scripts
      templateRef: hbase-scripts-template
      namespace: {{ .Release.Namespace }}
      volumeName: hbase-scripts
      defaultMode: 0755
