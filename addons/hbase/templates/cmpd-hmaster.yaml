apiVersion: apps.kubeblocks.io/v1
kind: ComponentDefinition
metadata:
  name: hbase-hmaster-{{ .Chart.Version }}
  labels:
    {{- include "hbase.labels" . | nindent 4 }}
  annotations:
    {{- include "hbase.annotations" . | nindent 4 }}
    apps.kubeblocks.io/skip-immutable-check: "true"
spec:
  provider: kubeblocks
  description: HBase Master component
  serviceKind: hbase-hmaster
  serviceVersion: 2.5.12
  minReadySeconds: 10
  podManagementPolicy: Parallel
  services:
    - name: default
      spec:
        ports:
          - name: hmaster
            port: 16000
          - name: webui
            port: 16010
  serviceRefDeclarations:
    - name: hbase-zookeeper
      serviceRefDeclarationSpecs:
        - serviceKind: zookeeper
          serviceVersion: "^*"
  runtime:
    containers:
      - name: hbase-hmaster
        imagePullPolicy: {{ default "IfNotPresent" .Values.images.pullPolicy }}
        command:
          - bash
          - -c
          - |
            /hbase/scripts/start-master.sh
        ports:
          - containerPort: 16000
            name: hmaster
        env:
          - name: DEBUG_MODEL
            value: "false"
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
        volumeMounts:
          - name: hbase-orig-conf
            mountPath: /hbase/origconf
          - name: hadoop-core-config
            mountPath: /hadoop/conf/core-site.xml
            subPath: core-site.xml
          - name: hadoop-hdfs-config
            mountPath: /hadoop/conf/hdfs-site.xml
            subPath: hdfs-site.xml
          - name: hadoop-hdfs-config
            mountPath: /hadoop/conf/log4j.properties
            subPath: log4j.properties
          - name: hbase-scripts
            mountPath: /hbase/scripts
          - name: hbase-log
            mountPath: /hbase/logs/
        securityContext:
          runAsUser: 0
          runAsGroup: 0
          runAsNonRoot: false
          privileged: true
          allowPrivilegeEscalation: true
          capabilities:
            drop: [ "ALL" ]
          seccompProfile:
            type: "RuntimeDefault"
    securityContext:
      fsGroupChangePolicy: Always
      fsGroup: 1000
  roles:
    - name: active
      updatePriority: 2
      participatesInQuorum: false
    - name: standby
      updatePriority: 1
      participatesInQuorum: false
  lifecycleActions:
    roleProbe:
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 5
      exec:
        container: hbase-hmaster
        command:
          - bash
          - -c
          - |
            /hbase/scripts/role-check.sh
  vars:
    - name: HADOOP_CLUSTER_NAME
      value: "ENV_HADOOP_CLUSTER_NAME"
    - name: ZOOKEEPER_ENDPOINTS
      valueFrom:
        serviceRefVarRef:
          name: hbase-zookeeper
          optional: true
          podFQDNs: Required
      expression: {{ `{{ $hosts := splitList "," .ZOOKEEPER_ENDPOINTS }}{{ range $idx, $host := $hosts }}{{ $host }}{{ if lt $idx (sub (len $hosts) 1) }},{{ end }}{{ end }}` | toYaml }}
    - name: HBASE_MASTER_POD_LIST
      valueFrom:
        componentVarRef:
          optional: true
          podNames: Optional
    - name: CLUSTER_COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          componentName: Required
    - name: CLUSTER_NAME
      valueFrom:
        clusterVarRef:
          clusterName: Required
    - name: CLUSTER_NAMESPACE
      valueFrom:
        clusterVarRef:
          namespace: Required
  configs:
    - name: config
      namespace: {{ .Release.Namespace }}
      template: hbase-config-template
      volumeName: hbase-orig-conf
      defaultMode: 0755
  scripts:
    - name: hbase-scripts
      template: hbase-scripts-template
      namespace: {{ .Release.Namespace }}
      volumeName: hbase-scripts
      defaultMode: 0755
