apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: {{ include "nebula-graphd.cmpdName" . }}
  labels:
    {{- include "nebula.labels" . | nindent 4 }}
  annotations:
    {{- include "nebula.annotations" . | nindent 4 }}
spec:
  provider: Community
  description: {{ .Chart.Description }}
  serviceKind: nebula
  serviceVersion: {{ .Chart.AppVersion }}
  podManagementPolicy: Parallel
  volumes:
    - name: logs
  services:
    - name: thrift
      spec:
        type: ClusterIP
        ports:
          - name: thrift
            port: 9669
            targetPort: thrift
            protocol: TCP
          - name: http
            port: 19669
            targetPort: http
            protocol: TCP
          - name: http2
            port: 19670
            targetPort: http2
            protocol: TCP
  configs:
    - name: nebula-graphd-config
      constraintRef: nebula-graphd-config-constraints
      templateRef: {{ include "nebula-graphd.configTemplateName" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: nebula-graphd
  scripts:
    - name: nebula-scripts
      templateRef: {{ include "nebula.scriptsTemplateName" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555
  systemAccounts:
    - name: root
      initAccount: true
      passwordGenerationPolicy:
        length: 16
        numDigits: 8
        numSymbols: 3
        letterCase: MixedCases
  lifecycleActions:
    postProvision:
      customHandler:
        container: graphd
        image: {{ $.Values.images.nebula.console.registry | default ( $.Values.images.registry | default "docker.io" ) }}/{{ $.Values.images.nebula.console.repository }}:v3.8.0
        exec:
          command:
          - /bin/sh
          - -c
          - |
            set -e
            /usr/local/bin/nebula-console --addr ${SVC_NAME} --port ${SVC_PORT} --user root --password nebula -e "ALTER USER root WITH PASSWORD '${NEBULA_ROOT_PASSWORD}';"
  vars:
    - name: CLUSTER_DOMAIN
      value: {{ .Values.clusterDomain }}
    - name: HTTP_PORT
      value: "19669"
    - name: COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          componentName: Required
    - name: NEBULA_ROOT_USER
      valueFrom:
        credentialVarRef:
          name: root
          username: Required
    - name: NEBULA_ROOT_PASSWORD
      valueFrom:
        credentialVarRef:
          name: root
          password: Required
    - name: SVC_NAME
      valueFrom:
        serviceVarRef:
          name: thrift
          optional: false
          host: Required
    - name: SVC_PORT
      valueFrom:
        serviceVarRef:
          name: thrift
          optional: false
          port:
            name: thrift
            option: Required
    - name: NEBULA_METAD_SVC
      valueFrom:
        componentVarRef:
          compDef: nebula-metad
          optional: false
          podFQDNs: Required
      expression: {{ `{{ $hosts := splitList "," .NEBULA_METAD_SVC }}{{ range $idx, $host := $hosts }}{{ $host }}:9559{{ if lt $idx (sub (len $hosts) 1) }},{{ end }}{{ end }}` | toYaml }}
  runtime:
    volumes:
    - name: nebula-console
      emptyDir: {}
    securityContext:
      fsGroup: 1001
    initContainers:
      - name: init-console
        command:
          - /bin/sh
          - -c
          - |
            cp /usr/local/bin/nebula-console /usr/local/nebula/console/nebula-console
        imagePullPolicy: {{default .Values.images.pullPolicy "IfNotPresent"}}
        volumeMounts:
          - name: nebula-console
            mountPath: /usr/local/nebula/console
      - name: init-agent
        command:
          - /bin/sh
          - -c
          - |
            cp /usr/local/bin/agent /usr/local/nebula/console/agent
        imagePullPolicy: {{default .Values.images.pullPolicy "IfNotPresent"}}
        volumeMounts:
          - name: nebula-console
            mountPath: /usr/local/nebula/console
    containers:
      - name: graphd
        command:
          - /bin/bash
          - -c
          - |
            /scripts/start-graphd.sh
        imagePullPolicy: {{default .Values.images.pullPolicy "IfNotPresent"}}
        ports:
          - containerPort: 9669
            name: thrift
            protocol: TCP
          - containerPort: 19669
            name: http
            protocol: TCP
          - containerPort: 19670
            name: http2
            protocol: TCP
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: CLUSTER_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: POD_FQDN
            value: $(POD_NAME).$(COMPONENT_NAME)-headless.$(CLUSTER_NAMESPACE).svc.$(CLUSTER_DOMAIN)
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /status
            port: http
            scheme: HTTP
          initialDelaySeconds: 5
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 5
        volumeMounts:
          - mountPath: /usr/local/nebula/data
            name: data
          - mountPath: /usr/local/nebula/logs
            name: logs
          - mountPath: /usr/local/nebula/config
            name: nebula-graphd
          - name: scripts
            mountPath: /scripts
          - name: nebula-console
            mountPath: /usr/local/nebula/console
      {{- include "nebula.agentContainer" . | nindent 6 }}
