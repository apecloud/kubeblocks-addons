apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentVersion
metadata:
  name: nebula
  labels:
    {{- include "nebula.labels" . | nindent 4 }}
spec:
  compatibilityRules:
    - releases:
      {{- range $i, $version := .Values.nebula.versions }}
        - graphd-{{ $version }}
      {{- end }}
      compDefs:
        - {{ include "nebula-graphd.cmpdRegexpPattern" . }}
    - releases:
    {{- range $i, $version := .Values.nebula.versions }}
        - metad-{{ $version }}
    {{- end }}
      compDefs:
        - {{ include "nebula-metad.cmpdRegexpPattern" . }}
    - releases:
    {{- range $i, $version := .Values.nebula.versions }}
        - storaged-{{ $version }}
    {{- end }}
      compDefs:
        - {{ include "nebula-storaged.cmpdRegexpPattern" . }}
  releases:
{{- range $i, $version := .Values.nebula.versions }}
    - name: graphd-{{ $version }}
      serviceVersion: {{ $version }}
      images:
        graphd: {{ $.Values.images.nebula.graphd.registry | default ( $.Values.images.registry | default "docker.io" ) }}/{{ $.Values.images.nebula.graphd.repository }}:{{ $version }}
        logrotate: {{ $.Values.images.nebula.graphd.registry | default ( $.Values.images.registry | default "docker.io" ) }}/apecloud/alpine:3.16
        init-console: {{ $.Values.images.nebula.console.registry | default ( $.Values.images.registry | default "docker.io" ) }}/{{ $.Values.images.nebula.console.repository }}:{{ $version }}
    - name: metad-{{ $version }}
      serviceVersion: {{ $version }}
      images:
        metad: {{ $.Values.images.nebula.metad.registry | default ( $.Values.images.registry | default "docker.io" ) }}/{{ $.Values.images.nebula.metad.repository }}:{{ $version }}
        logrotate: {{ $.Values.images.nebula.graphd.registry | default ( $.Values.images.registry | default "docker.io" ) }}/apecloud/alpine:3.16
    - name: storaged-{{ $version }}
      serviceVersion: {{ $version }}
      images:
        init-console: {{ $.Values.images.nebula.console.registry | default ( $.Values.images.registry | default "docker.io" ) }}/{{ $.Values.images.nebula.console.repository }}:{{ $version }}
        storaged: {{ $.Values.images.nebula.storaged.registry | default ( $.Values.images.registry | default "docker.io" ) }}/{{ $.Values.images.nebula.storaged.repository }}:{{ $version }}
        logrotate: {{ $.Values.images.nebula.graphd.registry | default ( $.Values.images.registry | default "docker.io" ) }}/apecloud/alpine:3.16
{{- end }}