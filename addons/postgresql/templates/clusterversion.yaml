{{/*
Dynamically generate ClusterVersion resources for all PostgreSQL versions
*/}}
{{- range .Values.versions }}
{{- $majorVersion := .major }}
{{- $componentDef := .componentDef }}
{{- range .minors }}
{{- $cvName := printf "postgresql-%s" .version }}
{{- if eq (include "postgresql.isClusterVersionEnabled" (dict "cvName" $cvName "values" $.Values)) "true" }}
{{- $minor := .version }}
{{- $isDefault := .isDefault | default false }}
{{- $pgImage := include "postgresql.imageByVersion" (dict "major" $majorVersion "minor" $minor "root" $) }}
---
apiVersion: apps.kubeblocks.io/v1alpha1
kind: ClusterVersion
metadata:
  name: {{ $cvName }}
  annotations:
    kubeblocks.io/is-default-cluster-version: "{{ $isDefault }}"
  labels:
    {{- include "postgresql.labels" $ | nindent 4 }}
spec:
  clusterDefinitionRef: postgresql
  componentVersions:
    - componentDefRef: postgresql
      versionsContext:
        initContainers:
          - name: pg-init-container
            image: {{ $pgImage }}
        containers:
          - name: postgresql
            image: {{ $pgImage }}
          - name: pgbouncer
            image: {{ include "postgresql.pgbouncerImage" $ }}
      systemAccountSpec:
        cmdExecutorConfig:
          image: {{ $pgImage }}
      switchoverSpec:
        cmdExecutorConfig:
          image: {{ $pgImage }}
{{- end }}
{{- end }}
{{- end }}