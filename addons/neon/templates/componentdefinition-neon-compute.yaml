apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  labels:
    {{- include "neon.labels" . | nindent 4 }}
  name: {{ include "neon-compute.componentDefName" . }}
spec:
  description: A neon compute component definition for Kubernetes
  provider: KubeBlocks
  systemAccounts:
    - name: default
      initAccount: true
      passwordGenerationPolicy:
        length: 10
        numDigits: 5
        numSymbols: 0
        letterCase: MixedCases
  vars: 
    - name: NEON_COMPUTE_PGPORT
      valueFrom:
        serviceVarRef:
          compDef: {{ include "neon-compute.componentDefName" . }}
          name: neon-compute
          port:
            name: postgresql
    - name: NEON_COMPUTE_PGUSER
      valueFrom:
        credentialVarRef:
          compDef: {{ include "neon-compute.componentDefName" . }}
          name: default
          username: Required
    - name: NEON_COMPUTE_PGPASSWORD
      valueFrom:
        credentialVarRef:
          compDef: {{ include "neon-compute.componentDefName" . }}
          name: default
          password: Required
    - name: NEON_SAFEKEEPERS_HEADLESS
      valueFrom:
        serviceVarRef:
          compDef: {{ include "neon-safekeeper.componentDefName" . }}
          name: headless
          optional: true
          host: Optional
    - name: NEON_PAGESERVER_HEADLESS
      valueFrom:
        serviceVarRef:
          compDef: {{ include "neon-pageserver.componentDefName" . }}
          name: headless
          optional: true
          host: Optional
    - name: NEON_PAGESERVER_POD_LIST
      valueFrom:
        componentVarRef:
          compDef: {{ include "neon-pageserver.componentDefName" . }}
          optional: true
          instanceNames: Optional
    - name: NEON_SAFEKEEPERS_POD_LIST
      valueFrom:
        componentVarRef:
          compDef: {{ include "neon-safekeeper.componentDefName" . }}
          optional: true
          instanceNames: Optional
  runtime:
    containers:
      - name: postgresql
        env:
          - name: PGPORT
            value: $(NEON_COMPUTE_PGPORT)
          - name: PGDATA
            value: /data
          - name: PGUSER
            value: $(NEON_COMPUTE_PGUSER) 
          - name: PGPASSWORD
            value: $(NEON_COMPUTE_PGPASSWORD)
          - name: SAFEKEEPERS
            value: "neon-cluster-safekeeper-0.neon-cluster-safekeeper-headless.default.svc.cluster.local:5454,neon-cluster-safekeeper-1.neon-cluster-safekeeper-headless.default.svc.cluster.local:5454,neon-cluster-safekeeper-2.neon-cluster-safekeeper-headless.default.svc.cluster.local:5454"
          - name: PAGESERVER
            value: "neon-cluster-pageserver-0.neon-cluster-pageserver-headless.default.svc.cluster.local"
        image: {{ include "neon-compute.image" . }}
        ports:
        - containerPort: 55432
          name: postgresql
        command: [ "/scripts/compute.sh" ]
        volumeMounts:
        - mountPath: /data
          name: data
  serviceKind: postgresql
  serviceVersion: 1.0.0
  services:
  - name: neon-compute
    serviceName: neon-compute
    spec:
      ports:
      - name: postgresql
        port: 55432
        protocol: TCP
      type: ClusterIP