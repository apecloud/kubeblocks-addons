apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  labels:
    {{- include "neon.labels" . | nindent 4 }}
  name: {{ include "neon-pageserver.componentDefName" . }}
spec:
  description: A neon pageserver component definition for Kubernetes
  provider: KubeBlocks
  runtime:
    containers:
    - command:
      - /bin/bash
      - -c
      - 'set -ex

        trap : TERM INT

        exec pageserver -D /data -c "id=1" -c "broker_endpoint=''http://$NEON_BROKER_SVC:50051''"
        -c "listen_pg_addr=''0.0.0.0:6400''" -c "listen_http_addr=''0.0.0.0:9898''"
        -c "pg_distrib_dir=''/opt/neondatabase-neon/pg_install''"

        '
      image: {{ include "neon-pageserver.image" . }}
      name: neon-pageserver
      volumeMounts:
      - mountPath: /usr/local/neon/pageserver
        name: neon-pageserver
  serviceKind: pageserver
  serviceVersion: 1.0.0
  services:
  - name: neon-pageserver
    serviceName: neon-pageserver
    spec:
      ports:
      - name: pageserver
        port: 6400
        protocol: TCP
      type: ClusterIP
