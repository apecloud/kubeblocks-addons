apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  labels:
    {{- include "neon.labels" . | nindent 4 }}
  name: {{ include "neon-pageserver.componentDefName" . }}
spec:
  description: A neon pageserver component definition for Kubernetes
  provider: KubeBlocks
  scripts:
    - name: neon-scripts
      templateRef: neon-scripts
      namespace: {{ .Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555
  vars: 
    - name: NEON_STORAGEBROKER_HEADLESS
      valueFrom:
        serviceVarRef:
          compDef: {{ include "neon-storagebroker.componentDefName" . }}
          name: headless
          optional: true
          host: Optional
    - name: NEON_STORAGEBROKER_POD_LIST
      valueFrom:
        componentVarRef:
          compDef: {{ include "neon-storagebroker.componentDefName" . }}
          optional: true
          instanceNames: Optional
  runtime:
    containers:
    - command: ["/scripts/pageserver_start.sh"]
      image: {{ include "neon-pageserver.image" . }}
      name: neon-pageserver
      volumeMounts:
      - mountPath: /usr/local/neon/pageserver
        name: neon-pageserver
      - name: scripts
        mountPath: /scripts
  serviceKind: pageserver
  serviceVersion: 1.0.0
  services:
  - name: neon-pageserver
    serviceName: neon-pageserver
    spec:
      ports:
      - name: pageserver
        port: 6400
        protocol: TCP
      type: ClusterIP
