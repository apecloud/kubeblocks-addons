apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: {{ include "mongodbShard.componentDefName" . }}
  labels:
    {{- include "mongodb.labels" . | nindent 4 }}
spec:
  provider: kubeblocks.io
  serviceKind: mongodb
  serviceVersion: "8.0.4"
  configs:
    - name: mongodb-config
      templateRef: {{ include "mongodbShard.configTplName" . }}
      constraintRef: {{ include "mongodb.configConstraintName" . }}
      volumeName: mongodb-config
      namespace: {{ .Release.Namespace }}
      defaultMode: 0400  # for only read
      keys:
        - mongodb.conf
  logConfigs:
    {{- range $name,$pattern := .Values.logConfigs }}
    - name: {{ $name }}
      filePathPattern: {{ $pattern }}
    {{- end }}
  scripts:
    - name: mongodb-scripts
      templateRef: {{ include "mongodb.cmScriptsName" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555  # for read and execute, mysql container switched user account.
  systemAccounts:
    # - name: local
    #   initAccount: true
    #   passwordGenerationPolicy:
    #     length: 16
    #     numDigits: 8
    #     numSymbols: 0
    #     letterCase: MixedCases
    - name: cluster-admin
      initAccount: true
      passwordGenerationPolicy:
        length: 16
        numDigits: 8
        numSymbols: 0
        letterCase: MixedCases
  roles:
    - name: primary
      serviceable: true
      writable: true
      votable: true
    - name: secondary
      serviceable: true
      writable: false
      votable: true
  lifecycleActions:
    roleProbe:
      builtinHandler: mongodb
      periodSeconds: {{ .Values.roleProbe.periodSeconds }}
      timeoutSeconds: {{ .Values.roleProbe.timeoutSeconds }}
      #   container: mongodb
      #   exec:
      #     command:
      #       - bash
      #       - -c
      #       - |
      #         Status=$(export CLIENT=`which mongosh>/dev/null&&echo mongosh||echo mongo`; $CLIENT -u $KB_SERVICE_USER -p $KB_SERVICE_PASSWORD 127.0.0.1:27017 --quiet --eval "JSON.stringify(rs.status())") &&
      #         MyState=$(echo $Status | jq '.myState') &&
      #         echo $Status | jq ".members[] | select(.state == ($MyState | tonumber)) | .stateStr" |tr '[:upper:]' '[:lower:]'|uniq| xargs echo -n
    postProvision:
      customHandler:
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
        exec:
          command:
            - /bin/bash
            - -c
            - /scripts/mongodb-shard-manage.sh --post-provision
        preCondition: ComponentReady
        retryPolicy:
          maxRetries: 10
    preTerminate:
      customHandler:
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
        exec:
          command:
            - /bin/bash
            - -c
            - /scripts/mongodb-shard-manage.sh --pre-terminate
        retryPolicy:
          maxRetries: 10
  runtime:
    initContainers:
      - command:
          - cp
          - -r
          - /bin/syncer
          - /kubeblocks/
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.syncer.repository }}:{{ .Values.image.syncer.tag }}
        imagePullPolicy: {{ default "IfNotPresent" .Values.image.pullPolicy }}
        name: init-syncer
        volumeMounts:
          - mountPath: /kubeblocks
            name: kubeblocks
      - command:
          - bash
          - -c
          - |
            CLIENT=`which mongosh>/dev/null&&echo mongosh||echo mongo`
            # used by backup agent
            cp -r /usr/bin/$CLIENT /kubeblocks
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ default "IfNotPresent" .Values.image.pullPolicy }}
        name: init-backup-agent
        volumeMounts:
          - mountPath: /kubeblocks
            name: kubeblocks
    containers:
      - name: mongodb
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ default "IfNotPresent" .Values.image.pullPolicy }}
        ports:
          - name: mongodb
            protocol: TCP
            containerPort: &mongodbPort 27017
          - name: ha
            protocol: TCP
            containerPort: 3601
        command:
          - syncer
          - --
          - /scripts/mongodb-shard-setup.sh
        env:
          - name: PATH
            value: /kubeblocks/:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          - name: KB_SERVICE_CHARACTER_TYPE
            value: mongodb
          - name: SERVICE_PORT
            value: $(KB_SERVICE_PORT)
          - name: MONGODB_ROOT_USER
            value: $(MONGODB_ADMIN_USER)
          - name: MONGODB_ROOT_PASSWORD
            value: $(MONGODB_ADMIN_PASSWORD)
        volumeMounts:
          - mountPath: {{ .Values.dataMountPath }}
            name: data
          - mountPath: /etc/mongodb/mongodb.conf
            name: mongodb-config
            subPath: mongodb.conf
          - mountPath: /etc/mongodb/keyfile
            name: mongodb-keyfile
            subPath: keyfile
          - name: scripts
            mountPath: /scripts
          - mountPath: /kubeblocks
            name: kubeblocks
      - name: mongodb-backup-agent
        image: percona/percona-backup-mongodb
        imagePullPolicy: {{ default "IfNotPresent" .Values.image.pullPolicy }}
        command:
          - /bin/bash
          - -c
          - /scripts/backup-agent-setup.sh
        env:
          - name: PATH
            value: /kubeblocks/:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          - name: PBM_AGENT_MONGODB_USERNAME
            value: $(MONGODB_ADMIN_USER)
          - name: PBM_AGENT_MONGODB_PASSWORD
            value: $(MONGODB_ADMIN_PASSWORD)
          - name: PBM_MONGODB_REPLICA_SET
            value: $(KB_CLUSTER_COMP_NAME)
          - name: PBM_AGENT_SIDECAR
            value: "true"
          - name: PBM_AGENT_SIDECAR_SLEEP
            value: "5"
          - name: SHARED
            value: "TRUE"
          - name: POD_NAME
            value: $(KB_POD_NAME)
          - name: PBM_MONGODB_URI
            value: mongodb://$(PBM_AGENT_MONGODB_USERNAME):$(PBM_AGENT_MONGODB_PASSWORD)@localhost:$(KB_SERVICE_PORT)/?authSource=admin
        volumeMounts:
          - mountPath: {{ .Values.dataMountPath }}
            name: data
          - name: scripts
            mountPath: /scripts
          - mountPath: /kubeblocks
            name: kubeblocks
          - mountPath: /tmp/mongodb/backups
            name: tmp-backups
    volumes:
      - name: tmp-backups
        emptyDir: {}
      {{- if .Values.logCollector.enabled }}
      - name: log-data
        hostPath:
          path: /var/log/kubeblocks
          type: DirectoryOrCreate
      {{- end }}
  vars:
    # - name: MONGODB_USER
    #   valueFrom:
    #     credentialVarRef:
    #       compDef: {{ include "mongodbShard.componentDefName" . }}
    #       name: local
    #       optional: false
    #       username: Required
    # - name: MONGODB_PASSWORD
    #   valueFrom:
    #     credentialVarRef:
    #       compDef: {{ include "mongodbShard.componentDefName" . }}
    #       name: local
    #       optional: false
    #       password: Required
    - name: MONGODB_USER
      value: $(MONGODB_ADMIN_USER)
    - name: MONGODB_PASSWORD
      value: $(MONGODB_ADMIN_PASSWORD)
    - name: KB_SERVICE_PORT
      value: "27017"
      valueFrom:
        hostNetworkVarRef:
          optional: true
          container:
            name: mongodb
            port:
              name: mongodb
              option: Optional
    - name: SYNCER_SERVICE_PORT  
      valueFrom:
        hostNetworkVarRef:
          optional: true
          container:
            name: mongodb
            port:
              name: ha
              option: Optional
    - name: MONGODB_CLUSTER_ROLE
      value: "shardsvr"
    - name: MONGODB_ADMIN_USER
      valueFrom:
        credentialVarRef:
          # use config server credential to access to mongos
          compDef: {{ include "mongodbShard.componentDefName" . }}
          name: cluster-admin
          optional: false
          username: Required
    - name: MONGODB_ADMIN_PASSWORD
      valueFrom:
        credentialVarRef:
          # use config server credential to access to mongos
          compDef: {{ include "mongodbShard.componentDefName" . }}
          name: cluster-admin
          optional: false
          password: Required
    # - name: MONGODB_BACKUP_USER
    #   valueFrom:
    #     credentialVarRef:
    #       # use config server credential to backup
    #       compDef: {{ include "mongodbShard.componentDefName" . }}
    #       name: cluster-admin
    #       optional: false
    #       username: Required
    # - name: MONGODB_BACKUP_PASSWORD
    #   valueFrom:
    #     credentialVarRef:
    #       # use config server credential to backup
    #       compDef: {{ include "mongodbShard.componentDefName" . }}
    #       name: cluster-admin
    #       optional: false
    #       password: Required
    - name: MONGOS_INTERNAL_SVC_NAME
      valueFrom:
        serviceVarRef:
          compDef: {{ include "mongos.componentDefName" . }}
          optional: false
          host: Required
    - name: MONGOS_INTERNAL_PORT 
      valueFrom:
        serviceVarRef:
          compDef: {{ include "mongos.componentDefName" . }}
          optional: false
          port:
            name: mongos
    - name: MONGOS_INTERNAL_HOST
      value: "$(MONGOS_INTERNAL_SVC_NAME).$(KB_NAMESPACE).svc.{{ .Values.clusterDomain }}"
    - name: MONGODB_POD_FQDN_LIST
      valueFrom:
        componentVarRef:
          optional: false
          podFQDNs: Required
    - name: KUBERNETES_CLUSTER_DOMAIN
      # syncer will use this env to get the cluster domain to generate the pod FQDN to initialize the replica set
      value: "{{ .Values.clusterDomain }}"
  hostNetwork:
    containerPorts:
      - container: mongodb
        ports:
          - mongodb
          - ha