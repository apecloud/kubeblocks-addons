apiVersion: dataprotection.kubeblocks.io/v1alpha1
kind: BackupPolicyTemplate
metadata:
  name: mongodb-backup-policy-template
  labels:
    {{- include "mongodb.labels" . | nindent 4 }}
spec:
  serviceKind: MongoDB
  compDefs: [mongodb]
  target:
    role: secondary
    fallbackRole: primary
    account: root
  backupMethods:
    - name: dump
      snapshotVolumes: false
      actionSetName: mongodb-dump-br
      env:
      - name: IMAGE_TAG
        valueFrom:
          versionMapping:
            - serviceVersions:
              - "8.0"
              mappedValue: "8.0.8"
            - serviceVersions:
              - "7.0"
              mappedValue: "7.0.18"
            - serviceVersions:
              - "6.0"
              mappedValue: "6.0.21"
            - serviceVersions:
              - "5.0"
              mappedValue: "5.0.29-multi"
            - serviceVersions:
              - "4.4"
              mappedValue: "4.4.29-multi"
    - name: datafile
      snapshotVolumes: false
      actionSetName: mongodb-physical-br
      targetVolumes:
        volumeMounts:
          - name: data
            mountPath: {{ .Values.dataMountPath }}
    - name: volume-snapshot
      snapshotVolumes: true
      actionSetName: mongodb-volume-snapshot
      targetVolumes:
        volumes:
          - data
        volumeMounts:
          - name: data
            mountPath: {{ .Values.dataMountPath }}
    - name: archive-oplog
      target:
        role: primary
        account: root
      snapshotVolumes: false
      actionSetName: mongodb-pitr
    - name: pbm-physical
      snapshotVolumes: false
      actionSetName: mongodb-rs-pbm-physical
      env:
        - name: PBM_IMAGE_TAG
          valueFrom:
            versionMapping:
              - serviceVersions: ["7.0", "8.0"]
                mappedValue: "2.12.0"
              - serviceVersions: ["6.0"]
                mappedValue: "2.10.0"
              - serviceVersions: ["5.0", "4.4", "4.2", "4.0"]
                mappedValue: "2.5.0-multi"
      targetVolumes:
        volumeMounts:
          - name: data
            mountPath: {{ .Values.dataMountPath }}
    - name: pbm-pitr
      snapshotVolumes: false
      actionSetName: mongodb-rs-pbm-pitr
      env:
        - name: PBM_IMAGE_TAG
          valueFrom:
            versionMapping:
              - serviceVersions: ["7.0", "8.0"]
                mappedValue: "2.12.0"
              - serviceVersions: ["6.0"]
                mappedValue: "2.10.0"
              - serviceVersions: ["5.0", "4.4", "4.2", "4.0"]
                mappedValue: "2.5.0-multi"
      targetVolumes:
        volumeMounts:
          - name: data
            mountPath: {{ .Values.dataMountPath }}
  schedules:
    - backupMethod: dump
      enabled: false
      cronExpression: "0 18 * * *"
      retentionPeriod: 7d
    - backupMethod: datafile
      enabled: false
      cronExpression: "0 18 * * *"
      retentionPeriod: 7d
    - backupMethod: volume-snapshot
      enabled: false
      cronExpression: "0 18 * * *"
      retentionPeriod: 7d
    - backupMethod: archive-oplog
      enabled: false
      cronExpression: "*/5 * * * *"
      retentionPeriod: 7d
    - backupMethod: pbm-physical
      enabled: false
      cronExpression: "0 18 * * *"
      retentionPeriod: 7d
    - backupMethod: pbm-pitr
      enabled: false
      cronExpression: "*/5 * * * *"
      retentionPeriod: 8d