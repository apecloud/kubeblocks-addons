apiVersion: apps.kubeblocks.io/v1
kind: ComponentDefinition
metadata:
  name: {{ include "mongos.compDefName" . }}
  labels:
    {{- include "mongodb.labels" . | nindent 4 }}
  annotations:
    {{- include "mongodb.annotations" . | nindent 4 }}
spec:
  provider: kubeblocks.io
  serviceKind: mongodb
  serviceVersion: "8.0.17"
  services:
    - name: everypod
      podService: true
      spec:
        ports:
          - name: mongos
            port: 27017
            targetPort: mongos
  configs:
    - name: mongodb-config
      template: {{ include "mongos.configTplName" . }}
      volumeName: mongodb-config
      namespace: {{ .Release.Namespace }}
      defaultMode: 0400
      externalManaged: true
  logConfigs:
    {{- range $name,$pattern := .Values.logConfigs }}
    - name: {{ $name }}
      filePathPattern: {{ $pattern }}
    {{- end }}
  scripts:
    - name: mongodb-scripts
      template: {{ include "mongodbShard.cmScriptsName" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555  # for read and execute, mysql container switched user account.
  exporter:
    containerName: exporter
    scrapePath: /metrics
    scrapePort: exporter
  {{- include "kblib.syncer.policyRules" . | nindent 2 }}
  runtime:
    securityContext:
      # percona-server-mongodb needs run as root to have privilege to access to keyfile
      runAsUser: 0
    initContainers:
      - command:
          - sh
          - -c
          - |
            mkdir -p {{ .Values.dataMountPath }}/tmp/bin
            cp -r /opt/bitnami/kubectl/bin/kubectl {{ .Values.dataMountPath }}/tmp/bin
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.kubectl.repository }}:{{ .Values.image.kubectl.tag }}
        imagePullPolicy: {{ default "IfNotPresent" .Values.image.pullPolicy }}
        name: init-kubectl
        volumeMounts:
          - mountPath: {{ .Values.dataMountPath }}
            name: data
    containers:
      - name: mongos
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ default "IfNotPresent" .Values.image.pullPolicy }}
        ports:
          - name: mongos
            protocol: TCP
            containerPort: 27017
        command:
          - bash
          - -c
          - /scripts/mongodb-mongos-setup.sh
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: POD_UID
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.uid
          - name: POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          - name: PATH
            value: /kubeblocks/:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          - name: SERVICE_PORT
            value: $(KB_SERVICE_PORT)
          - name: MONGODB_ROOT_USER
            value: $(MONGOS_USER)
          - name: MONGODB_ROOT_PASSWORD
            value: $(MONGOS_PASSWORD)
        volumeMounts:
          - mountPath: {{ .Values.dataMountPath }}
            name: data
          - mountPath: /etc/mongodb/mongos.conf
            name: mongodb-config
            subPath: mongos.conf
          - mountPath: /etc/mongodb/keyfile
            name: mongodb-config
            subPath: keyfile
          - name: scripts
            mountPath: /scripts
          - mountPath: /kubeblocks
            name: kubeblocks
        readinessProbe:
          initialDelaySeconds: 5
          periodSeconds: 2
          timeoutSeconds: 3
          exec:
            command:
              - bash
              - -c
              - |
                client=$(mongosh --version 1>/dev/null&&echo mongosh||echo mongo)
                $client --port $SERVICE_PORT -u $MONGOS_USER -p $MONGOS_PASSWORD --authenticationDatabase admin --eval "db.adminCommand('ping')"
      - name: exporter
        imagePullPolicy: {{ default "IfNotPresent" .Values.image.pullPolicy }}
        command:
          - /mongodb_exporter
        args:
          - --compatible-mode
          - --discovering-mode
          - --mongodb.direct-connect
          - --mongodb.global-conn-pool
          - --collect-all
        ports:
          - name: exporter
            protocol: TCP
            containerPort: 9216
        env:
          - name: MONGODB_USER
            value: $(MONGOS_USER)
          - name: MONGODB_PASSWORD
            value: $(MONGOS_PASSWORD)
          - name: MONGODB_URI
            value: mongodb://127.0.0.1:$(KB_SERVICE_PORT)
    volumes:
      {{- if .Values.logCollector.enabled }}
      - name: log-data
        hostPath:
          path: /var/log/kubeblocks
          type: DirectoryOrCreate
      {{- end }}
      # mongos does not need persistent volume
      - name: data
        emptyDir: {}
  vars:
    - name: CLUSTER_NAME
      valueFrom:
        clusterVarRef:
          clusterName: Required
    - name: CLUSTER_NAMESPACE
      valueFrom:
        clusterVarRef:
          namespace: Required
    - name: CLUSTER_UID
      valueFrom:
        clusterVarRef:
          clusterUID: Required
    - name: COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          shortName: Required
    - name: CLUSTER_COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          componentName: Required
    - name: KB_CLUSTER_COMP_NAME
      valueFrom:
        componentVarRef:
          optional: false
          componentName: Required
    - name: KB_SERVICE_PORT  
      value: "27017"
    - name: CFG_SERVER_REPLICA_SET_NAME
      valueFrom:
        componentVarRef:
          compDef: {{ include "cfgServer.compDefName" . }}
          optional: false
          componentName: Required
    - name: CFG_SERVER_POD_FQDN_LIST
      valueFrom:
        componentVarRef:
          compDef: {{ include "cfgServer.compDefName" . }}
          optional: false
          podFQDNs: Required
    - name: CFG_SERVER_INTERNAL_PORT
      valueFrom:
        serviceVarRef:
          compDef: {{ include "cfgServer.compDefName" . }}
          optional: false
          port:
            name: mongodb
    - name: MONGOS_USER
      valueFrom:
        credentialVarRef:
          # use config server credential to access to mongos
          compDef: {{ include "cfgServer.compDefName" . }}
          name: root
          optional: false
          username: Required
    - name: MONGOS_PASSWORD
      valueFrom:
        credentialVarRef:
          # use config server credential to access to mongos
          compDef: {{ include "cfgServer.compDefName" . }}
          name: root
          optional: false
          password: Required
    - name: EXPORTER_SERVICE_PORT  
      value: "9216"
  hostNetwork:
    containerPorts:
      - container: mongos
        ports:
          - mongos