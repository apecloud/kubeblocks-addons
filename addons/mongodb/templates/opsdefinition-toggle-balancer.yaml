apiVersion: apps.kubeblocks.io/v1alpha1
kind: OpsDefinition
metadata:
  name: mongodb-shard-toggle-balancer
spec:
  podInfoExtractors:
    - name: toggle-balancer
      podSelector:
        multiPodSelectionPolicy: Any
  componentInfos:
    - componentDefinitionName: mongo-mongos
  parametersSchema:
    openAPIV3Schema:
      properties:
        enableBalancer:
          description: |
            Enable or disable the balancer.         
          type: boolean
          default: true
  actions:
    - name: toggle-balancer
      parameters: ["enableBalancer"]
      exec:
        podInfoExtractorName: toggle-balancer
        backoffLimit: 2
        containerName: mongos
        command:
          - bash
          - -c
          - |
            client_path=$(whereis mongosh | awk '{print $2}')
            CLIENT="mongosh"
            if [ -z "$client_path" ]; then
                CLIENT="mongo"
            fi
            CLUSTER_MONGO="$CLIENT --port $SERVICE_PORT -u $MONGODB_ROOT_USER -p $MONGODB_ROOT_PASSWORD --quiet --eval"
            # Wait for the mongos process to be ready
            MAX_RETRIES=300
            retry_count=0
            while [ $retry_count -lt $MAX_RETRIES ]; do
                result=$($CLUSTER_MONGO "db.adminCommand({ ping: 1 })" 2>/dev/null)
                if [[ "$result" == *"ok"* ]]; then
                    echo "INFO: Mongos is ready."
                    break
                fi
                echo "INFO: Waiting for mongos to be ready... (attempt $((retry_count+1))/$MAX_RETRIES)"
                retry_count=$((retry_count+1))
                sleep 2
            done
            if [ $retry_count -eq $MAX_RETRIES ]; then
                echo "ERROR: Mongos failed to become ready after $MAX_RETRIES attempts." >&2
                exit 1
            fi
            if [ "$(enableBalancer)" = "true" ]; then
                $CLUSTER_MONGO "sh.startBalancer()"
                echo "INFO: Balancer is enabled."
            else
                $CLUSTER_MONGO "sh.stopBalancer()"
                echo "INFO: Balancer is disabled."
            fi