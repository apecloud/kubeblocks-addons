apiVersion: dataprotection.kubeblocks.io/v1alpha1
kind: BackupPolicyTemplate
metadata:
  name: mongodb-shard-backup-policy-template
  labels:
    {{- include "mongodb.labels" . | nindent 4 }}
spec:
  serviceKind: MongoDB
  compDefs: [mongo-config-server]
  target:
    role: secondary
    fallbackRole: primary
    account: root
  backupMethods:
    - name: dump
      snapshotVolumes: false
      actionSetName: mongodb-shard-pbm-logical
      envMapping:
        - key: PBM_IMAGE_TAG
          valueFrom:
            serviceVersion:
              - names: ["6.0", "7.0", "8.0"]
                mappingValue: "2.9.1"
              - names: ["5.0", "4.4", "4.2", "4.0"]
                mappingValue: "2.5.0-multi"
        - key: PSM_IMAGE_TAG
          valueFrom:
            serviceVersion:
              - names: ["8.0"]
                mappingValue: "8.0.8"
              - names: ["7.0"]
                mappingValue: "7.0.18"
              - names: ["6.0"]
                mappingValue: "6.0.21"
              - names: ["5.0"]
                mappingValue: "5.0.29-multi"
              - names: ["4.4"]
                mappingValue: "4.4.29-multi"
              - names: ["4.2"]
                mappingValue: "4.2.25"
              - names: ["4.0"]
                mappingValue: "4.0.28"
      targetVolumes:
        volumeMounts:
          - name: data
            mountPath: {{ .Values.dataMountPath }}
    - name: pbm-physical
      snapshotVolumes: false
      actionSetName: mongodb-rs-pbm-physical
      envMapping:
        - key: PBM_IMAGE_TAG
          valueFrom:
            serviceVersion:
              - names: ["6.0", "7.0", "8.0"]
                mappingValue: "2.9.1"
              - names: ["5.0", "4.4", "4.2", "4.0"]
                mappingValue: "2.5.0-multi"
        - key: PSM_IMAGE_TAG
          valueFrom:
            serviceVersion:
              - names: ["8.0"]
                mappingValue: "8.0.8"
              - names: ["7.0"]
                mappingValue: "7.0.18"
              - names: ["6.0"]
                mappingValue: "6.0.21"
              - names: ["5.0"]
                mappingValue: "5.0.29-multi"
              - names: ["4.4"]
                mappingValue: "4.4.29-multi"
              - names: ["4.2"]
                mappingValue: "4.2.25"
              - names: ["4.0"]
                mappingValue: "4.0.28"
      targetVolumes:
        volumeMounts:
          - name: data
            mountPath: {{ .Values.dataMountPath }}
    - name: pbm-pitr
      snapshotVolumes: false
      actionSetName: mongodb-rs-pbm-pitr
      envMapping:
        - key: PBM_IMAGE_TAG
          valueFrom:
            serviceVersion:
              - names: ["6.0", "7.0", "8.0"]
                mappingValue: "2.9.1"
              - names: ["5.0", "4.4", "4.2", "4.0"]
                mappingValue: "2.5.0-multi"
        - key: PSM_IMAGE_TAG
          valueFrom:
            serviceVersion:
              - names: ["8.0"]
                mappingValue: "8.0.8"
              - names: ["7.0"]
                mappingValue: "7.0.18"
              - names: ["6.0"]
                mappingValue: "6.0.21"
              - names: ["5.0"]
                mappingValue: "5.0.29-multi"
              - names: ["4.4"]
                mappingValue: "4.4.29-multi"
              - names: ["4.2"]
                mappingValue: "4.2.25"
              - names: ["4.0"]
                mappingValue: "4.0.28"
      targetVolumes:
        volumeMounts:
          - name: data
            mountPath: {{ .Values.dataMountPath }}
    - name: archive-oplog
      env:
        - name: TARGET_POD_ROLE
          value: primary
      actionSetName: mongodb-pitr
      snapshotVolumes: false
      target:
        account: root
        role: primary
  schedules:
    - backupMethod: dump
      enabled: false
      cronExpression: "0 18 * * *"
      retentionPeriod: 7d
    - backupMethod: pbm-physical
      enabled: false
      cronExpression: "0 18 * * *"
      retentionPeriod: 7d
    - backupMethod: pbm-pitr
      enabled: false
      cronExpression: "*/5 * * * *"
      retentionPeriod: 8d
    - backupMethod: archive-oplog
      enabled: false
      cronExpression: "*/5 * * * *"
      retentionPeriod: 8d