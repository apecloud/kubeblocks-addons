apiVersion: apps.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: oracle
  labels:
    {{- include "oracle.labels" . | nindent 4 }}
spec:
  type: oracle
  connectionCredential:
    username: kbadmin
    password: "$(RANDOM_PASSWD)"
    endpoint: "$(SVC_FQDN):$(SVC_PORT_tcp-oracle)"
    host: "$(SVC_FQDN)"
    port: "$(SVC_PORT_tcp-oracle)"
  componentDefs:
    - name: oracle
      workloadType: Stateful
      characterType: oracle
      probes:
        roleProbe:
          failureThreshold: 2
          periodSeconds: 1
          timeoutSeconds: 1
      service:
        ports:
          - name: tcp-oracle
            port: 1521
            targetPort: tcp-oracle
          - name: oem-express
            port: 5500
            targetPort: oem-express
      volumeTypes:
        - name: data
          type: data
      podSpec:
        securityContext:
          runAsUser: 0
          fsGroup: 103
          runAsGroup: 103
        containers:
          - name:  oracle
            imagePullPolicy: {{ default .Values.image.pullPolicy "IfNotPresent" }}
            securityContext:
              runAsUser: 54321
            ports:
              - name: tcp-oracle
                containerPort: 5432
              - name: oem-express
                containerPort: 5500
{{/*            command:*/}}
{{/*              - /bin/bash*/}}
{{/*              - -c*/}}
{{/*              - |*/}}
{{/*                echo start*/}}
{{/*                sleep 10000*/}}
            env:
              - name: ORACLE_SID
                value: "ORCLCDB"
              - name: ORACLE_PDB
                value: "ORCLPDB1"
              - name: ORACLE_PWD
                valueFrom:
                  secretKeyRef:
                    name: $(CONN_CREDENTIAL_SECRET_NAME)
                    key: password
{{/*              - name: INIT_SGA_SIZE*/}}
{{/*                value:*/}}
{{/*              - name: INIT_PGA_SIZE*/}}
{{/*                value:*/}}
              - name: AUTO_MEM_CALCULATION
                value: "TRUE"
              - name: INIT_CPU_COUNT
              - name: INIT_PROCESSES
              - name: ORACLE_EDITION
                value: "enterprise"
{{/*              - name: GS_USERNAME*/}}
{{/*                valueFrom:*/}}
{{/*                  secretKeyRef:*/}}
{{/*                    name: $(CONN_CREDENTIAL_SECRET_NAME)*/}}
{{/*                    key: username*/}}
{{/*              - name: GS_DB*/}}
{{/*                value: opengauss*/}}
{{/*              - name: GAUSSLOG*/}}
{{/*                value: /var/log/opengauss*/}}
{{/*              - name: PATH*/}}
{{/*                value: /usr/local/opengauss/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin*/}}
{{/*              - name: GAUSSHOME*/}}
{{/*                value: /usr/local/opengauss*/}}
{{/*              - name: LD_LIBRARY_PATH*/}}
{{/*                value: /usr/local/opengauss/lib*/}}
{{/*              - name: PGDATA*/}}
{{/*                value: /var/lib/opengauss/data*/}}
{{/*            volumeMounts:*/}}
{{/*              - name: data*/}}
{{/*                mountPath: /opt/oracle/oradata*/}}
{{/*              - name: log*/}}
{{/*                mountPath: /var/log/opengauss*/}}
{{/*              - name: scripts*/}}
{{/*                mountPath: /kb-scripts*/}}
{{/*              - name: opengauss-config*/}}
{{/*                mountPath: /home/omm/conf*/}}
        volumes:
          - name: dshm
            emptyDir:
              medium: Memory
              {{- with .Values.shmVolume.sizeLimit }}
              sizeLimit: {{ . }}
              {{- end }}