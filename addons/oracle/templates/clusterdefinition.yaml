apiVersion: apps.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: oracle
  labels:
    {{- include "oracle.labels" . | nindent 4 }}
spec:
  type: oracle
  connectionCredential:
    username: sys
    password: "$(RANDOM_PASSWD)"
    endpoint: "$(SVC_FQDN):$(SVC_PORT_tcp-oracle)"
    host: "$(SVC_FQDN)"
    port: "$(SVC_PORT_tcp-oracle)"
  componentDefs:
    - name: oracle
      workloadType: Stateful
      characterType: oracle
      service:
        ports:
          - name: tcp-oracle
            port: 1521
            targetPort: tcp-oracle
          - name: oem-express
            port: 5500
            targetPort: oem-express
          - name: exporter
            port: 9161
            targetPort: exporter
      volumeTypes:
        - name: data
          type: data
      podSpec:
        securityContext:
          runAsUser: 0
          fsGroup: 103
          runAsGroup: 103
        containers:
          - name: oracle
            volumeMounts:
              - mountPath: /opt/oracle/oradata
                name: data
            imagePullPolicy: {{ default .Values.image.pullPolicy "IfNotPresent" }}
{{/*            command: [ "/bin/sh","-c","sleep 10000" ]*/}}
            securityContext:
              runAsUser: 54321
              runAsGroup: 54321
              fsGroup: 54321
            ports:
              - name: tcp-oracle
                containerPort: 1521
              - name: oem-express
                containerPort: 5500
            env:
              - name: ORACLE_SID
                value: "ORCLCDB"
              - name: ORACLE_PDB
                value: "ORCLPDB1"
{{/*              - name: INIT_SGA_SIZE*/}}
{{/*                value: "2048"*/}}
{{/*              - name: INIT_PGA_SIZE*/}}
{{/*                value: "2048"*/}}
              - name: ORACLE_PWD
                valueFrom:
                  secretKeyRef:
                    name: $(CONN_CREDENTIAL_SECRET_NAME)
                    key: password
              - name: AUTO_MEM_CALCULATION
                value: "false"
              - name: ORACLE_EDITION
                value: "enterprise"
            readinessProbe:
              failureThreshold: 3
              initialDelaySeconds: 10
              periodSeconds: 30
              successThreshold: 1
              timeoutSeconds: 5
              exec:
                command: [ "/bin/sh", "-c", "if [ -f $ORACLE_BASE/checkDBLockStatus.sh ]; then $ORACLE_BASE/checkDBLockStatus.sh ; else $ORACLE_BASE/checkDBStatus.sh; fi " ]
          - name: exporter
            imagePullPolicy: {{ default .Values.image.pullPolicy "IfNotPresent" }}
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              fsGroup: 1000
            ports:
              - name: exporter
                containerPort: 9161
            env:
              - name: DATA_SOURCE_NAME
                value: "oracle://sys:${ORACLE_PWD}@$localhost:1521/${ORACLE_PDB}"
              - name: ORACLE_PWD
                valueFrom:
                  secretKeyRef:
                    name: $(CONN_CREDENTIAL_SECRET_NAME)
                    key: password
              - name: ORACLE_PDB
                value: "ORCLPDB1"
{{/*            command: [ "/bin/sh","-c","sleep 10000","oracle://sys:tsj2zc8m@localhost:1521/" ]*/}}
        volumes:
          - name: dshm
            emptyDir:
              medium: Memory
              {{- with .Values.shmVolume.sizeLimit }}
              sizeLimit: {{ . }}
              {{- end }}