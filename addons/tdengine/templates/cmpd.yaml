apiVersion: apps.kubeblocks.io/v1
kind: ComponentDefinition
metadata:
  name: {{ include "tdengine.cmpdName" . }}
  labels:
    {{- include "tdengine.labels" . | nindent 4 }}
  annotations:
    {{- include "tdengine.annotations" . | nindent 4 }}
spec:
  provider: ApeCloud
  description: {{ .Chart.Description }}
  serviceKind: tdengine
  serviceVersion: {{ .Chart.AppVersion }}
  podManagementPolicy: Parallel
  minReadySeconds: 10
  services:
    - name: taosd
      serviceName: taosd
      roleSelector: ready
      spec:
        ports:
          - name: taosd
            port: 6030
            targetPort: taosd
          - name: taos-adapter
            port: 6041
            targetPort: taos-adapter
  configs:
    - name: tdengine-taos-config
      template: {{ include "tdengine.configurationTemplate" . }}
      volumeName: taos-config
      namespace: {{ .Release.Namespace }}
      externalManaged: true
    - name: tdengine-adapter-config
      template: {{ include "tdengine.adapterConfiguration" . }}
      volumeName: adapter-config
      namespace: {{ .Release.Namespace }}
      defaultMode: 0644
      restartOnFileChange: true
    - name: metrics-configuration
      template: {{ include "tdengine.metricsConfiguration" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: metrics-configuration
      defaultMode: 0444
      restartOnFileChange: true
  scripts:
    - name: taos-scripts
      template: {{ include "tdengine.scriptsTemplate" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555
  systemAccounts:
    - name: root
      initAccount: true
      passwordGenerationPolicy:
        length: 12
        letterCase: MixedCases
        numDigits: 5
        # 3.3.6支持长密码和特殊字符串
        numSymbols: 0
  roles:
    - name: ready
      updatePriority: 1
      participatesInQuorum: false
  lifecycleActions:
    roleProbe:
      initialDelaySeconds: 5
      timeoutSeconds: 60
      exec:
        container: tdengine
        command:
        - /bin/bash
        - -c
        - |
          /scripts/role-probe.sh
    postProvision:
      exec:
        targetPodSelector: Any
        container: tdengine
        command:
          - /bin/bash
          - -c
          - |
            /scripts/create-mnode.sh
      preCondition: ComponentReady
    memberLeave:
      exec:
        container: tdengine
        targetPodSelector: Any
        command:
          - bash
          - -c
          - |
            /scripts/member-leave.sh
  vars:
    - name: COMPONENT_REPLICAS
      valueFrom:
        componentVarRef:
          optional: false
          replicas: Required
    - name: TDENGINE_POD_FQDN_LIST
      valueFrom:
        componentVarRef:
          compDef: tdengine
          optional: false
          podFQDNs: Required
    - name: CLUSTER_NAME
      valueFrom:
        clusterVarRef:
          clusterName: Required
    - name: TAOS_ROOT_PASSWORD
      valueFrom:
        credentialVarRef:
          name: root
          optional: false
          password: Required
    - name: CLUSTER_NAMESPACE
      valueFrom:
        clusterVarRef:
          namespace: Required
    - name: TAOS_COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          componentName: Required
    - name: CLUSTER_DOMAIN
      value: {{ .Values.clusterDomain }}
    - name: TAOS_FIRST_EP
      value: "$(TAOS_COMPONENT_NAME)-0.$(TAOS_COMPONENT_NAME)-headless.$(CLUSTER_NAMESPACE).svc.$(CLUSTER_DOMAIN):6030"
      # valueFrom:
      #   credentialVarRef:
      #     name: {{ .Values.defaultAuth.username }}
      #     optional: false
      #     password: Required
    - name: TAOS_DISABLE_KEEPER
      value: "1"
    - name: TAOS_DISABLE_EXPLORER
      value: "1"
    - name: TAOS_SERVICE_PORT
      value: "6030"
    - name: TAOS_ADAPTER_PORT
      value: "6041"
      # valueFrom:
      #   credentialVarRef:
      #     name: {{ .Values.defaultAuth.username }}
      #     optional: false
      #     password: Required
  # systemAccounts:
  #   - name: {{ .Values.defaultAuth.username }}
  #     initAccount: true
  runtime:
    containers:
      - name: tdengine
        imagePullPolicy: IfNotPresent
        ports:
          - name: taosd
            containerPort: 6030
          - name: taos-adapter
            containerPort: 6041
        env:
          - name: TZ
            value: {{ .Values.timeZone }}
          - name: CURRENT_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
        livenessProbe:
          exec:
            command:
              - taos-check
          initialDelaySeconds: 15
          periodSeconds: 10
        volumeMounts:
          - name: taos-config
            mountPath: /etc/taos
          - name: adapter-config
            mountPath: /etc/taos-adapter
          - name: data
            mountPath: /var/lib/taos
          - name: arch
            mountPath: /var/log/taos
          - name: scripts
            mountPath: /scripts
      - name: metrics
        imagePullPolicy: {{ .Values.image.pullPolicy | quote }}
        command: ["bash"]
        args: ["-c", "/scripts/start-keeper.sh"]
        env:
          - name: TAOS_SERVICE_PORT
            value: "6030"
          - name: CURRENT_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
        ports:
          - name: http-metrics
            containerPort: 6043
        volumeMounts:
          - name: metrics-configuration
            mountPath: /etc/taos/
          - name: scripts
            mountPath: /scripts
