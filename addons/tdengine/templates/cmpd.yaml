apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: {{ include "tdengine.cmpdName" . }}
  labels:
    {{- include "tdengine.labels" . | nindent 4 }}
  annotations:
    {{- include "tdengine.annotations" . | nindent 4 }}
spec:
  provider: ApeCloud
  description: {{ .Chart.Description }}
  serviceKind: tdengine
  serviceVersion: {{ .Chart.AppVersion }}
  podManagementPolicy: Parallel
  configs:
    - name: tdengine-taos-config
      templateRef: {{ include "tdengine.configurationTemplate" . }}
      volumeName: taos-config
      namespace: {{ .Release.Namespace }}
    - name: metrics-configuration
      templateRef: {{ include "tdengine.metricsConfiguration" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: metrics-configuration
      defaultMode: 0444
  scripts:
    - name: taos-adapter-scripts
      templateRef: {{ include "tdengine.scriptsTemplate" . }}
      namespace: {{ .Release.Namespace }}
      volumeName: scripts
      defaultMode: 0555
  systemAccounts:
    - name: root
      initAccount: true
      passwordGenerationPolicy:
        length: 12
        letterCase: MixedCases
        numDigits: 5
        numSymbols: 2
  vars:
    - name: TAOS_COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          componentName: Required
    - name: TAOS_ROOT_PASSWORD
      valueFrom:
        credentialVarRef:
          name: root
          optional: false
          password: Required
    - name: TAOS_FIRST_EP
      value: "$(TAOS_COMPONENT_NAME)-0.$(TAOS_COMPONENT_NAME)-headless.$(KB_NAMESPACE).svc.{{ .Values.clusterDomain }}:6030"
    - name: TAOS_DISABLE_KEEPER
      value: "1"
    - name: TAOS_DISABLE_EXPLORER
      value: "1"
  runtime:
    containers:
      - name: tdengine
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: IfNotPresent
        command: ["/tini", "--", "/scripts/entrypoint.sh"]
        ports:
          - name: taosd
            containerPort: 6030
          - name: taos-adapter
            containerPort: 6041
        env:
          - name: TAOS_SERVICE_PORT
            value: "6030"
          - name: TAOS_ADAPTER_PORT
            value: "6041"
          - name: TZ
            value: {{ .Values.timeZone }}
          - name: CURRENT_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: TAOS_FQDN
            value: "$(CURRENT_POD_NAME).$(TAOS_COMPONENT_NAME)-headless.$(KB_NAMESPACE).svc.{{ .Values.clusterDomain }}"
        lifecycle:
          postStart:
            exec:
              command: ["/bin/sh", "-c", "/scripts/taos-adapter-check.sh"]
        readinessProbe:
          exec:
            command:
              - taos-check
          initialDelaySeconds: 5
          timeoutSeconds: 60
        livenessProbe:
          exec:
            command:
              - taos-check
          initialDelaySeconds: 15
          periodSeconds: 10
        volumeMounts:
          - name: taos-config
            mountPath: /etc/taos
          - name: data
            mountPath: /var/lib/taos
          - name: log
            mountPath: /var/log/taos
          - name: scripts
            mountPath: /scripts
      - name: metrics
        image:  {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ .Values.metrics.image.pullPolicy | quote }}
        command: ["bash"]
        args: ["-c", "/scripts/start-keeper.sh"]
        env:
          - name: TAOS_SERVICE_PORT
            value: "6030"
          - name: CURRENT_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
        ports:
          - name: http-metrics
            containerPort: 6043
        volumeMounts:
         - name: metrics-configuration
           mountPath: /etc/taos/
         - name: scripts
           mountPath: /scripts
