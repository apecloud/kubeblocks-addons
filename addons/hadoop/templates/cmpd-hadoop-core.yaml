apiVersion: apps.kubeblocks.io/v1
kind: ComponentDefinition
metadata:
  name: {{ include "coreComponentDef" . }}
  labels:
    {{- include "hadoop-hdfs.labels" . | nindent 4 }}
  annotations:
    {{- include "hadoop-hdfs.annotations" . | nindent 4 }}
spec:
  provider: kubeblocks
  description: {{ .Chart.Description }}
  serviceKind: hadoop-core
  serviceVersion: {{ .Chart.AppVersion }}
  podManagementPolicy: Parallel
  serviceRefDeclarations:
    - name: hadoopZookeeper
      optional: true
      serviceRefDeclarationSpecs:
        - serviceKind: zookeeper
          serviceVersion: "^*"
  runtime:
    containers:
      - name: hadoop-core
        imagePullPolicy: {{ default "IfNotPresent" .Values.images.pullPolicy }}
        env:
          - name: DEBUG_MODEL
            value: "false"
        volumeMounts:
          - name: hadoop-core-config
            mountPath: /hadoop/conf/core-site.xml
            subPath: core-site.xml
    securityContext:
      runAsGroup: 0
      runAsNonRoot: true
      runAsUser: 10000
    updateStrategy: BestEffortParallel
  vars:
    - name: ZOOKEEPER_COMP_ENDPOINTS
      valueFrom:
        componentVarRef:
          compDef: zookeeper
          optional: true
          podFQDNs: Required
      expression: {{ `{{ $hosts := splitList "," .ZOOKEEPER_COMP_ENDPOINTS }}{{ range $idx, $host := $hosts }}{{ $host }}:2181{{ if lt $idx (sub (len $hosts) 1) }},{{ end }}{{ end }}` | toYaml }}
    - name: ZOOKEEPER_ENDPOINTS
      valueFrom:
        serviceRefVarRef:
          name: hadoopZookeeper
          optional: true
          endpoint: Required
      expression: {{ `{{if ne (index . "ZOOKEEPER_ENDPOINTS") ""}}{{.ZOOKEEPER_ENDPOINTS}}{{else}}{{.ZOOKEEPER_COMP_ENDPOINTS}}{{end}}` | toYaml }}
    - name: CLUSTER_NAME
      valueFrom:
        clusterVarRef:
          clusterName: Required
    - name: CLUSTER_NAMESPACE
      valueFrom:
        clusterVarRef:
          namespace: Required
    - name: COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          shortName: Required
    - name: CLUSTER_COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          componentName: Required
  configs:
    - name: config
      namespace: {{ .Release.Namespace }}
      template: hadoop-core-config-template
      volumeName: hadoop-core-config
      defaultMode: 0755
      externalManaged: true
