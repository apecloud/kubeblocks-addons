apiVersion: apps.kubeblocks.io/v1
kind: ComponentDefinition
metadata:
  name: {{ include "yarnNodeManagerComponentDef" . }}
  labels:
    {{- include "hadoop.labels" . | nindent 4 }}
  annotations:
    {{- include "hadoop.annotations" . | nindent 4 }}
spec:
  provider: kubeblocks
  description: {{ .Chart.Description }}
  serviceVersion: {{ .Chart.AppVersion }}
  serviceKind: yarn-nodemanager
  podManagementPolicy: Parallel
  serviceRefDeclarations:
    - name: hadoopZookeeper
      optional: true
      serviceRefDeclarationSpecs:
        - serviceKind: zookeeper
          serviceVersion: "^*"
  runtime:
    containers:
      - name: yarn-nodemanager
        imagePullPolicy: {{ default "IfNotPresent" .Values.images.pullPolicy }}
        command:
          - /bin/bash
          - -c
          - |
            /kubeblocks/scripts/start-nodemanager.sh
        env:
          - name: DEBUG_MODEL
            value: "false"
        ports:
          - containerPort: 8040
            name: nm
          - containerPort: 8042
            name: web
          - containerPort: 8044
            name: http
          - containerPort: 45454
            name: rpc
        livenessProbe:
          failureThreshold: 6
          initialDelaySeconds: 30
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
          httpGet:
            path: /ws/v1/node
            port: 8042
        readinessProbe:
          failureThreshold: 6
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
          httpGet:
            path: /ws/v1/node
            port: 8042
        volumeMounts:
          - name: hadoop-core-config
            mountPath: /hadoop/conf/core-site.xml
            subPath: core-site.xml
          - name: hadoop-namenode-config
            mountPath: /hadoop/conf/hdfs-site.xml
            subPath: hdfs-site.xml
          - name: nodemanager-config
            mountPath: /hadoop/conf/yarn-site.xml
            subPath: yarn-site.xml
          - name: nodemanager-config
            mountPath: /hadoop/conf/mapred-site.xml
            subPath: mapred-site.xml
          - mountPath: /hadoop/conf/log4j.properties
            name: nodemanager-config
            subPath: log4j.properties
          - name: nodemanager
            mountPath: /hadoop
            subPath: nodemanager
          - name: scripts
            mountPath: /kubeblocks/scripts
        securityContext:
          runAsUser: 10000
          runAsGroup: 1000
          runAsNonRoot: true
          privileged: false
          allowPrivilegeEscalation: false
          capabilities:
            drop: [ "ALL" ]
          seccompProfile:
            type: "RuntimeDefault"
    securityContext:
      fsGroupChangePolicy: Always
      fsGroup: 1000
    updateStrategy: BestEffortParallel
    volumes:
      - name: hadoop-common
        emptyDir: {}
  configs:
    - name: config
      namespace: {{ .Release.Namespace }}
      template: hadoop-nodemanager-config-template
      volumeName: nodemanager-config
      defaultMode: 0755
      externalManaged: false
      restartOnFileChange: true
  scripts:
    - name: {{ include "hadoop.name" . }}-scripts
      template: {{ include "hadoop.name" . }}-scripts
      volumeName: scripts
      namespace: {{ .Release.Namespace }}
      defaultMode: 0755
  vars:
    - name: HOME
      value: /home/hadoop
    - name: CLUSTER_DOMAIN
      value: {{ .Values.clusterDomain | default "cluster.local" }}
    - name: RESOURCEMANAGER_COMPONENT_REPLICAS
      valueFrom:
        componentVarRef:
          optional: false
          replicas: Required
          compDef: hadoop-yarn-resourcemanager
    - name: CLUSTER_NAME
      valueFrom:
        clusterVarRef:
          clusterName: Required
    - name: SERVICE_VERSION
      valueFrom:
        componentVarRef:
          serviceVersion: Required
    - name: CLUSTER_NAMESPACE
      valueFrom:
        clusterVarRef:
          namespace: Required
    - name: COMPONENT_NAME
      valueFrom:
        componentVarRef:
          optional: false
          shortName: Required
    - name: RESOURCEMANAGER_CLUSTER_COMPONENT_NAME
      valueFrom:
        componentVarRef:
          compDef: hadoop-yarn-resourcemanager
          optional: false
          componentName: Required