---
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsDefinition
metadata:
  name: hdfs-balancer
spec:
  podInfoExtractors:
    - name: availablePod
      podSelector:
        multiPodSelectionPolicy: Any
      volumeMounts:
        - name: namenode-config
          mountPath: /hadoop/conf/hdfs-site.xml
          subPath: hdfs-site.xml
  actions:
    - name: balancer
      failurePolicy: Fail
      workload:
        podInfoExtractorName: availablePod
        type: Pod
        backoffLimit: 0
        podSpec:
          containers:
            - name: balancer
              image: {{ .Values.images.registry }}/{{ .Values.images.hadoop.repository }}:{{ .Values.images.hadoop.tag }}
              imagePullPolicy: IfNotPresent
              securityContext:
                runAsUser: 10000
                runAsGroup: 1000
                runAsNonRoot: true
                privileged: false
                allowPrivilegeEscalation: false
                capabilities:
                  drop: [ "ALL" ]
                seccompProfile:
                  type: "RuntimeDefault"
              command:
                - bash
                - -c
                - |
                  export PATH=$PATH:$HADOOP_HOME/bin
                  export PATH=$PATH:$HADOOP_HOME/sbin
                  export HADOOP_LOG_DIR=/tmp/hadoop-logs
                  hdfs balancer -conf /hadoop/conf/hdfs-site.xml