apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: spark-history
  labels:
    {{- include "spark.labels" . | nindent 4 }}
spec:
  provider: kubeblocks
  description: {{ .Chart.Description }}
  serviceKind: spark-history
  serviceRefDeclarations:
    - name: hiveMetastore
      serviceRefDeclarationSpecs:
        - serviceKind: hive-metastore
          serviceVersion: "^*"
  services:
    - name: default
      spec:
        ports:
          - name: history
            port: 9083
  runtime:
    containers:
      - name: spark-history
        imagePullPolicy: {{ default "IfNotPresent" .Values.spark.image.pullPolicy }}
        ports:
          - containerPort: 9083
            name: history
        env:
          - name: DEBUG_MODEL
            value: "false"
          - name: CURRENT_POD
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
        volumeMounts:
          - name: spark-history-config
            mountPath: /opt/kubeemr/spark/conf/spark-defaults.conf
            subPath: spark-defaults.conf
          - name: hadoop-core-config
            mountPath: /opt/kubeemr/hadoop/conf/core-site.xml
            subPath: core-site.xml
          - name: hadoop-hdfs-config
            mountPath: /opt/kubeemr/hadoop/conf/hdfs-site.xml
            subPath: hdfs-site.xml 
        securityContext:
          runAsUser: 10000
          runAsGroup: 1000
          runAsNonRoot: true
          privileged: false
          allowPrivilegeEscalation: false
          capabilities:
            drop: [ "ALL" ]
          seccompProfile:
            type: "RuntimeDefault"
    securityContext:
      fsGroupChangePolicy: Always
      fsGroup: 1000
    updateStrategy: BestEffortParallel
  vars:
    - name: HIVE_METASTORE_ENDPOINTS
      valueFrom:
        serviceRefVarRef:
          name: hiveMetastore
          endpoint: Required
  configs:
    - name: config
      namespace: {{ .Release.Namespace }}
      templateRef: spark-history-config-template
      volumeName: spark-history-config
      defaultMode: 0755