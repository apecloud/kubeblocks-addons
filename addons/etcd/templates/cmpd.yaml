apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: etcd-{{ .Chart.Version }}
  labels:
    {{- include "etcd.labels" . | nindent 4 }}
spec:
  provider: ApeCloud
  description: {{ .Chart.Description }}
  serviceKind: etcd
  runtime:
    containers:
      - name: etcd
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
          - containerPort: 2379
            name: client
          - containerPort: 2380
            name: peer
        volumeMounts:
          - name: data
            mountPath: /var/run/etcd
          - name: config
            mountPath: /etc/etcd
          # configMap mount is RO, create a RW emptyDir mount tmp-config https://github.com/kubernetes/kubernetes/issues/62099
          - name: tmp-config
            mountPath: /tmp/etcd
        command:
          - /bin/sh
          - -c
          - |
            {{- .Files.Get "scripts/start.sh" | nindent 12 }}
  vars:
    - name: CLUSTER_DOMAIN
      value: {{ .Values.clusterDomain }}
    - name: CLUSTER_NAME
      value: "$(KB_CLUSTER_COMP_NAME)"
    - name: PEERS
      valueFrom:
        componentVarRef:
          optional: false
          podFQDNs: Required
    - name: POD_NAME_LIST
      valueFrom:
        componentVarRef:
          optional: false
          instanceNames: Required
  volumes:
    - name: data
      needSnapshot: true
    - name: tmp-config
      emptyDir: {}
  services:
    - name: peer
      spec:
        ports:
          - name: peer
            port: 2380
            targetPort: peer
      podService: true
      disableAutoProvision: true
  updateStrategy: BestEffortParallel
  roles:
    - name: leader
      serviceable: true
      writable: true
      votable: true
    - name: follower
      serviceable: true
      writable: false
      votable: true
  lifecycleActions:
    roleProbe:
      customHandler:
        image: quay.io/coreos/etcd:v3.5.6
        exec:
          command:
            - |
              Status=$(etcdctl --endpoints=127.0.0.1:2379 endpoint status -w simple --command-timeout=300ms --dial-timeout=100m) &&
              IsLeader=$(echo $Status | awk -F ', ' '{print $5}') &&
              IsLearner=$(echo $Status | awk -F ', ' '{print $6}') &&
              if [ "true" = "$IsLeader" ]; then echo -n "leader"; elif [ "true" = "$IsLearner" ]; then echo -n "learner"; else echo -n "follower"; fi
  configs:
    - name: etcd-configuration-tpl
      templateRef: {{ include "etcd.configTplName" .}}
      constraintRef: {{ include "etcd.configConstraintName" .}}
      namespace: {{ .Release.Namespace }}
      volumeName: config
      defaultMode: 0666
