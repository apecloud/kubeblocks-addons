apiVersion: apps.kubeblocks.io/v1alpha1
kind: ComponentDefinition
metadata:
  name: risingwave-frontend-{{ .Chart.Version }}
  labels:
    {{- include "risingwave.labels" . | nindent 4 }}
spec:
  provider: Community
  description: {{ .Chart.Description }}
  serviceKind: risingwave
  serviceVersion: {{ .Chart.AppVersion }}
  runtime:
    containers:
      - name: frontend
        image: {{ .Values.image.registry | default "docker.io" }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        {{- include "risingwave.securityContext" . | indent  8 }}
        command:
          - /risingwave/bin/risingwave
          - frontend-node
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: RUST_BACKTRACE
            value: "1"
          - name: RW_LISTEN_ADDR
            value: "0.0.0.0:4567"
          - name: RW_CONFIG_PATH
            value: /risingwave/config/risingwave.toml
          - name: RW_ADVERTISE_ADDR
            value: "$(POD_NAME):4567"
          - name: RW_META_ADDR
            value: load-balance+http://$(META_SVC)-headless:5690
          - name: RW_METRICS_LEVEL
            value: "1"
          - name: RW_PROMETHEUS_LISTENER_ADDR
            value: "0.0.0.0:8080"
        ports:
          - containerPort: 4567
            name: svc
            protocol: TCP
          - containerPort: 8080
            name: metrics
            protocol: TCP
        volumeMounts:
          {{- include "risingwave.volumeMount.conftpl.default" . | indent  10 }}
        {{- include "risingwave.probe.liveness" . | indent  8 }}
        {{- include "risingwave.probe.readiness" . | indent 8 }}
  vars:
    {{- include "risingwave.vars.meta" . | indent 4 }}
  services:
    - name: default
      spec:
        ports:
          - port: 4567
            targetPort: svc
            name: svc
          - port: 8080
            targetPort: metrics
            name: metrics
  configs:
    {{- include "risingwave.conftpl.default" . | indent  4 }}