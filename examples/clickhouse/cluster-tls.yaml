apiVersion: apps.kubeblocks.io/v1alpha1
kind: Cluster
metadata:
  name: ch-cluster-tls
  namespace: default
spec:
  # Specifies the behavior when a Cluster is deleted.
  # - `DoNotTerminate`: Prevents deletion of the Cluster. This policy ensures that all resources remain intact.
  # - `Delete`: Extends the `Halt` policy by also removing PVCs, leading to a thorough cleanup while removing all persistent data.
  # - `WipeOut`: An aggressive policy that deletes all Cluster resources, including volume snapshots and backups in external storage. This results in complete data removal and should be used cautiously, primarily in non-production environments to avoid irreversible data loss.
  terminationPolicy: Delete
  # Specifies a list of ClusterComponentSpec objects used to define the individual components that make up a Cluster. This field allows for detailed configuration of each component within the Cluster.
  # Note: `shardingSpecs` and `componentSpecs` cannot both be empty; at least one must be defined to configure a cluster.
  # ClusterComponentSpec defines the specifications for a Component in a Cluster.
  componentSpecs:
    - name: ch-keeper
      componentDef: ch-keeper-25
      replicas: 1
      resources:
        limits:
          cpu: '0.5'
          memory: 1Gi
        requests:
          cpu: '0.5'
          memory: 1Gi
      systemAccounts:
        - name: admin
          secretRef:
            name: udf-tls-account-info
            namespace: default
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 10Gi
      tls: true   # set TLS to true for keeper
      issuer:     # if TLS is True, this filed is required.
        name: UserProvided  # set Issuer to UserProvided, P.S. KubeBlocks Issuer is unable for sharded layout.
        secretRef:
          name: clickhouse-cluster-tls
          namespace: default
          ca: ca.crt
          cert: tls.crt
          key: tls.key
  shardingSpecs:
    - name: clickhouse
      shards: 1
      template:
        name: clickhouse
        componentDef: clickhouse-25
        replicas: 2
        systemAccounts:
          - name: admin
            secretRef:
              name: udf-tls-account-info
              namespace: default
        resources:
          limits:
            cpu: '1'
            memory: 2Gi
          requests:
            cpu: '1'
            memory: 2Gi
        volumeClaimTemplates:
          - name: data
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 20Gi
        tls: true # set TLS to true
        issuer: # if TLS is True, this filed is required.
          name: UserProvided  # set Issuer to UserProvided, P.S. KubeBlocks Issuer is unable for sharded layout.
          secretRef:
            name: clickhouse-cluster-tls
            namespace: default
            ca: ca.crt
            cert: tls.crt
            key: tls.key
---
apiVersion: v1
kind: Secret
metadata:
  name: udf-tls-account-info
  namespace: default
type: Opaque
data:
  password: cGFzc3dvcmQxMjM= # 'password123' in base64
---
# pre generated tls secret
apiVersion: v1
kind: Secret
metadata:
  name: clickhouse-cluster-tls
  namespace: default
type: Opaque
stringData:
  ca.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDCzCCAfOgAwIBAgIUBjoE02lIYlEl2RDjOp9T9wmP1TUwDQYJKoZIhvcNAQEL
    BQAwFTETMBEGA1UEAwwKS3ViZUJsb2NrczAeFw0yNTEyMjMwMzQ5NDhaFw0zNTEy
    MjEwMzQ5NDhaMBUxEzARBgNVBAMMCkt1YmVCbG9ja3MwggEiMA0GCSqGSIb3DQEB
    AQUAA4IBDwAwggEKAoIBAQDhkMhIKhwKFi5xtK5dXVrucJ23ABqeoDTq9uBoCIV6
    hAcfvsv9AMBGWqn7NbcdKN8eYQ97M4qBRsFxR5FAfq2F5ecfgFWVElWd3IAc1RRD
    E9sLeVGbhdwk91OwG41Mo0BuSvBYZXT0wHz8EIYGoB5B5vx2kpQC7mGWqeonNlBJ
    4uFdKy1oL+5lWHVK1DBGqB+h9X3nH317ERNCQuOnvrho3Hs6SajOHv25MROUIcTg
    4WiESCY+SX8MVyDnJjw4+qlMl9fdxSH+s56FrF0MzcgpB1rcIwd67sdElj0abBeo
    llaMNv3asEyvNJJR20qGPLonznLPN8mqhzsPKW30qwQrAgMBAAGjUzBRMB0GA1Ud
    DgQWBBR1By3uWSRlgL4ABYM5vVRbKTNakjAfBgNVHSMEGDAWgBR1By3uWSRlgL4A
    BYM5vVRbKTNakjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQAa
    cmhCy+8xaMIn+icqqVL9mzUThMtYEPul6GjGrUqad9FC9/K9P+FDUbgPHre775IE
    Sgb0LdpBATCgR+MZLWXtq7p7rnfgCpsrPhV5Trf/AF/qhmyhS4M3M2f1i+AID043
    l/VcFUVKPQm3jtjs3klGhTgg/KtE7jD6wFSa8f3LzrNWBI0Ls/yrwgZ4cEx1ur+I
    iVUpC6n2+5UIBY1mm81w4TWSn6dr0kqQmxJJ4kPxrTU4XKhs+YOJ9XOiF7nUT6iy
    OeR4mm4Mv97rkMoykZ+ntuRIfYrgpFIIndaiD1856K5vsWtZTDQ7GIwdaBrI/xu6
    A7TZ/BvGOKuYuKhgZcwA
    -----END CERTIFICATE-----
  tls.crt: |
    -----BEGIN CERTIFICATE-----
    MIID2jCCAsKgAwIBAgIUO4YobiiQDKHCIAItX/nBspRGeoUwDQYJKoZIhvcNAQEL
    BQAwFTETMBEGA1UEAwwKS3ViZUJsb2NrczAeFw0yNTEyMjMwMzQ5NDlaFw0zNTEy
    MjEwMzQ5NDlaMBkxFzAVBgNVBAMMDmNsaWNraG91c2UtdGxzMIIBIjANBgkqhkiG
    9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1gpO4/cVUYVkG3zs1HQ8fSh4pOrbrgIQtQQ/
    YTT6GsgaJnWaXJqhBQKQMedkhRss2OeEeKzIT+ZzqZjn+tT3OsktekS2Ll0yY+xx
    b6O8iBoKrjJq8O2Fot6FwzZUxePeJl5YzUZQvvo6H1ZsMnukPZX3ZMGmo8wijUNS
    pFn/R8kIGKzl3ve0r7xe75vu5Vu2lq/vrFAoPhkx8CaRfrEtVc8P9CsKLZMsUWON
    9IkzUKrO5tFwG2KMxsfNOgt0W9jN9v3dfgdrbqxCS8gkBETrZf6GGFRqfcEYHjrk
    4m+kbHpbjlh674EMqV5jFFCYF14w/CouTT/1BM0E3nhxMBU+TQIDAQABo4IBHDCC
    ARgwCQYDVR0TBAIwADALBgNVHQ8EBAMCBeAwgb0GA1UdEQSBtTCBsoIJbG9jYWxo
    b3N0gg8qLmNsdXN0ZXIubG9jYWyCGyouY2xpY2tob3VzZS10bHMtY2xpY2tob3Vz
    ZYIaKi5jbGlja2hvdXNlLXRscy1jaC1rZWVwZXKCHyouY2xpY2tob3VzZS1jbHVz
    dGVyLWNsaWNraG91c2WCHiouY2xpY2tob3VzZS1jbHVzdGVyLWNoLWtlZXBlcoIK
    Y2xpY2tob3VzZYIOY2xpY2tob3VzZS10bHMwHQYDVR0OBBYEFGrrWGptkWpmPQje
    BhT8uTxAEKlZMB8GA1UdIwQYMBaAFHUHLe5ZJGWAvgAFgzm9VFspM1qSMA0GCSqG
    SIb3DQEBCwUAA4IBAQA9hqiYW4EGMdxNq0ODc8J2gwoIk0ancfid+7hhz5J8R8qh
    Wd+dNJhXXfNAAZGC2w2xa0MleFsNRJ0roFBRVqIB/Z+ZSjiLtXcDjL8ZqLpU1Jw1
    H0WzGnuJqh97hJ6KYF5XTb2Aa2AIZ30Q4RBAQCQmd3N/i+PgHucks7/V5HF29Uw7
    AnLtBC1tfZ2uf2fBluFJieUoBtUr0R1S35sQsywMdXhzerzxPkeQauvvFZrjdnG/
    vWKVqXK1SAht7TsQ12cTGGCe81O0R3rWKXRzW7htacWUSgZuRHpPJQTZOUJbUn4k
    PTzoiR+7y/3Z3N5H0wlLIkyP4qrweJTOs6JIB9XH
    -----END CERTIFICATE-----
  tls.key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDWCk7j9xVRhWQb
    fOzUdDx9KHik6tuuAhC1BD9hNPoayBomdZpcmqEFApAx52SFGyzY54R4rMhP5nOp
    mOf61Pc6yS16RLYuXTJj7HFvo7yIGgquMmrw7YWi3oXDNlTF494mXljNRlC++jof
    Vmwye6Q9lfdkwaajzCKNQ1KkWf9HyQgYrOXe97SvvF7vm+7lW7aWr++sUCg+GTHw
    JpF+sS1Vzw/0KwotkyxRY430iTNQqs7m0XAbYozGx806C3Rb2M32/d1+B2turEJL
    yCQEROtl/oYYVGp9wRgeOuTib6RseluOWHrvgQypXmMUUJgXXjD8Ki5NP/UEzQTe
    eHEwFT5NAgMBAAECggEAKgXeFU3WhqnczLTLPq8PjTcb8K0XsmM/anrKAsjG7ekp
    kTF3vASz5mrpapLWnneGZ5OU46hwr5c8UCjwKsQTQhxrbFz/M70ifpHWd6e7BTGv
    tSG681B+80ojEv+gxzWE0R2m666JfeVc8fgiyAqUZW8DImoO0IvsoLV+DTyKLUqD
    4Vv+r1N0JhW8mfc8qTbnWccs+8e+C9eg/jrMDWv8UGkFLi25ayYS8XFEOYKdppqz
    M5/hCSEKPkFz6+/uj1J4UX2jh6mwGKsJoFiueBWuC+ooz9QtgHAhXpifhIF2J8vu
    u21Qf6ZlWWPh/20J305xBhL2IU5iqyuAE2Jp2TGLFQKBgQD1pNOowzK6FCR0EHSQ
    xkONJWLHDkEEQjyOq+XkXZqzypm9vvVXWv1clNVq1fctS0sLShzp8Z9J48hRLKGR
    o/yozTsss++/Bp2qtrdX2wz6eyqbmclJoxhl/Z6XaBcnTKFGYtDHpkCo1dZIDw8g
    2yP31t+ODY6yKYajB8vSGiHMowKBgQDfEGRFI9grQyibPAfmW/v/fRG8BtYQE4td
    0B/sDjSzq+4patnT1RUQRLfipDG0WBgVTE3tira4L9JqvDi2i1oxTOW/JfKDRk+b
    Hblg937tSM/NkOM9kk4YChauB6qV+B08QhxnSOAnWN58UzT8MUIx5LCgwsGObgsW
    b4EqC9YITwKBgQCV+6jcfyqm4QuM7kst5lByiuQv4+0gu4ycFCsO73Q42LhcWY8V
    YlIWSC2yyKfeOP2+C+dxk/0NMY4quhSAh18KdhzuY4M74L8978gsVWwsOC3AyfpU
    Asgv5dYCXiTc8vX5svYFIOaT79ShNMio6ASjG8htxKte7uns+yKgyyHd/wKBgH6a
    Aw7qxSnouAdDDwjDdEcRaRtalewR66uXEEcd2POQxV9kcbU03vuYxPUxU7STuzd7
    U09ax1HKcpZ5tYaFmO8aQds3Ymj3Yv8a47gRQEzUYny9mvu7Ke+i6jRjzYHIjG9C
    5nQIfJBYdA4D+7KXEobW0Ris8MYx1sEpEBoZFaUpAoGARaUzWbazlSPGwA4PpV1a
    A7iBBGxrr7R6itswp9C+3rM6zNboDKfA/jgivnVZkH+vEF3Etm+1ic4PTHYxuH8V
    MkndnzemaQ5sPLEM/adgInVc/o8WwNiHZ7aFUKduhbpVyUiCCo+e4ILC+XHNJm14
    toNEdKxJTK9cBU3TTVma2uk=
    -----END PRIVATE KEY-----
