apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: clickhouse-tls
  namespace: demo
spec:
  # Specifies the name of the ClusterDef to use when creating a Cluster.
  clusterDef: clickhouse
  # Specifies the clickhouse cluster topology defined in ClusterDefinition.Spec.topologies.
  # - `standalone`: single clickhouse instance
  # - `cluster`: clickhouse with ClickHouse Keeper as coordinator
  topology: cluster
  # Specifies the behavior when a Cluster is deleted.
  # - `DoNotTerminate`: Prevents deletion of the Cluster. This policy ensures that all resources remain intact.
  # - `Delete`: Extends the `Halt` policy by also removing PVCs, leading to a thorough cleanup while removing all persistent data.
  # - `WipeOut`: An aggressive policy that deletes all Cluster resources, including volume snapshots and backups in external storage. This results in complete data removal and should be used cautiously, primarily in non-production environments to avoid irreversible data loss.
  terminationPolicy: Delete
  # Specifies a list of ClusterComponentSpec objects used to define the individual components that make up a Cluster. This field allows for detailed configuration of each component within the Cluster.
  # Note: `shardingSpecs` and `componentSpecs` cannot both be empty; at least one must be defined to configure a cluster.
  # ClusterComponentSpec defines the specifications for a Component in a Cluster.
  componentSpecs:
    - name: ch-keeper
      componentDef: clickhouse-keeper-1
      replicas: 1
      resources:
        limits:
          cpu: '0.5'
          memory: 1Gi
        requests:
          cpu: '0.5'
          memory: 1Gi
      systemAccounts:
        - name: admin
          secretRef:
            name: udf-tls-account-info
            namespace: demo
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 10Gi
      tls: true   # set TLS to true for keeper
      issuer:     # if TLS is True, this filed is required.
        name: UserProvided  # set Issuer to UserProvided, P.S. KubeBlocks Issuer is unable for sharding typology.
        secretRef:
          name: clickhouse-cluster-tls
          namespace: demo
          ca: ca.crt
          cert: tls.crt
          key: tls.key
  shardings:
    - name: clickhouse
      shards: 1
      template:
        name: clickhouse
        componentDef: clickhouse-1
        replicas: 2
        systemAccounts:
          - name: admin
            secretRef:
              name: udf-tls-account-info
              namespace: demo
        resources:
          limits:
            cpu: '1'
            memory: 2Gi
          requests:
            cpu: '1'
            memory: 2Gi
        volumeClaimTemplates:
          - name: data
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 20Gi
        tls: true # set TLS to true
        issuer: # if TLS is True, this filed is required.
          name: UserProvided  # set Issuer to UserProvided, P.S. KubeBlocks Issuer is unable for sharding typology.
          secretRef:
            name: clickhouse-cluster-tls
            namespace: demo
            ca: ca.crt
            cert: tls.crt
            key: tls.key
---
apiVersion: v1
kind: Secret
metadata:
  name: udf-tls-account-info
  namespace: demo
type: Opaque
data:
  password: cGFzc3dvcmQxMjM= # 'password123' in base64
---
# pre generated tls secret using helm template
# Generated by: helm template clickhouse-tls addons-cluster/clickhouse --namespace demo --set tls.enabled=true --set tls.issuer=UserProvided --set tls.secretName=clickhouse-cluster-tls
# Certificate SANs include:
#   DNS: localhost, clickhouse-tls-clickhouse, clickhouse-tls-clickhouse.demo.svc,
#        *.clickhouse-tls-clickhouse-headless.demo.svc.cluster.local,
#        clickhouse-tls-ch-keeper, clickhouse-tls-ch-keeper.demo.svc,
#        *.clickhouse-tls-ch-keeper-headless.demo.svc.cluster.local
#   IP: 127.0.0.1, ::1
apiVersion: v1
kind: Secret
metadata:
  name: clickhouse-cluster-tls
  namespace: demo
type: Opaque
stringData:
  ca.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDFzCCAf+gAwIBAgIQflqmC1o0WGc+uBpiwIMx2zANBgkqhkiG9w0BAQsFADAV
    MRMwEQYDVQQDEwpLdWJlQmxvY2tzMCAXDTI2MDIwNTA5MDc1MFoYDzIxMjYwMTEy
    MDkwNzUwWjAVMRMwEQYDVQQDEwpLdWJlQmxvY2tzMIIBIjANBgkqhkiG9w0BAQEF
    AAOCAQ8AMIIBCgKCAQEAz4WGIlQ0pvwSVD4mcAy+W2uUlNjRLf+LhKY1xWG9ei8R
    06xX4LIieNYZ1K8gjnH8eKcn7SaVztnp6mIsK33zTOu/cg1gLBXZArl5rBj4U79U
    VMNR1dgYuLDYACv8fjL1ONxQD29hXIM+riBFQ0SH45HePsYzVN/kbd6zz4wObF/p
    KMtB6HpOar/C2xTwbgUKxlCLMY7pJA0R0+7k3Q/Hl0VZi56iOCOpT0PZ3dZRMG8h
    vlAaGj3gKYVFvt3ZVTQtynyNiuZsqyd7rnEFaLXgCQ6N33IpfHpbLOfhw4B/GHwx
    UsyPgQNZRV3djSioM/wKVk9sOYaOxzpN4q2qlUGJowIDAQABo2EwXzAOBgNVHQ8B
    Af8EBAMCAqQwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMA8GA1UdEwEB
    /wQFMAMBAf8wHQYDVR0OBBYEFOQZ2TSN6S6vslPhLrX+6DR1KJ6HMA0GCSqGSIb3
    DQEBCwUAA4IBAQDH1VyjKYaWbZM0MyXp7vF9qAumimjp2I3+nvwUlgM85FJznYSZ
    QK2HQosPal3SCJ7fdtx+hbPUhZc+Hq99Jlx69qfHMzeDhqdC395v4fFA0h/N9y8L
    YAZcBsdR6kt5B3jculbGOHEJkAnRfuBqKF3WSuIBWoOthDOORksiQOBSL1K5A+1/
    YTA/f9xCF6y7iWD0PuW028rtgKVXVO4/pt9UZqqyduo+bhrknPGlhmwaF5fr4nvp
    5FyLBc7ufG66TAhcSkdVUm8bUd4aq4qGqmNE38HKbEatQ2cvnDWQdYQLFB4C/rW0
    nu6402RpntXT6hOeD9at6K3OWK1+vAcPes1/
    -----END CERTIFICATE-----
  tls.crt: |
    -----BEGIN CERTIFICATE-----
    MIIEQzCCAyugAwIBAgIQNjtqrPaIjdrpgEu97ckGhDANBgkqhkiG9w0BAQsFADAV
    MRMwEQYDVQQDEwpLdWJlQmxvY2tzMCAXDTI2MDIwNTA5MDc1MVoYDzIxMjYwMTEy
    MDkwNzUxWjAVMRMwEQYDVQQDEwpjbGlja2hvdXNlMIIBIjANBgkqhkiG9w0BAQEF
    AAOCAQ8AMIIBCgKCAQEAnp+yoP+StcTx0pGtwlB21ykBEf7CnJLFcZPshR8xD6Fp
    EthmixjBVdaFWU414+Z/6rRkry3zccrt0D6f1b0FAaIsYgqg8kehOl94iZf7h4qq
    e3aGMHHtfoqW2t+IGu+XPjyJUZHmBHPJnuWwwAlL1vN0nK/Ffp2YKAFSXm4xiyws
    /atAsJscUlJIPnYdg1uYjkokdMW0CmuImN3oYsapQqh3aucbplS5/7GqSM6EheoS
    EO5E8xQrDv1b18EM/m0QIxReA2zuWmlgByp6psRtwVJU9f+/es6vMkE3L/4e0WOH
    1QemDqdBPTXXCfDKpuoV0D94oS2oDl2/Crh00rLM1QIDAQABo4IBizCCAYcwDgYD
    VR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNV
    HRMBAf8EAjAAMB8GA1UdIwQYMBaAFOQZ2TSN6S6vslPhLrX+6DR1KJ6HMIIBJQYD
    VR0RBIIBHDCCARiCCWxvY2FsaG9zdIIZY2xpY2tob3VzZS10bHMtY2xpY2tob3Vz
    ZYIiY2xpY2tob3VzZS10bHMtY2xpY2tob3VzZS5kZW1vLnN2Y4I7Ki5jbGlja2hv
    dXNlLXRscy1jbGlja2hvdXNlLWhlYWRsZXNzLmRlbW8uc3ZjLmNsdXN0ZXIubG9j
    YWyCGGNsaWNraG91c2UtdGxzLWNoLWtlZXBlcoIhY2xpY2tob3VzZS10bHMtY2gt
    a2VlcGVyLmRlbW8uc3ZjgjoqLmNsaWNraG91c2UtdGxzLWNoLWtlZXBlci1oZWFk
    bGVzcy5kZW1vLnN2Yy5jbHVzdGVyLmxvY2FshwR/AAABhxAAAAAAAAAAAAAAAAAA
    AAABMA0GCSqGSIb3DQEBCwUAA4IBAQAMxS8Oyqa/EXS1f8qU1VzD4R2I0DH+13vM
    JjVL840HJTAjubKBkFDP7tKdLw6r1iCapk6DpXyPipBmZgpjNgV9qT9f/edmTxw5
    661wz+H8lVPW6uFRdu7h+QV1pY224nV2riX7Vt+1zEg5XcBKTLccE/IR+/yYclS4
    F91XPwLD8m3orQCAbA0vlLTlKTs0htjBeD8jotY/AveeZUUqgwUWbhjLwPhy8hZZ
    08xkWfM97EbNy62LQgtd+rqElmFQ47xVkFA98lp928yF2J7kmUO8D3F8Ce9willW
    YxR3GQRRVS5XXWPde1ew35f8532RxatuZ7WGC5B9o1PRpFPGCLyO
    -----END CERTIFICATE-----
  tls.key: |
    -----BEGIN RSA PRIVATE KEY-----
    MIIEogIBAAKCAQEAnp+yoP+StcTx0pGtwlB21ykBEf7CnJLFcZPshR8xD6FpEthm
    ixjBVdaFWU414+Z/6rRkry3zccrt0D6f1b0FAaIsYgqg8kehOl94iZf7h4qqe3aG
    MHHtfoqW2t+IGu+XPjyJUZHmBHPJnuWwwAlL1vN0nK/Ffp2YKAFSXm4xiyws/atA
    sJscUlJIPnYdg1uYjkokdMW0CmuImN3oYsapQqh3aucbplS5/7GqSM6EheoSEO5E
    8xQrDv1b18EM/m0QIxReA2zuWmlgByp6psRtwVJU9f+/es6vMkE3L/4e0WOH1Qem
    DqdBPTXXCfDKpuoV0D94oS2oDl2/Crh00rLM1QIDAQABAoIBAAW6yIHCwYqhysdb
    nj5k2CoU79Y10NNFhO7BlFtJoWTKZIh6+xc+pWsjlM0BQ3aQMqIocnOWchLz7Mun
    G3Blw7rHoBlJf39I4ZTBcpHrxLjkZBySDy5MSzMVL/ZHeTvZ2Cl2F9Kzta6G/Ssp
    ak1BeLUSta1cNwLIEAEv7Qj+q3j2qLVyG8Ps1HQVEuCM0zOwsmW7oUXhjW4NG2uz
    hGlKxVrf6r7xNewLEqF95ltPa3hwc5rfxbwgakmwf3A96UxbtH5l5k5QzKA8yv5T
    +Z17Fe8m2MyLskjb/1wOs8TLlxLMl00s4xG+Ku7UcE1ujKrpv1YHvVoj/v3GlyqX
    VjwH28ECgYEA0zO+nSp51XQvZwo19iwQ0kiMDv+XRP0gQ9TcVX2SskjGaZrSkGms
    2JG9QiqclIlNvNCl/sZd2T5fjD3iTlKNzIaX9scfZN/GQNf4xUmeUXIrqzieDDzP
    R/8uKF/15uXc2MDBbhH9DgsriFyowCcqpmI4gVVU5Hc6laPLrNmDt8ECgYEAwET0
    wO9ehovIbEnwNY9f9f9ycAaZAGJRI2ypLqsAsHqEF51rlgz+GvRKjvjv6cioHaF2
    JEhvOakq7EKIy1lVBSXdhSQDd0DKMLelbUqwWk2bTManxIn21hEHquqYqCEzdRz1
    mWHVW1f1QmPCt79Deijxbm2Tl7x931T5EvwDOhUCgYAigGd5IUE533sG6CIcjuJI
    l9VZdeNuP7OPoSxFQvg966mOAt62/KxhzJ0QPAnMMgni+GrFjf4yyP+u10Uq6k2D
    xdD5XVoBjpTCbwWSpQ4Z2/7KP7uB4EU0S7lsmxB+obpMJmDy7Dlcm/KGmixvB3bu
    K0lzx07Q67FEVLenCvl7gQKBgGl6Ks9hQfkL3ELT+SxY4GsC3VPpuqwEQ8DsTo/k
    jfdC7w5JdQkXTZuZ4wE2Pd+CDgBbYIWdGy+Fx59fDM6JzmOJl1IAJMqaR5GcXets
    Kv0PUCA5ZzYh/cEIDK3ODztFI4afAXlIu5Rl1425Tswg6DKvHWvYPzzh0iff5Nhu
    WpLVAoGAEwqBym1eP4lxdeIfbM7CfTTQWgStr9pJE+hc7v8pd/wrrHQ12/Q3Ih0+
    bwChBJ4y18Hm150+5iVp743Bw94gp/1Kuo/ZLAW18uWAlT51lVl15XuiJCYjFOZt
    3Zkx9rnDQpZSZRELXJXhRTem/62a1cqnGXC6WEFfTUlTaPaQ1eo=
    -----END RSA PRIVATE KEY-----
