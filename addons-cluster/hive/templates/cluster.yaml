apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ include "kblib.clusterName" . }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
  {{- if .Values.hostNetworkEnabled }}
  annotations:
    kubeblocks.io/host-network: "server2"
  {{- end }}
spec:
  terminationPolicy: Delete
  clusterDef: hive
  topology: {{ .Values.topology }}
  componentSpecs:
    {{- if not .Values.serviceRefs.enable }}
    - name: mysql
      componentDef: mysql-8.0
      serviceVersion: {{ .Values.serviceVersion.mysql }}
      replicas: {{ .Values.replicas.mysql }}
      resources:
        requests:
          cpu: {{ .Values.resources.mysql.requests.cpu | quote }}
          memory: {{ .Values.resources.mysql.requests.memory }}
        limits:
          cpu: {{ .Values.resources.mysql.limits.cpu | quote }}
          memory: {{ .Values.resources.mysql.limits.memory }}
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: {{ .Values.storage.mysql }}
    {{- end }}
    - name: metastore
      componentDef: hive-metastore
      serviceVersion: {{ .Values.serviceVersion.hive }}
      {{- if .Values.serviceRefs.enable }}
      serviceRefs:
        - name: hive-mysql-metadb
          namespace: {{ .Values.serviceRefs.hiveMysqlMetadb.namespace }}
          clusterServiceSelector:
            cluster: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.cluster }}
            service:
              component: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.service.component }}
              service: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.service.service }}
              port: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.service.port }}
            credential:
              component: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.credential.component }}
              name: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.credential.name }}
      {{- end }}
      replicas: {{ .Values.replicas.metastore }}
      resources:
        requests:
          cpu: {{ .Values.resources.metastore.requests.cpu | quote }}
          memory: {{ .Values.resources.metastore.requests.memory }}
        limits:
          cpu: {{ .Values.resources.metastore.limits.cpu | quote }}
          memory: {{ .Values.resources.metastore.limits.memory }}
      volumes:
        - name: hadoop-core-config
          configMap:
            name: {{ .Values.hadoopCluster.name }}-journalnode-core-config
        - name: hadoop-hdfs-config
          configMap:
            name: {{ .Values.hadoopCluster.name }}-namenode-config
        - name: hadoop-yarn-config
          configMap:
            name: {{ .Values.hadoopCluster.name }}-resourcemanager-config
        - name: mapred-site-config
          configMap:
            name: {{ .Values.hadoopCluster.name }}-resourcemanager-mapred-site-config
      volumeClaimTemplates:
        - name: metadata
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: {{ .Values.storage.metastore }}
    - name: server2
      componentDef: hive-server2
      serviceVersion: {{ .Values.serviceVersion.hive }}
      replicas: {{ .Values.replicas.metastore }}
      {{- if .Values.loadBalancerEnabled }}
      services:
      - name: lb-advertised
        serviceType: LoadBalancer
        podService: true
        {{- include "kblib.loadBalancerAnnotations" . | indent 8 }}
      {{- end }}
      {{- if eq .Values.clusterMode "ZOOKEEPER-HA" }}
      serviceRefs:
        - name: hadoopZookeeper
          clusterServiceSelector:
            cluster: {{ .Values.hadoopCluster.name }}
            podFQDNs:
              component: zookeeper
      {{- end }}
      volumes:
        - name: hadoop-core-config
          configMap:
            name: {{ .Values.hadoopCluster.name }}-journalnode-core-config
        - name: hadoop-hdfs-config
          configMap:
            name: {{ .Values.hadoopCluster.name }}-namenode-config
        - name: hadoop-yarn-config
          configMap:
            name: {{ .Values.hadoopCluster.name }}-resourcemanager-config
        - name: mapred-site-config
          configMap:
            name: {{ .Values.hadoopCluster.name }}-resourcemanager-mapred-site-config
      resources:
        requests:
          cpu: {{ .Values.resources.server2.requests.cpu | quote }}
          memory: {{ .Values.resources.server2.requests.memory }}
        limits:
          cpu: {{ .Values.resources.server2.limits.cpu | quote }}
          memory: {{ .Values.resources.server2.limits.memory }}