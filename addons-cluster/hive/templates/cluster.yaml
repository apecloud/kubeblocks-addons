apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ include "kblib.clusterName" . }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
spec:
  terminationPolicy: Delete
  clusterDef: hive
  topology: {{ .Values.topology }}
  componentSpecs:
    {{- if not .Values.serviceRefs.enable }}
    - name: mysql
      componentDef: mysql-8.0
      serviceVersion: {{ .Values.serviceVersion.mysql }}
      replicas: {{ .Values.replicas.mysql }}
      resources:
        requests:
          cpu: {{ .Values.resources.mysql.requests.cpu | quote }}
          memory: {{ .Values.resources.mysql.requests.memory }}
        limits:
          cpu: {{ .Values.resources.mysql.limits.cpu | quote }}
          memory: {{ .Values.resources.mysql.limits.memory }}
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: {{ .Values.storage.mysql }}
    {{- end }}
    - name: metastore
      componentDef: hive-metastore
      serviceVersion: {{ .Values.serviceVersion.metastore }}
      {{- if .Values.serviceRefs.enable }}
      serviceRefs:
        - name: hive-mysql-metadb
          namespace: {{ .Values.serviceRefs.hiveMysqlMetadb.namespace }}
          clusterServiceSelector:
            cluster: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.cluster }}
            service:
              component: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.service.component }}
              service: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.service.service }}
              port: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.service.port }}
            credential:
              component: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.credential.component }}
              name: {{ .Values.serviceRefs.hiveMysqlMetadb.clusterServiceSelector.credential.name }}
      {{- end }}
      replicas: {{ .Values.replicas.metastore }}
      resources:
        requests:
          cpu: {{ .Values.resources.metastore.requests.cpu | quote }}
          memory: {{ .Values.resources.metastore.requests.memory }}
        limits:
          cpu: {{ .Values.resources.metastore.limits.cpu | quote }}
          memory: {{ .Values.resources.metastore.limits.memory }}
      volumes:
        - name: hadoop-core-config
          configMap:
            name: {{ .Values.hadoopCluster }}-hadoop-core-config
        - name: hadoop-hdfs-config
          configMap:
            name: {{ .Values.hadoopCluster }}-namenode-config
        - name: hadoop-yarn-config
          configMap:
            name: {{ .Values.hadoopCluster }}-resourcemanager-config
      volumeClaimTemplates:
        - name: metadata
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: {{ .Values.storage.metastore }}
