apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ include "kblib.clusterName" . }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
spec:
  terminationPolicy: {{ .Values.terminationPolicy | quote }}
  clusterDef: {{ .Values.clusterDef | quote }}
  topology: {{ .Values.topology | quote }}
  componentSpecs:
    - name: hmaster
      componentDef: hbase-hmaster-2.5
      serviceVersion: 2.5.6
      replicas: {{ .Values.replicas.hmaster }}
      serviceRefs:
        - name: hbase-zookeeper
          namespace: {{ .Values.serviceRefs.hbaseZookeeper.namespace }}
          clusterServiceSelector:
            cluster: {{ .Values.serviceRefs.hbaseZookeeper.clusterServiceSelector.cluster }}
            service:
              component: {{ .Values.serviceRefs.hbaseZookeeper.clusterServiceSelector.service.component }}
              service: {{ .Values.serviceRefs.hbaseZookeeper.clusterServiceSelector.service.service }}
              port: {{ .Values.serviceRefs.hbaseZookeeper.clusterServiceSelector.service.port }}
        - name: hadoop-namenode
          namespace: {{ .Values.serviceRefs.hadoopNamenode.namespace }}
          clusterServiceSelector:
            cluster: {{ .Values.serviceRefs.hadoopNamenode.clusterServiceSelector.cluster }}
            service:
              component: {{ .Values.serviceRefs.hadoopNamenode.clusterServiceSelector.service.component }}
              service: {{ .Values.serviceRefs.hadoopNamenode.clusterServiceSelector.service.service }}
              port: {{ .Values.serviceRefs.hadoopNamenode.clusterServiceSelector.service.port }}
      env:
        - name: "HADOOP_CLUSTER_NAME"
          value: {{ .Values.hadoopClusterName | quote }}
      resources:
        requests:
          cpu: {{ .Values.resources.hmaster.requests.cpu | quote }}
          memory: {{ .Values.resources.hmaster.requests.memory }}
        limits:
          cpu: {{ .Values.resources.hmaster.limits.cpu | quote }}
          memory: {{ .Values.resources.hmaster.limits.memory }}
      volumes:
        - name: hadoop-core-config
          configMap:
            name: {{  .Values.hadoopClusterName }}-hadoop-core-config
        - name: hadoop-hdfs-config
          configMap:
            name: {{ .Values.hadoopClusterName }}-namenode-config
      volumeClaimTemplates:
        - name: hbase-log
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: {{ .Values.storage.hbaseLog }}

    - name: hregionserver
      componentDef: hbase-hregionserver-2.5
      serviceVersion: 2.5.6
      replicas: {{ .Values.replicas.hregionserver }}
      serviceRefs:
        - name: hbase-zookeeper
          namespace: {{ .Values.serviceRefs.hbaseZookeeper.namespace }}
          clusterServiceSelector:
            cluster: {{ .Values.serviceRefs.hbaseZookeeper.clusterServiceSelector.cluster }}
            service:
              component: {{ .Values.serviceRefs.hbaseZookeeper.clusterServiceSelector.service.component }}
              service: {{ .Values.serviceRefs.hbaseZookeeper.clusterServiceSelector.service.service }}
              port: {{ .Values.serviceRefs.hbaseZookeeper.clusterServiceSelector.service.port }}
        - name: hadoop-namenode
          namespace: {{ .Values.serviceRefs.hadoopNamenode.namespace }}
          clusterServiceSelector:
            cluster: {{ .Values.serviceRefs.hadoopNamenode.clusterServiceSelector.cluster }}
            service:
              component: {{ .Values.serviceRefs.hadoopNamenode.clusterServiceSelector.service.component }}
              service: {{ .Values.serviceRefs.hadoopNamenode.clusterServiceSelector.service.service }}
              port: {{ .Values.serviceRefs.hadoopNamenode.clusterServiceSelector.service.port }}
      env:
        - name: "HADOOP_CLUSTER_NAME"
          value: {{ .Values.hadoopClusterName | quote }}
      resources:
        requests:
          cpu: {{ .Values.resources.hregionserver.requests.cpu | quote }}
          memory: {{ .Values.resources.hregionserver.requests.memory }}
        limits:
          cpu: {{ .Values.resources.hregionserver.limits.cpu | quote }}
          memory: {{ .Values.resources.hregionserver.limits.memory }}
      volumes:
        - name: hadoop-core-config
          configMap:
            name: {{ .Values.hadoopClusterName }}-hadoop-core-config
        - name: hadoop-hdfs-config
          configMap:
            name: {{ .Values.hadoopClusterName }}-namenode-config
      volumeClaimTemplates:
        - name: hbase-temp-data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: {{ .Values.storage.hbaseTempData }}
