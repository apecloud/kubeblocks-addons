apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: {{ include "kblib.clusterName" . }}
  namespace: {{ .Release.Namespace }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
  annotations:
    {{- include "rocketmq-cluster.annotations.extra-envs" . | nindent 4 }}
spec:
  clusterDef: rocketmq
  topology: master-slave
  terminationPolicy: {{ .Values.extra.terminationPolicy }}
  componentSpecs:
    - name: namesrv
      replicas: {{ .Values.namesrv.replicas }}
      componentDef: rocketmq-namesrv-4
      serviceVersion: {{ .Values.version }}
      {{- include "kblib.componentResources" . | indent 6 }}
    {{- if .Values.monitorEnable }}
    - name: exporter
      replicas: {{ $.Values.monitor.replicas }}
      componentDef: rocketmq-exporter
      serviceVersion: 0.0.3
      env:
        - name: ROCKETMQ_VERSION
          value: {{ .Values.version }}
        # add "rocketmq-cluster.extra-envs" in helpers.tpl
        {{- range $key, $value := include "rocketmq-cluster.extra-envs" . | fromYaml }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
      {{- include "rocketmq-exporter.resources" . | nindent 6 }}
    {{- end }}
    {{- if .Values.dashboardEnable }}
    - name: dashboard
      replicas: {{ $.Values.dashboard.replicas }}
      componentDef: rocketmq-dashboard
      serviceVersion: 2.0.1
      env:
        {{- range $key, $value := include "rocketmq-cluster.extra-envs" . | fromYaml }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
      {{- include "rocketmq-dashboard.resources" . | nindent 6 }}
    {{- end }}
  shardings:
    - name: broker
      shards: {{ .Values.broker.shardCount }}
      template:
        name: rocketmq-broker
        replicas: {{ .Values.broker.replicas }}
        componentDef: rocketmq-broker-4
        serviceVersion: {{ .Values.version }}
        env:
          {{- range $key, $value := include "rocketmq-cluster.extra-envs" . | fromYaml }}
          - name: {{ $key }}
            value: {{ $value | quote }}
          {{- end }}
        systemAccounts:
          - name: rocketmq-admin
            passwordConfig:
              length: 8
              numDigits: 6
              letterCase: MixedCases
              # useless seed, will be overRide by system accounts defined in cluster.
              seed: {{ include "kblib.clusterName" . }}
        {{- include "kblib.componentResources" . | indent 8 }}
        {{- include "kblib.componentStorages" . | indent 8 }}
