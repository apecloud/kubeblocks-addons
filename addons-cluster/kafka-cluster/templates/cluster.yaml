apiVersion: apps.kubeblocks.io/v1alpha1
kind: Cluster
metadata:
  name: {{ include "kblib.clusterName" . }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
  annotations:
    "kubeblocks.io/extra-env": '{"KB_KAFKA_ENABLE_SASL":"{{ $.Values.saslEnable }}","KB_KAFKA_BROKER_HEAP":"{{ $.Values.brokerHeap }}","KB_KAFKA_CONTROLLER_HEAP":"{{ $.Values.controllerHeap }}","KB_KAFKA_PUBLIC_ACCESS":"{{ $.Values.extra.publiclyAccessible }}"}'
spec:
  clusterDefinitionRef: kafka # ref clusterdefinition.name
  terminationPolicy: {{ .Values.extra.terminationPolicy }}
  {{- include "kblib.affinity" . | indent 2 }}
  topology: {{- include "kafka-cluster.topology" . | indent 2 }}
  componentSpecs:
    {{- if eq "combined" $.Values.mode }}
    - name: kafka-combine
      {{- include "kafka-cluster.combine-componentSpec" . | nindent 6 }}
    {{- else }}
    - name: kafka-broker
      {{- include "kafka-cluster.broker-componentSpec" . | nindent 6 }}
      {{- if eq "withZookeeper" $.Values.mode }}
    - name: kafka-zookeeper
      {{- include "kafka-cluster.zookeeper-componentSpec" . | nindent 6 }}
      {{- else }}
    - name: kafka-controller
      {{- include "kafka-cluster.controller-componentSpec" . | nindent 6 }}
      {{- end }}
    {{- end }}
    {{- if .Values.monitorEnable }}
    - name: kafka-exporter
      replicas: {{ $.Values.monitor.replicas }}
      monitor: true
      env:
        - name: KB_KAFKA_ENABLE_SASL_SCRAM
          value: "{{ .Values.saslScramEnable }}"
      {{- include "kafka-exporter.resources" . | nindent 6 }}
    {{- end }}
