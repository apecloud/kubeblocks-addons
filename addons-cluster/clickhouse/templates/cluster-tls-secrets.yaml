{{- if and .Values.tls.enabled (eq .Values.tls.issuer "UserProvided") }}
{{- $clusterName := include "kblib.clusterName" . }}
{{- $namespace := .Release.Namespace }}
{{- $svcNames := list (printf "%s-clickhouse" $clusterName) (printf "%s-ch-keeper" $clusterName) }}
{{- $clusterDomain := "cluster.local" }}
{{- $dnsNames := list "localhost" }}
{{- range $svc := $svcNames }}
{{- $dnsNames = concat $dnsNames (list
  $svc
  (printf "%s.%s.svc" $svc $namespace)
  (printf "*.%s-headless.%s.svc.%s" $svc $namespace $clusterDomain)
  ) }}
{{- end }}
{{- $ca := genCA "KubeBlocks" 36500 }}
{{- $cert := genSignedCert "clickhouse" (list "127.0.0.1" "::1") $dnsNames 36500 $ca }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.tls.secretName }}
  namespace: {{ .Release.Namespace | quote }}
  labels: {{- include "clickhouse-cluster.labels" . | nindent 4 }}
type: Opaque
stringData:
  ca.crt: {{ $ca.Cert | quote }}
  tls.crt: {{ $cert.Cert | quote }}
  tls.key: {{ $cert.Key | quote }}
{{- end }}
