apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ include "kblib.clusterName" . }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
spec:
  terminationPolicy: Delete
  clusterDef: hadoop-hdfs
  topology: {{ .Values.topology }}
  componentSpecs:
    {{- if eq .Values.topology "ha-cluster"  }}
    - name: zookeeper
      componentDef: zookeeper
      replicas: {{ .Values.replicas.zookeeper }}
      resources:
        requests:
          cpu: { { .Values.resources.zookeeper.requests.cpu | quote } }
          memory: { { .Values.resources.zookeeper.requests.memory } }
        limits:
          cpu: { { .Values.resources.zookeeper.limits.cpu | quote } }
          memory: { { .Values.resources.zookeeper.limits.memory } }
    {{- end }}
    - name: hadoop-core
      componentDef: hadoop-core
      {{- if eq .Values.topology "ha-ref-zk-cluster"  }}
      serviceRefs:
        - name: hadoopZookeeper
          namespace: {{ .Values.serviceRefs.hadoopZookeeper.namespace }}
          clusterServiceSelector:
            cluster: {{ .Values.serviceRefs.hadoopZookeeper.clusterServiceSelector.cluster }}
            service:
              component: {{ .Values.serviceRefs.hadoopZookeeper.clusterServiceSelector.service.component }}
              service: {{ .Values.serviceRefs.hadoopZookeeper.clusterServiceSelector.service.service }}
              port: {{ .Values.serviceRefs.hadoopZookeeper.clusterServiceSelector.service.port }}
      {{- end }}
      replicas: {{ .Values.replicas.core }}
      resources:
        requests:
          cpu: {{ .Values.resources.core.requests.cpu | quote }}
          memory: {{ .Values.resources.core.requests.memory }}
        limits:
          cpu: {{ .Values.resources.core.limits.cpu | quote }}
          memory: {{ .Values.resources.core.limits.memory }}
    - name: journalnode
      componentDef: hdfs-journalnode
      replicas: {{ .Values.replicas.journalnode }}
      resources:
        requests:
          cpu: {{ .Values.resources.journalnode.requests.cpu | quote }}
          memory: {{ .Values.resources.journalnode.requests.memory }}
        limits:
          cpu: {{ .Values.resources.journalnode.limits.cpu | quote  }}
          memory: {{ .Values.resources.journalnode.limits.memory }}
      volumes:
        - name: hadoop-core-config
          configMap:
            name: {{ include "kblib.clusterName" . }}-hadoop-core-config
      volumeClaimTemplates:
        - name: edits-dir
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: {{ .Values.storage.journalnode }}
    - name: namenode
      componentDef: hdfs-namenode
      serviceRefs:
        - name: hadoopZookeeper
          namespace: {{ .Values.serviceRefs.hadoopZookeeper.namespace }}
          clusterServiceSelector:
            cluster: {{ .Values.serviceRefs.hadoopZookeeper.clusterServiceSelector.cluster }}
            service:
              component: {{ .Values.serviceRefs.hadoopZookeeper.clusterServiceSelector.service.component }}
              service: {{ .Values.serviceRefs.hadoopZookeeper.clusterServiceSelector.service.service }}
              port: {{ .Values.serviceRefs.hadoopZookeeper.clusterServiceSelector.service.port }}
      replicas: {{ .Values.replicas.namenode }}
      resources:
        requests:
          cpu: {{ .Values.resources.namenode.requests.cpu | quote }}
          memory: {{ .Values.resources.namenode.requests.memory }}
        limits:
          cpu: {{ .Values.resources.namenode.limits.cpu | quote }}
          memory: {{ .Values.resources.namenode.limits.memory }}
      volumes:
        - name: hadoop-core-config
          configMap:
            name: {{ include "kblib.clusterName" . }}-hadoop-core-config
      volumeClaimTemplates:
        - name: metadata-dir
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: {{ .Values.storage.namenode }}
    - name: datanode
      componentDef: hdfs-datanode
      replicas: {{ .Values.replicas.datanode }}
      resources:
        requests:
          cpu: {{ .Values.resources.datanode.requests.cpu | quote }}
          memory: {{ .Values.resources.datanode.requests.memory }}
        limits:
          cpu: {{ .Values.resources.datanode.limits.cpu | quote }}
          memory: {{ .Values.resources.datanode.limits.memory }}
      volumes:
        - name: hadoop-core-config
          configMap:
            name: {{ include "kblib.clusterName" . }}-hadoop-core-config
      volumeClaimTemplates:
      - name: hdfs-data-0
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: {{ .Values.storage.datanode }}
