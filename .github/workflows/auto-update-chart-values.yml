name: Auto Update Chart Values

on:
  push:
    paths:
      - "addons/**"
      - "addons-cluster/**"
    branches:
      - 'main'
      - 'release-*'

env:
  GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

jobs:
  get-update-chart-dir:
    runs-on: ubuntu-latest
    outputs:
      update-chart: ${{ steps.get_update_chart_dir.outputs.update-chart }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get Update Chart Dir
        id: get_update_chart_dir
        run: |
          UPDATE_CHART=""
          COMMIT_BODY="$(git show -s --format=%B HEAD)"
          if [[ "${COMMIT_BODY}" != *"auto update values commit info"* ]]; then
              change_files=$(git diff --name-only HEAD^ HEAD)
              addons_change_files=$(echo "$change_files" | (grep -E '^addons/|^addons-cluster/' || true))
              update_chart_dirs=$(echo "$addons_change_files" | cut -d'/' -f1,2 | sort -u)
              UPDATE_CHART=""
              for update_chart in $(echo "$update_chart_dirs"); do
                  if [[ -z "$UPDATE_CHART" ]]; then
                      UPDATE_CHART="${update_chart}"
                  else
                      UPDATE_CHART="${UPDATE_CHART}|${update_chart}"
                  fi
              done
              echo "UPDATE_CHART:${UPDATE_CHART}"
          fi
          echo update-chart="$UPDATE_CHART" >> $GITHUB_OUTPUT

  auto-update-chart-values:
    needs: [ get-update-chart-dir ]
    if: ${{ needs.get-update-chart-dir.outputs.update-chart }}
    uses: apecloud/apecloud-cd/.github/workflows/update-chart-values.yml@v0.1.83
    with:
      TYPE: "commit"
      UPDATE_CHART: "${{ needs.get-update-chart-dir.outputs.update-chart }}"
      REF_NAME: "${{ github.sha }}"
      APECD_REF: "v0.1.83"
    secrets: inherit
    